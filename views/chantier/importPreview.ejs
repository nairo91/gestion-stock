<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Aperçu import Excel</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <!-- DataTables CSS (thème minimal, on garde notre charte violette) -->
  <link rel="stylesheet" href="/vendor/datatables-dt/css/jquery.dataTables.min.css">
  <style>
    :root{
      --violet-900:#160e33;
      --violet-800:#1b133a;
      --violet-700:#261c55;
      --violet-600:#352373;
      --violet-500:#5c41c5;
      --violet-400:#7b62e3;
      --violet-300:#9a85f0;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.08);
      --text: #eef0ff;
      --muted: #cfd3ff;
      --ok:#1cc88a;
      --warn:#f6c23e;
      --err:#e74a3b;
      --ignored:#858796;
      --duplicate:#6c757d; /* gris distinct (peut être ajusté) */
      --create:#5c41c5; /* violet brand */
      --update:#36b9cc;
      --unchanged:#858796;
    }
    body{
      color:var(--text);
      background: linear-gradient(180deg, var(--violet-900) 0%, var(--violet-700) 45%, var(--violet-600) 100%);
      min-height:100vh;
    }
    h2{ color:#fff; }
    .summary-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      padding:16px;
      backdrop-filter: blur(4px);
    }
    .badge{ border-radius:999px; padding:.4rem .7rem; font-weight:600; }
    .badge-ok{ background:var(--ok); }
    .badge-warn{ background:var(--warn); color:#1b1b1b; }
    .badge-error{ background:var(--err); }
    .badge-ignored{ background:var(--ignored); }
    .badge-duplicate{ background:var(--duplicate); }
    .badge-create{ background:var(--create); }
    .badge-update{ background:var(--update); }
    .badge-unchanged{ background:var(--unchanged); }
    .table-responsive{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:12px;
      overflow:hidden;
    }
    table.table{
      color:var(--text);
    }
    .table thead th{
      background: rgba(255,255,255,0.06);
      color:var(--muted);
      border-bottom:1px solid var(--card-border);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table td, .table th{
      border-color: var(--card-border);
    }
    .btn-brand{
      background: var(--violet-500);
      border-color: var(--violet-500);
      color:#fff;
      font-weight:600;
    }
    .btn-brand:hover{
      background: var(--violet-400);
      border-color: var(--violet-400);
      color:#fff;
    }
    .alert-soft{
      background: rgba(246,194,62,.15);
      border:1px solid rgba(246,194,62,.35);
      color:#ffe9a8;
      border-radius:10px;
      padding:.75rem 1rem;
    }
    /* Barre d’outils (recherche + filtres) */
    .toolbar{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
      gap:12px;
    }
    .toolbar .form-label{ color: var(--muted); font-weight:600; }
    .toolbar .form-select,.toolbar .form-control{
      background: rgba(255,255,255,.06);
      border-color: var(--card-border);
      color: var(--text);
    }
    .toolbar .form-control::placeholder {
      color: var(--muted);
    }
    /* lisibilité des options dans les menus déroulants */
    .toolbar .form-select option {
      background: rgba(32,32,44,0.92);
      color: #fff;
    }
    .toolbar .form-select:focus,.toolbar .form-control:focus{
      box-shadow: 0 0 0 .25rem rgba(124,98,227,.25);
      border-color: var(--violet-400);
    }

    /* ---- Thème sombre pour le select DataTables (nombre de lignes) ---- */
    div.dataTables_length select {
      background: rgba(32,32,44,0.92);
      color: #fff;
      border: 1px solid var(--card-border);
      border-radius: 8px;
    }
    div.dataTables_length select option {
      background-color: #1b133a;
      color: #fff;
    }
  </style>
</head>
<body class="container mt-4">
  <h2>Aperçu avant import – <%= chantier ? chantier.nom : '' %></h2>

  <div class="summary-card mb-3">
    <div class="d-flex flex-wrap gap-3">
      <span class="badge badge-ok">OK: <%= stats.ok %></span>
      <span class="badge badge-warn">AVERT.: <%= stats.warn %></span>
      <span class="badge badge-error">ERREURS: <%= stats.error %></span>
      <span class="badge badge-ignored">IGNORÉES: <%= stats.ignored %></span>
      <span class="badge badge-duplicate">Doublons fichier: <%= stats.doublonsFichier %></span>
      <span class="badge badge-unchanged">Existants chantier: <%= stats.existantsDb %></span>
      <span class="badge badge-unchanged">Existants inchangés: <%= stats.existantsInchanges %></span>
      <span class="badge badge-update">Existants en update: <%= stats.existantsUpdates %></span>
      <span class="badge badge-ok">Importables: <%= stats.importable %></span>
      <span class="badge badge-create">Créations: <%= stats.create %></span>
      <span class="badge badge-update">Mises à jour: <%= stats.update %></span>
      <span class="badge badge-unchanged">Aucun changement: <%= stats.unchanged %></span>
      <span class="ms-auto">Total: <strong><%= stats.total %></strong></span>
    </div>
  </div>

  <div class="mb-3">
    <% if (stats.error > 0) { %>
      <div class="alert-soft mb-2">
        ⚠️ <strong><%= stats.error %></strong> ligne(s) en erreur seront ignorées pendant l’import (elles ne seront pas créées).
      </div>
    <% } %>
    <form action="/chantier/import-excel/confirm" method="POST" class="d-inline">
      <button type="submit" class="btn btn-brand">
        ✅ Importer définitivement
      </button>
    </form>
    <a href="/chantier" class="btn btn-outline-light">Annuler</a>
  </div>

  <!-- Barre d’outils : recherche globale & filtres colonnes -->
  <div class="toolbar d-flex flex-wrap align-items-end">
    <div class="me-3 flex-grow-1" style="min-width:260px">
      <label for="global-search" class="form-label">Recherche</label>
      <input id="global-search" type="search" class="form-control" placeholder="Rechercher dans le tableau (catégorie, désignation, fournisseur, ...)">
    </div>
    <div class="me-3" style="min-width:180px">
      <label for="filtre-etat" class="form-label">Filtrer par État</label>
      <select id="filtre-etat" class="form-select">
        <option value="">Tous</option>
        <option value="OK">OK</option>
        <option value="Avert.">Avert.</option>
        <option value="Doublon">Doublon</option>
        <option value="Erreur">Erreur</option>
        <option value="Ignorée">Ignorée</option>
      </select>
    </div>
    <div class="" style="min-width:180px">
      <label for="filtre-op" class="form-label">Filtrer par Opération</label>
      <select id="filtre-op" class="form-select">
        <option value="">Toutes</option>
        <option value="Create">Create</option>
        <option value="Update">Update</option>
        <option value="Aucun changement">Aucun changement</option>
        <option value="Ignorée (doublon)">Ignorée (doublon)</option>
      </select>
    </div>
    <div class="" style="min-width:180px">
      <label for="filtre-exists" class="form-label">Existant chantier</label>
      <select id="filtre-exists" class="form-select">
        <option value="">Tous</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>
    </div>
  </div>

  <div class="toolbar d-flex flex-wrap align-items-center">
    <div class="me-3">
      <div class="form-label mb-2">Colonnes visibles</div>
      <div class="d-flex flex-wrap gap-3">
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="3">
          Détails
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="6" checked>
          Fournisseur
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="7" checked>
          Qte 1
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="8">
          Date 1
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="9" checked>
          Qte 2
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="10">
          Date 2
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="11" checked>
          Qte 3
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="12">
          Date 3
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="13" checked>
          Qte 4
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="14">
          Date 4
        </label>
        <label class="form-check-label d-flex align-items-center gap-2">
          <input class="form-check-input toggle-col" type="checkbox" data-col="15" checked>
          Raison
        </label>
      </div>
    </div>
    <button type="button" class="btn btn-outline-light ms-auto" id="cols-reset">Réinitialiser colonnes</button>
  </div>

  <div class="table-responsive">
    <table id="previewTable" class="table table-bordered table-sm table-sticky">
      <thead>
        <tr>
          <th style="width:90px">Ligne Excel</th>
          <th style="width:100px">État</th>
          <th style="width:100px">Opération</th>
          <th>Détails (avant → après)</th>
          <th>Catégorie</th>
          <th>Désignation</th>
          <th>Fournisseur</th>
          <th>Qte 1</th>
          <th>Date 1</th>
          <th>Qte 2</th>
          <th>Date 2</th>
          <th>Qte 3</th>
          <th>Date 3</th>
          <th>Qte 4</th>
          <th>Date 4</th>
          <th>Raison</th>
        </tr>
      </thead>
      <tbody>
        <% (rows || []).forEach(function(r){
             const isDuplicate = (r.status === 'duplicate') || (r.operation === 'skipped');
             const etatText = isDuplicate
               ? 'Doublon'
               : (r.status === 'ok')
                 ? 'OK'
                 : (r.status === 'warn')
                   ? 'Avert.'
                   : (r.status === 'ignored')
                     ? 'Ignorée'
                     : 'Erreur';
             const opText = (r.operation === 'update')
               ? 'Update'
               : (r.operation === 'unchanged')
                 ? 'Aucun changement'
                 : (r.operation === 'skipped')
                   ? 'Ignorée (doublon)'
                   : 'Create';
        %>
          <tr data-etat="<%= etatText %>" data-op="<%= opText %>" data-exists="<%= r.existsInDb ? 'Oui' : 'Non' %>">
            <td><%= r.excelRow != null ? r.excelRow : '' %></td>
            <td>
              <% if (isDuplicate) { %>
                <span class="badge badge-duplicate">Doublon</span>
              <% } else if (r.status === 'ok') { %>
                <span class="badge badge-ok">OK</span>
              <% } else if (r.status === 'warn') { %>
                <span class="badge badge-warn">Avert.</span>
              <% } else if (r.status === 'ignored') { %>
                <span class="badge badge-ignored">Ignorée</span>
              <% } else { %>
                <span class="badge badge-error">Erreur</span>
              <% } %>
            </td>
            <td>
              <% if (r.operation === 'update') { %>
                <span class="badge badge-update">Update</span>
              <% } else if (r.operation === 'unchanged') { %>
                <span class="badge badge-unchanged">Aucun changement</span>
              <% } else if (r.operation === 'skipped') { %>
                <span class="badge badge-duplicate">Ignorée (doublon)</span>
              <% } else { %>
                <span class="badge badge-create">Create</span>
              <% } %>
            </td>
            <td><%= r.diffDetails || '' %></td>
            <td><%= r.categorie %></td>
            <td><%= r.designation %></td>
            <td><%= r.fournisseur || '' %></td>
            <td><%= (r.qtePrevue1 != null) ? r.qtePrevue1 : '' %></td>
            <td><%= r.datePrevue1 ? new Date(r.datePrevue1).toLocaleDateString('fr-FR') : '' %></td>
            <td><%= (r.qtePrevue2 != null) ? r.qtePrevue2 : '' %></td>
            <td><%= r.datePrevue2 ? new Date(r.datePrevue2).toLocaleDateString('fr-FR') : '' %></td>
            <td><%= (r.qtePrevue3 != null) ? r.qtePrevue3 : '' %></td>
            <td><%= r.datePrevue3 ? new Date(r.datePrevue3).toLocaleDateString('fr-FR') : '' %></td>
            <td><%= (r.qtePrevue4 != null) ? r.qtePrevue4 : '' %></td>
            <td><%= r.datePrevue4 ? new Date(r.datePrevue4).toLocaleDateString('fr-FR') : '' %></td>
            <td>
              <% if (r.existsInDb) { %>
                <span class="badge badge-unchanged">Existant chantier</span>
              <% } %>
              <%= r.reason || '' %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- jQuery + DataTables (local, CSP-friendly) -->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/datatables/jquery.dataTables.min.js"></script>
  <script>
    (function () {
      // --- 1) Filtre custom AVANT l'initialisation du DataTable
      // Lit le texte des cellules directement depuis le DOM pour être 100% fiable.
      function normalize(s){ return (s || '').replace(/\u00A0/g,' ').trim(); } // enlève NBSP & espaces
      const previewFilter = function (settings, data, dataIndex) {
        // Ne filtre que le tableau #previewTable
        if (!settings.nTable || settings.nTable.id !== 'previewTable') return true;
        const $tr = $(settings.aoData[dataIndex].nTr);
        // 1: État, 2: Opération
        const etatRow = normalize($tr.find('td:eq(1)').text());
        const opRow   = normalize($tr.find('td:eq(2)').text());
        const etatSel = normalize($('#filtre-etat').val());
        const opSel   = normalize($('#filtre-op').val());
        const existSel = normalize($('#filtre-exists').val());
        const existRow = normalize($tr.data('exists'));
        // "contains" au lieu d'égalité stricte -> plus tolérant aux espaces/retours/labels
        const etatOK = !etatSel || etatRow.indexOf(etatSel) !== -1;
        const opOK   = !opSel   || opRow.indexOf(opSel)   !== -1;
        const existOK = !existSel || existRow === existSel;
        return etatOK && opOK && existOK;
      };
      // Évite les doublons si on re-rend la page
      if (window.__previewFilter) {
        const i = $.fn.dataTable.ext.search.indexOf(window.__previewFilter);
        if (i !== -1) $.fn.dataTable.ext.search.splice(i, 1);
      }
      window.__previewFilter = previewFilter;
      $.fn.dataTable.ext.search.push(window.__previewFilter);

      // --- 2) Initialisation du DataTable
      const table = $('#previewTable').DataTable({
        paging: true,
        pageLength: 25,
        lengthMenu: [[25, 50, 100, -1], [25, 50, 100, 'Tous']],
        order: [[2, 'asc'], [4, 'asc']], // Opération, puis LOT
        // Pas de langue distante pour respecter la CSP (optionnel)
        dom: 'lrtip'
      });

      // --- 3) Colonnes visibles (persistées par chantier)
      const chantierIdOuNom = <%- JSON.stringify(chantier && (chantier.id || chantier.nom) ? (chantier.id || chantier.nom) : 'unknown') %>;
      const STORAGE_KEY = `importPreviewCols::chantier=${chantierIdOuNom}`;
      const $toggleCols = $('.toggle-col');

      function saveColumnsState() {
        const state = {};
        $toggleCols.each(function () {
          const colIndex = Number(this.dataset.col);
          state[colIndex] = $(this).is(':checked');
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function applyColumnsState() {
        let state = null;
        try {
          state = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
        } catch (error) {
          state = null;
        }
        $toggleCols.each(function () {
          const $checkbox = $(this);
          const colIndex = Number(this.dataset.col);
          const defaultChecked = this.defaultChecked;
          const shouldShow = state && Object.prototype.hasOwnProperty.call(state, colIndex)
            ? state[colIndex]
            : defaultChecked;
          $checkbox.prop('checked', shouldShow);
          table.column(colIndex).visible(shouldShow, false);
        });
        table.columns.adjust().draw(false);
      }

      $toggleCols.on('change', function () {
        const colIndex = Number(this.dataset.col);
        const shouldShow = $(this).is(':checked');
        table.column(colIndex).visible(shouldShow);
        table.columns.adjust().draw(false);
        saveColumnsState();
      });

      $('#cols-reset').on('click', function () {
        localStorage.removeItem(STORAGE_KEY);
        $toggleCols.each(function () {
          const colIndex = Number(this.dataset.col);
          const shouldShow = this.defaultChecked;
          $(this).prop('checked', shouldShow);
          table.column(colIndex).visible(shouldShow, false);
        });
        table.columns.adjust().draw(false);
      });

      applyColumnsState();

      // --- 4) Recherche globale
      $('#global-search').on('input', function () {
        table.search(this.value).draw();
      });

      // --- 5) Filtres État / Opération via le filtre custom
      $('#filtre-etat').on('change', function () {
        table.draw();
      });
      $('#filtre-op').on('change', function () {
        table.draw();
      });
      $('#filtre-exists').on('change', function () {
        table.draw();
      });
      // Applique l'état initial (utile si un filtre est pré-sélectionné)
      table.draw();
    })();
  </script>
</body>
</html>
