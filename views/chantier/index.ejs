<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Stock Chantier</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">

  <style>
    @import url('https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.17/index.min.css');

    :root {
      --violet-dark: #0f021f;
      --violet-mid: #3b0a6a;
      --violet-light: #7b3ef3;
      --violet-accent: #a978ff;
      --card-bg: rgba(17, 6, 32, 0.72);
      --text-primary: #f7f4ff;
      --text-muted: rgba(247, 244, 255, 0.7);
      --navbar-h: 64px;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, rgba(123, 62, 243, 0.35), transparent 45%),
                  radial-gradient(circle at bottom right, rgba(59, 10, 106, 0.6), transparent 55%),
                  linear-gradient(135deg, #080111 0%, #1a0533 38%, #2d0a52 100%);
      color: var(--text-primary);
      font-family: 'Inter', 'Segoe UI', sans-serif;
      backdrop-filter: blur(8px);
      margin: 0;
      padding-top: var(--navbar-h);
    }

    .navbar {
      background: linear-gradient(120deg, rgba(15, 2, 31, 0.9), rgba(59, 10, 106, 0.9));
      border-bottom: 1px solid rgba(169, 120, 255, 0.25);
      backdrop-filter: blur(12px);
    }

    /* === conteneur plus large (PC) === */
    @media (min-width: 1400px) {
      .container,
      .container-lg,
      .container-xl,
      .container-xxl {
        max-width: 1800px;
      }
    }

    .navbar.fixed-top,
    .navbar.sticky-top {
      z-index: 1030;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.05rem;
      color: #fff !important;
    }

    .navbar-brand img {
      height: 42px;
      width: auto;
    }

    #toggleMode {
      border-radius: 999px;
      border-color: rgba(255, 255, 255, 0.25);
      color: #fff;
    }

    #toggleMode:hover {
      background-color: rgba(169, 120, 255, 0.2);
      border-color: rgba(169, 120, 255, 0.5);
    }

    .content-wrapper {
      margin-top: 2.5rem;
      margin-bottom: 3rem;
    }

    .page-spinner {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(14, 13, 20, 0.35);
      backdrop-filter: blur(2px);
      z-index: 9999;
    }

    .page-spinner.show {
      display: flex;
    }

    .page-spinner .dot {
      width: 10px;
      height: 10px;
      margin: 0 5px;
      border-radius: 50%;
      background: #7c3aed;
      animation: b 0.9s infinite alternate;
    }

    .page-spinner .dot:nth-child(2) {
      animation-delay: .15s;
    }

    .page-spinner .dot:nth-child(3) {
      animation-delay: .30s;
    }

    @keyframes b {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-8px);
      }
    }

    .page-header {
      background: linear-gradient(135deg, rgba(123, 62, 243, 0.25), rgba(15, 2, 31, 0.65));
      border: 1px solid rgba(169, 120, 255, 0.28);
      border-radius: 18px;
      padding: 2.25rem;
      box-shadow: 0 18px 45px rgba(7, 1, 20, 0.45);
      color: #fff;
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      font-weight: 700;
    }

    .page-header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 1rem;
    }

    .action-buttons .btn {
      border-radius: 12px;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      box-shadow: 0 12px 30px rgba(11, 2, 25, 0.35);
      border: none;
    }

    .action-buttons .btn-success,
    .action-buttons .btn-info {
      background: linear-gradient(135deg, #7b3ef3, #9a4fff);
    }

    .action-buttons .btn-warning {
      background: linear-gradient(135deg, #ffa928, #ff7e2f);
    }

    .action-buttons .btn-secondary,
    .action-buttons .btn-outline-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .action-buttons .btn-danger {
      background: linear-gradient(135deg, #ff5c7a, #ff3564);
    }

    .action-buttons .btn-primary {
      background: linear-gradient(135deg, #4f32ff, #7f56ff);
    }

    .glass-card {
      background: var(--card-bg);
      border-radius: 22px;
      padding: 2rem;
      border: 1px solid rgba(169, 120, 255, 0.2);
      box-shadow: 0 18px 40px rgba(8, 2, 20, 0.6);
      backdrop-filter: blur(14px);
    }

    form.glass-card {
      margin-top: 2.5rem;
    }

    label.form-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06rem;
    }

    .form-control,
    .form-select {
      background: rgba(15, 2, 31, 0.55);
      border: 1px solid rgba(169, 120, 255, 0.25);
      color: #fff;
      border-radius: 12px;
      padding: 0.65rem 1rem;
    }

    /* Lisibilit√© des champs libres de filtrage */
    #recherche {
      color: #fff;
    }

    #recherche::placeholder {
      color: rgba(255, 255, 255, 0.65);
    }

    .form-select {
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='10' viewBox='0 0 16 10'%3E%3Cpath fill='%23FFFFFF' d='M1.41.59 8 7.17 14.59.59 16 2l-8 8-8-8L1.41.59Z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.95rem center;
      background-size: 18px auto;
      padding-right: 2.5rem;
    }

    .form-select option {
      background: rgba(15, 2, 31, 0.92);
      color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(169, 120, 255, 0.55);
      box-shadow: 0 0 0 0.15rem rgba(123, 62, 243, 0.25);
      background: rgba(15, 2, 31, 0.75);
    }

    .filters-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-top: 1.5rem;
    }

    .filters-actions .btn {
      border-radius: 12px;
      padding: 0.55rem 1.4rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05rem;
    }

    .filters-actions .btn:focus,
    .filters-actions .btn:active,
    .filters-actions .btn.active,
    .filters-actions .btn:focus-visible {
      color: #fff;
    }

    .column-visibility-card {
      margin-top: 1.5rem;
    }

    .column-visibility-header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .column-visibility-header .subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .column-visibility-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1.5rem;
      margin-top: 1.25rem;
    }

    .column-visibility-options .form-check {
      min-width: 180px;
      margin: 0;
    }

    .column-visibility-options .form-check-input {
      cursor: pointer;
    }

    .column-visibility-options .form-check-label {
      cursor: pointer;
    }

    .table-stock .hidden-column {
      display: none !important;
    }

    @media (max-width: 768px) {
      .column-visibility-options {
        gap: 0.5rem 1rem;
      }

      .column-visibility-options .form-check {
        min-width: 140px;
      }
    }

    .table-wrapper {
      margin-top: 2.5rem;
      background: rgba(14, 4, 28, 0.78);
      border-radius: 20px;
      border: 1px solid rgba(169, 120, 255, 0.18);
      box-shadow: 0 22px 50px rgba(5, 0, 16, 0.65);
      overflow: hidden;
    }

    /* √âtendre la zone tableau sur mobile/tablette pour profiter de toute la largeur utile */
    @media (max-width: 1200px) {
      .content-wrapper.container {
        max-width: 100%;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .table-wrapper {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
      }

      .stock-table-wrap {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
    }

    .table-responsive {
      border-radius: 20px;
    }

    .table-materiel {
      margin-bottom: 0;
      color: var(--text-primary);
    }

    /* --- STOCK TABLE: force one-row, enable horizontal scroll --- */
    .stock-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-stock {
      border-collapse: separate;
      table-layout: auto;
      width: 100%;
      min-width: 1400px;
    }

    .table-stock th,
    .table-stock td {
      vertical-align: middle;
      white-space: nowrap;
      line-height: 1.25;
    }

    /* Autoriser les retours √† la ligne sur les colonnes textuelles pour √©viter l'ellipsis */
    .table-stock .col-designation,
    .table-stock .col-reference,
    .table-stock .col-marque,
    .table-stock .col-categorie,
    .table-stock .col-description,
    .table-stock .col-fournisseur,
    .table-stock .col-emplacement,
    .table-stock .col-rack,
    .table-stock .col-bon-livraison {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
      hyphens: auto;
      line-height: 1.35;
    }

    /* Alternance l√©g√®re sur les lignes pour plus de contraste */
    .table-stock tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.04);
    }
    .table-stock tbody tr:hover {
      background-color: rgba(123, 62, 243, 0.15) !important;
    }

    /* Bandeau des ent√™tes plus marqu√© */
    .table-stock thead th {
      background: linear-gradient(135deg, #4f32ff, #7f56ff);
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05rem;
    }

    .table-stock th:nth-child(3),
    .table-stock td:nth-child(3) {
      max-width: 280px;
      overflow: visible;
      text-overflow: clip;
    }

    body:not(.compact-mobile) .table-stock th:nth-child(4),
    body:not(.compact-mobile) .table-stock td:nth-child(4) {
      width: 110px;
    }

    body:not(.compact-mobile) .table-stock th:nth-child(5),
    body:not(.compact-mobile) .table-stock td:nth-child(5),
    body:not(.compact-mobile) .table-stock th:nth-child(6),
    body:not(.compact-mobile) .table-stock td:nth-child(6) {
      width: 140px;
    }

    @media (max-width: 1200px) {
      .table-stock th:last-child,
      .table-stock td:last-child {
        position: sticky;
        right: 0;
        background: rgba(22, 18, 37, .92);
        backdrop-filter: blur(2px);
        z-index: 2;
      }
    }

    .table-stock .btn {
      white-space: nowrap;
    }

    .table-stock th.col-actions,
    .table-stock td.col-actions {
      position: relative;
      overflow: visible;
      white-space: normal;
      z-index: 1;
    }

    .table-stock td .btn-group,
    .table-stock td .btn-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .table-stock .cell-photo img {
      display: block;
      max-width: 90px;
      height: auto;
      margin: 0 auto;
    }

    /* Tablette : autoriser les retours √† la ligne et une largeur minimale plus souple */
    @media (max-width: 1100px) {
      .table-stock {
        min-width: 1100px;
      }

      .table-stock th,
      .table-stock td {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: break-word;
        hyphens: auto;
        line-height: 1.35;
      }

      .table-stock th:nth-child(3),
      .table-stock td:nth-child(3) {
        max-width: none;
      }

      .table-stock .col-actions {
        white-space: normal;
      }

      .table-stock td .btn-group,
      .table-stock td .btn-wrap {
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      table.table-stock,
      .table-stock th,
      .table-stock td {
        display: table-cell !important;
      }
      .table-stock .col-designation {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        word-break: break-word;
        hyphens: auto;
        min-width: 220px !important;
      }
      .table-stock .col-emplacement,
      .table-stock .col-rack {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        word-break: break-word;
        hyphens: auto;
        min-width: 140px !important;
      }
      .table-stock .col-actions {
        overflow: visible !important;
        white-space: normal !important;
      }
      .table-stock {
        min-width: 1350px;
      }
    }

    /* === MODE COMPACT+ (mobile : tout tenir sans scroller) === */
    body.compact-mobile .table-stock {
      min-width: 100% !important;
      width: 100%;
      table-layout: fixed;
      font-size: 12px;
    }

    body.compact-mobile .table-stock th,
    body.compact-mobile .table-stock td {
      padding: 6px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.25;
    }

    body.compact-mobile .table-stock .cell-photo img {
      max-width: 44px;
    }

    body.compact-mobile .table-materiel thead th {
      font-size: 11px;
      padding: 8px 6px;
    }

    body.compact-mobile .table-stock th:nth-child(3),
    body.compact-mobile .table-stock td:nth-child(3) {
      min-width: 160px;
    }

    body.compact-mobile .table-stock .col-designation,
    body.compact-mobile .table-stock .col-reference,
    body.compact-mobile .table-stock .col-marque,
    body.compact-mobile .table-stock .col-categorie,
    body.compact-mobile .table-stock .col-description,
    body.compact-mobile .table-stock .col-fournisseur,
    body.compact-mobile .table-stock .col-emplacement,
    body.compact-mobile .table-stock .col-rack,
    body.compact-mobile .table-stock .col-bon-livraison {
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      word-break: break-word;
      hyphens: auto;
    }
    body.compact-mobile .table-stock .col-actions {
      overflow: visible !important;
      white-space: normal !important;
    }
    body.compact-mobile .table-stock .col-emplacement {
      min-width: 130px;
    }
    body.compact-mobile .table-stock .col-rack {
      min-width: 90px;
    }

    body.compact-mobile .table-stock th:nth-child(5),
    body.compact-mobile .table-stock td:nth-child(5) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock th:nth-child(6),
    body.compact-mobile .table-stock td:nth-child(6) {
      min-width: 80px;
    }

    body.compact-mobile .table-stock th:nth-child(7),
    body.compact-mobile .table-stock td:nth-child(7) {
      min-width: 100px;
    }

    body.compact-mobile .table-stock th:nth-child(8),
    body.compact-mobile .table-stock td:nth-child(8) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock th:nth-child(9),
    body.compact-mobile .table-stock td:nth-child(9) {
      min-width: 80px;
    }

    body.compact-mobile .table-stock th:nth-child(10),
    body.compact-mobile .table-stock td:nth-child(10),
    body.compact-mobile .table-stock th:nth-child(11),
    body.compact-mobile .table-stock td:nth-child(11),
    body.compact-mobile .table-stock th:nth-child(12),
    body.compact-mobile .table-stock td:nth-child(12),
    body.compact-mobile .table-stock th:nth-child(13),
    body.compact-mobile .table-stock td:nth-child(13) {
      min-width: 48px;
      text-align: center;
    }

    body.compact-mobile .table-stock th:nth-child(14),
    body.compact-mobile .table-stock td:nth-child(14),
    body.compact-mobile .table-stock th:nth-child(15),
    body.compact-mobile .table-stock td:nth-child(15) {
      min-width: 64px;
      text-align: center;
    }

    body.compact-mobile .table-stock td .btn-group,
    body.compact-mobile .table-stock td .btn-wrap {
      gap: 4px;
    }

    body.compact-mobile .table-stock td .btn {
      padding: 4px 6px;
      font-size: 12px;
    }

    .table-materiel thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(135deg, rgba(79, 50, 255, 0.95), rgba(123, 62, 243, 0.85));
      border-bottom: none;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05rem;
      font-size: 0.75rem;
      padding: 0.95rem 0.75rem;
    }

    .table-materiel tbody tr {
      background: rgba(12, 2, 28, 0.55);
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .table-materiel tbody tr:hover {
      transform: translateY(-2px);
      background: rgba(123, 62, 243, 0.2);
    }

    .table-materiel tbody td {
      border-color: rgba(169, 120, 255, 0.15);
      vertical-align: middle;
    }

    .table-materiel .btn {
      border-radius: 10px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04rem;
    }

    .table-materiel img {
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(4, 0, 12, 0.55);
      border: 1px solid rgba(169, 120, 255, 0.2);
    }

    .modal-content {
      background: linear-gradient(145deg, rgba(10, 3, 24, 0.95), rgba(35, 9, 63, 0.92));
      color: var(--text-primary);
      border: 1px solid rgba(169, 120, 255, 0.3);
      box-shadow: 0 16px 40px rgba(8, 1, 24, 0.65);
    }

    .modal-header {
      border-bottom-color: rgba(169, 120, 255, 0.25);
    }

    .modal-footer {
      border-top-color: rgba(169, 120, 255, 0.25);
    }

    .modal-content .form-control {
      background: rgba(12, 8, 32, 0.92);
      border: 1px solid rgba(169, 120, 255, 0.35);
      color: var(--text-primary);
    }

    .modal-content .form-control:focus {
      border-color: rgba(199, 172, 255, 0.7);
      box-shadow: 0 0 0 0.25rem rgba(123, 106, 255, 0.25);
      background: rgba(18, 12, 48, 0.96);
      color: #ffffff;
    }

    .modal-content .form-control::placeholder {
      color: rgba(247, 244, 255, 0.65);
    }

    .transfer-btn {
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.18) !important;
      color: #fff !important;
    }

    .transfer-btn[data-action="entree"] {
      background: linear-gradient(135deg, rgba(68, 217, 159, 0.25), rgba(72, 149, 239, 0.35)) !important;
    }

    .transfer-btn[data-action="sortie"] {
      background: linear-gradient(135deg, rgba(255, 91, 122, 0.25), rgba(255, 126, 162, 0.32)) !important;
    }

    .badge.bg-danger {
      background: rgba(255, 99, 132, 0.25) !important;
      border: 1px solid rgba(255, 99, 132, 0.4);
    }

    .top-shortcuts {
      position: fixed;
      top: 6rem;
      right: 2.5rem;
      display: flex;
      gap: 0.75rem;
      z-index: 10;
    }

    .top-shortcuts button {
      border-radius: 999px;
      border: 1px solid rgba(169, 120, 255, 0.35);
      background: rgba(12, 2, 28, 0.65);
      color: var(--text-primary);
      padding: 0.55rem 1.2rem;
      font-weight: 600;
      box-shadow: 0 14px 32px rgba(8, 2, 22, 0.4);
    }

    .top-shortcuts button:hover {
      background: rgba(123, 62, 243, 0.35);
    }

    body.mode-sombre {
      background: #05010b;
      color: var(--text-primary);
    }

    body.mode-sombre .navbar {
      background: linear-gradient(120deg, rgba(5, 0, 12, 0.95), rgba(21, 2, 45, 0.95));
    }

    body.mode-sombre .table-materiel thead th {
      background: linear-gradient(135deg, rgba(21, 2, 45, 0.95), rgba(59, 10, 106, 0.95));
    }

    body.mode-sombre .form-select {
      background-color: rgba(8, 2, 20, 0.85) !important;
      border-color: rgba(169, 120, 255, 0.45) !important;
      background-image: url('/images/arrow-dark.png');
    }

    @media (max-width: 992px) {
      .page-header {
        padding: 1.8rem;
      }

      .page-header h1 {
        font-size: 2rem;
      }

      .top-shortcuts {
        position: static;
        margin-top: 1rem;
        justify-content: flex-start;
      }

      .content-wrapper {
        margin-top: 2.5rem;
      }
    }

    :root {
      --alert-critical: #ff4d4d;
      --alert-monitoring: #ffe5b4;
      --alert-resolved: #baf4d6;
    }

    .table-danger {
      background-color: #fdecea;
    }

    /* Alerte stock < 30% sur le tableau chantier */
    .table-stock tr.stock-low-alert {
      background-color: rgba(255, 77, 77, 0.18) !important;
      box-shadow: inset 4px 0 0 var(--alert-critical);
    }

    .table-stock tr.stock-low-alert > * {
      background-color: rgba(255, 77, 77, 0.18) !important;
    }

    .table-stock tr.stock-low-alert:hover,
    .table-stock tr.stock-low-alert:hover > * {
      background-color: rgba(255, 77, 77, 0.28) !important;
    }

    .col-quantite-actuelle {
      white-space: normal;
    }

    .qte-actuelle-value {
      font-weight: 700;
    }

    .qte-alert-details {
      margin-top: 0.35rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.35rem;
    }

    .badge-stock-low {
      background-color: var(--alert-critical);
      color: #fff;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      vertical-align: middle;
      display: inline-block;
    }

    .badge-stock-low-critique {
      background-color: var(--alert-critical);
      color: #fff;
    }

    .badge-stock-low-surveillance {
      background-color: var(--alert-monitoring);
      color: #3b1c00;
    }

    .badge-stock-low-regle {
      background-color: var(--alert-resolved);
      color: #02230f;
    }

    /* Renforcement visuel pour les lignes en stock faible (stock chantier) */
    .table-stock tr.table-danger {
      background-color: rgba(255, 77, 77, 0.2) !important;
      box-shadow: inset 4px 0 0 var(--alert-critical);
    }

    .table-stock tr.table-danger:hover {
      background-color: rgba(255, 77, 77, 0.3) !important;
    }

    .table-stock tr.alert-low-monitoring {
      background-color: rgba(255, 214, 153, 0.4) !important;
      box-shadow: inset 4px 0 0 var(--alert-monitoring);
    }

    .table-stock tr.alert-low-monitoring > * {
      background-color: rgba(255, 214, 153, 0.4) !important;
    }

    .table-stock tr.alert-low-monitoring:hover,
    .table-stock tr.alert-low-monitoring:hover > * {
      background-color: rgba(255, 214, 153, 0.5) !important;
    }

    .table-stock tr.alert-low-resolved {
      background-color: #fff !important;
      box-shadow: inset 4px 0 0 var(--alert-resolved);
    }

    .table-stock tr.alert-low-resolved > * {
      background-color: #fff !important;
    }

    .table-stock tr.alert-low-resolved:hover,
    .table-stock tr.alert-low-resolved:hover > * {
      background-color: #f7f7f7 !important;
    }

    .badge-alert-status {
      border-radius: 999px;
      padding: 0.2rem 0.65rem;
      font-weight: 700;
      font-size: 0.75rem;
    }

    .badge-alert-critique {
      background-color: var(--alert-critical);
      color: #fff;
    }

    .badge-alert-surveillance {
      background-color: rgba(255, 229, 180, 0.9);
      color: #3b1c00;
    }

    .badge-alert-regle {
      background-color: rgba(186, 244, 214, 0.9);
      color: #064023;
    }
  </style>
</head>
<body>
  <div id="pageSpinner" class="page-spinner" aria-hidden="true">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
    <span class="visually-hidden">Chargement‚Ä¶</span>
  </div>
  <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <img src="/images/logo.png" alt="Logo Entreprise">
        Stock Chantier
      </span>
      <div class="d-flex align-items-center gap-2">
        <button id="toggleCompact" class="btn btn-outline-secondary">Compact+</button>
        <button id="toggleMode" class="btn btn-outline-secondary">Mode sombre</button>
      </div>
    </div>
  </nav>

  <div class="top-shortcuts">
    <button onclick="location.href='https://receptionbr.onrender.com/selection.html'">Gestion T√¢ches</button>
    <button onclick="location.href='https://receptionbr.onrender.com/'">R√©ception</button>
  </div>

  <div class="container content-wrapper">
    <div class="page-header">
      <h1>Inventaire chantier</h1>
      <p>Pilotez vos stocks sur chantier avec une vue claire, √©l√©gante et professionnelle.</p>
    </div>

    <div class="action-buttons d-flex flex-wrap gap-2 mt-4">
  <%
    const chantierCourant = (chantiers || []).find(c => String(c.id) === String(chantierId)) || null;
  %>
  <% if (user && user.role === 'admin') { %>
  <!-- Bouton ici -->
   <!-- <a href="/chantier/ajouter" class="btn btn-primary">Ajouter une livraison chantier</a>-->
  <a href="/chantier/scanner" class="btn btn-primary">Scanner QR/Code-barres</a>
  <a
    href="/chantier/ajouterMateriel<%= chantierCourant ? `?chantierId=${encodeURIComponent(chantierCourant.id)}` : '' %>"
    class="btn btn-success"
  >
    Ajouter du mat√©riel dans <%= chantierCourant ? `chantier &laquo; ${chantierCourant.nom} &raquo;` : 'un chantier' %>
  </a>
  <!-- Supprime le bouton "Modifier" global ici -->
  <a href="/chantier/ajouter-chantier" class="btn btn-success">Cr√©er un nouveau chantier</a>
  <a href="#" id="btnHistoriqueChantier" class="btn btn-warning">Voir l'historique chantier</a>
  <a href="/emplacements" class="btn btn-info">G√©rer les emplacements</a>

  <%
    const exportParams = [];
    const pushParam = (key, value) => {
      if (value !== undefined && value !== null && value !== '') {
        exportParams.push(`${key}=${encodeURIComponent(value)}`);
      }
    };
    pushParam('chantierId', chantierId);
    pushParam('categorie', categorie);
    pushParam('emplacement', emplacement);
    pushParam('fournisseur', fournisseur);
    pushParam('marque', marque);
    pushParam('triNom', triNom);
    pushParam('triAjout', triAjout);
    pushParam('triModification', triModification);
    pushParam('recherche', recherche);
    const exportQuery = exportParams.length ? `?${exportParams.join('&')}` : '';
  %>

  <a href="/chantier/export-pdf<%= exportQuery %>" class="btn btn-danger mb-3">üìÑ Exporter en PDF</a>
  <a href="/chantier/export-excel<%= exportQuery %>" class="btn btn-primary mb-3">üìä Exporter en Excel</a>

  <!-- Bouton d'importation Excel pour pr√©remplir le stock d'un chantier -->
  <a
    href="/chantier/import-excel<%= chantierCourant ? `?chantierId=${encodeURIComponent(chantierCourant.id)}` : '' %>"
    class="btn btn-info mb-3"
  >üì• Importer via Excel</a>

  <% if (typeof isAdmin !== 'undefined' && isAdmin && chantierCourant) { %>
    <form action="/chantier/<%= chantierCourant.id %>/vider" method="POST" class="d-inline" id="viderChantierForm">
      <button type="button" class="btn btn-outline-danger mb-3" data-bs-toggle="modal" data-bs-target="#confirmViderChantierModal">
        üóëÔ∏è Vider le chantier
      </button>
    </form>
    <div class="modal fade" id="confirmViderChantierModal" tabindex="-1" aria-labelledby="confirmViderChantierModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmViderChantierModalLabel">Confirmer le vidage</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            √ätes-vous s√ªr de vouloir vider compl√®tement le stock du chantier ¬´ <%= chantierCourant ? chantierCourant.nom : 'ce chantier' %> ¬ª ?
            Cette action est irr√©versible.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-danger" id="confirmViderChantierButton">Oui, vider le chantier</button>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <% } %> <!-- fin du bloc admin -->

  <% if (chantierCourant) { %>
    <a href="/chantier/dashboard?chantierId=<%= chantierCourant.id %>" class="btn btn-info mb-3">
      üìä Dashboard chantier
    </a>
  <% } %>


  <a href="/materiel" class="btn btn-secondary">Retour</a>
</div>

<form method="GET" action="/chantier" class="row g-3 glass-card">
  <div class="col-md-3">
    <label for="chantierId" class="form-label">Filtrer par chantier</label>
    <select class="form-select" name="chantierId" id="chantierId">
      <option value="">-- Tous les chantiers --</option>
      <% if (chantiers && chantiers.length > 0) { %>
        <% chantiers.forEach(function(c) { %>
          <option value="<%= c.id %>" <%= (c.id == chantierId) ? 'selected' : '' %>><%= c.nom %> - <%= c.localisation %></option>
        <% }); %>
      <% } %>
    </select>
  </div>

  <div class="col-md-3">
  <label for="triNom" class="form-label">Trier par nom materiel</label>
  <select class="form-select" name="triNom" id="triNom">
    <option value="">-- Aucun tri --</option>
    <option value="asc" <%= triNom === 'asc' ? 'selected' : '' %>>Nom A ‚Üí Z</option>
    <option value="desc" <%= triNom === 'desc' ? 'selected' : '' %>>Nom Z ‚Üí A</option>
  </select>
</div>

 <div class="col-md-3">
  <label for="triAjout" class="form-label">Ordre d'ajout</label>
  <select class="form-select" name="triAjout" id="triAjout">
    <option value="">-- Aucun tri --</option>
    <option value="desc" <%= triAjout === 'desc' ? 'selected' : '' %>>Plus r√©cent d'abord</option>
    <option value="asc" <%= triAjout === 'asc' ? 'selected' : '' %>>Plus ancien d'abord</option>
  </select>
</div>

 <div class="col-md-3">
   <label for="limit" class="form-label">Nombre de lignes √† afficher</label>
   <input
     type="number"
     min="1"
     class="form-control"
     name="limit"
     id="limit"
     value="<%= limit || '' %>"
     placeholder="Ex : 50"
   >
 </div>

 <input type="hidden" name="triModification" id="triModification" value="<%= triModification || '' %>">
 <div class="col-md-3 d-flex align-items-end">
   <button type="button" id="toggleModif" class="btn btn-outline-secondary">Trier par modification</button>
 </div>


  <div class="col-md-3">
  <label for="categorieSelect" class="form-label">Cat√©gorie</label>
  <select class="form-select" name="categorie" id="categorieSelect">
    <option value="">-- Toutes les cat√©gories --</option>
    <% (categories || []).forEach(function(cat){ %>
      <option value="<%= cat %>" <%= categorie === cat ? 'selected' : '' %>><%= cat %></option>
    <% }); %>
  </select>
</div>


<div class="col-md-3">
  <label for="emplacement" class="form-label">Emplacement</label>
  <select class="form-select" name="emplacement" id="emplacement" style="max-width: 250px;">
    <option value="">-- Tous les emplacements --</option>
    <% if (emplacements && emplacements.length > 0) { %>
      <% emplacements.forEach(function(e) { %>
        <option value="<%= e.nom %>" <%= emplacement === e.nom ? 'selected' : '' %>><%= e.nom %></option>
      <% }); %>
    <% } %>
  </select>
</div>

<div class="col-md-3">
  <label for="fournisseur" class="form-label">Fournisseur</label>
  <select class="form-select" name="fournisseur" id="fournisseur">
    <option value="">-- Tous les fournisseurs --</option>
    <% (fournisseurs || []).forEach(function(f) { %>
      <option value="<%= f %>" <%= fournisseur === f ? 'selected' : '' %>><%= f %></option>
    <% }); %>
  </select>
</div>

<div class="col-md-3">
  <label for="marque" class="form-label">Marque</label>
  <select class="form-select" name="marque" id="marque">
    <option value="">-- Toutes les marques --</option>
    <% (marques || []).forEach(function(marqueOption) { %>
      <option value="<%= marqueOption %>" <%= marque === marqueOption ? 'selected' : '' %>><%= marqueOption %></option>
    <% }); %>
  </select>
</div>




 <div class="col-md-3">
   <label for="recherche" class="form-label">Recherche g√©n√©rale</label>
   <input type="text" class="form-control" name="recherche" id="recherche" value="<%= recherche || '' %>">
 </div>


  <div class="col-12 mt-2">
    <div class="filters-actions">
      <button type="submit" class="btn btn-primary">Appliquer les filtres</button>
      <a href="/chantier?reset=1" class="btn btn-secondary">R√©initialiser</a>
    </div>
  </div>
</form>


  <div class="glass-card column-visibility-card">
    <div class="column-visibility-header">
      <h2 class="h5 mb-0">Affichage des colonnes</h2>
      <p class="subtitle mb-0">S√©lectionnez les colonnes de mat√©riel √† afficher. La colonne Actions reste toujours visible.</p>
    </div>
    <div class="column-visibility-options">
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-designation" data-column-class="col-designation" checked>
        <label class="form-check-label" for="toggle-col-designation">D√©signation</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-photo" data-column-class="col-photo" checked>
        <label class="form-check-label" for="toggle-col-photo">Photo</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-reference" data-column-class="col-reference" checked>
        <label class="form-check-label" for="toggle-col-reference">R√©f√©rence</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-categorie" data-column-class="col-categorie" checked>
        <label class="form-check-label" for="toggle-col-categorie">Cat√©gorie</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-description" data-column-class="col-description" checked>
        <label class="form-check-label" for="toggle-col-description">Description</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-fournisseur" data-column-class="col-fournisseur" checked>
        <label class="form-check-label" for="toggle-col-fournisseur">Fournisseur</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-marque" data-column-class="col-marque" checked>
        <label class="form-check-label" for="toggle-col-marque">Marque</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-emplacement" data-column-class="col-emplacement" checked>
        <label class="form-check-label" for="toggle-col-emplacement">Emplacement</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-rack" data-column-class="col-rack" checked>
        <label class="form-check-label" for="toggle-col-rack">Rack</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-compartiment" data-column-class="col-compartiment" checked>
        <label class="form-check-label" for="toggle-col-compartiment">Compartiment</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-niveau" data-column-class="col-niveau" checked>
        <label class="form-check-label" for="toggle-col-niveau">Niveau</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite" data-column-class="col-quantite" checked>
        <label class="form-check-label" for="toggle-col-quantite">Quantit√© re√ßue</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite-actuelle" data-column-class="col-quantite-actuelle" checked>
        <label class="form-check-label" for="toggle-col-quantite-actuelle">Quantit√© actuelle</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite-prevue1" data-column-class="col-quantite-prevue1,col-date-prevue1" checked>
        <label class="form-check-label" for="toggle-col-quantite-prevue1">Date 1er livraison & Qte 1er livraison</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite-prevue2" data-column-class="col-quantite-prevue2,col-date-prevue2" checked>
        <label class="form-check-label" for="toggle-col-quantite-prevue2">Date 2e livraison & Qte 2e livraison</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite-prevue3" data-column-class="col-quantite-prevue3,col-date-prevue3" checked>
        <label class="form-check-label" for="toggle-col-quantite-prevue3">Date 3e livraison & Qte 3e livraison</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-quantite-prevue4" data-column-class="col-quantite-prevue4,col-date-prevue4" checked>
        <label class="form-check-label" for="toggle-col-quantite-prevue4">Date 4e livraison & Qte 4e livraison</label>
      </div>
      <div class="form-check">
        <input class="form-check-input column-toggle" type="checkbox" id="toggle-col-bdl" data-column-class="col-bon-livraison" checked>
        <label class="form-check-label" for="toggle-col-bdl">Bon de Livraison</label>
      </div>
    </div>
  </div>


    <% const lowStockItems = (materielChantiers || []).filter(mc => mc.isLowStock); %>
    <% if (lowStockItems.length > 0) { %>
      <div class="alert" role="alert"
           style="background-color: rgba(255,99,132,0.25); border: 1px solid rgba(255,99,132,0.6);
           color:#fff; border-radius: 16px; padding:1rem; margin-top:1.5rem;">
        <h5 class="mb-3">Mat√©riels en alerte stock !</h5>
        <ul class="mb-0">
          <% lowStockItems.forEach(function(item) { %>
            <li>
              <strong><%= item.materiel ? item.materiel.nom : '' %></strong> ‚Äî
              Re√ßu‚ÄØ: <%= item.quantite %> / Pr√©vu‚ÄØ: <%= item.totalPrevu %>
            </li>
          <% }); %>
        </ul>
      </div>
    <% } %>

    <% const isAdminUser = user && user.role === 'admin'; %>
    <% if (isAdminUser) { %>
      <div class="d-flex justify-content-end align-items-center mb-2 gap-2">
        <button
          type="button"
          class="btn btn-light btn-mass-update"
          id="openMassUpdate"
          data-bs-toggle="modal"
          data-bs-target="#massUpdateModal"
          disabled
        >
          Modifier en masse
        </button>
        <button
          type="button"
          class="btn btn-warning btn-alert-update"
          id="openAlertStatus"
          data-bs-toggle="modal"
          data-bs-target="#alertStatusModal"
          disabled
        >
          Mettre √† jour l'alerte
        </button>
      </div>
    <% } %>

    <div class="table-wrapper">
      <div class="stock-table-wrap">
        <table class="table table-bordered table-striped table-materiel align-middle table-stock">
      <thead>
        <tr>
          <th class="d-none">ID</th>
          <th class="d-none">Chantier</th>
          <% if (isAdminUser) { %>
          <th class="col-select text-center">
              <div class="d-flex align-items-center justify-content-center gap-2">
                <span class="text-muted">#</span>
                <input type="checkbox" id="selectAllMateriels" class="form-check-input">
              </div>
          </th>
        <% } %>
          <th class="col-designation">D√©signation</th>
          <th class="col-photo">Photo</th>
          <th class="col-reference">R√©f√©rence</th>
          <th class="col-marque">Marque</th>
          <th class="col-categorie">Categorie</th>
          <th class="col-description">Description</th>
          <th class="col-fournisseur">Fournisseur</th>
          <th class="col-emplacement">Emplacement</th>
          <th class="col-rack">Rack</th>
          <th class="col-compartiment">Compartiment</th>
          <th class="col-niveau">Niveau</th>
          <th class="col-quantite">Qte re√ßue</th>
          <th class="col-quantite-actuelle">Qte actuelle</th>
          <th class="col-date-prevue1">Date 1er livraison</th>
          <th class="col-quantite-prevue1">Qte 1er livraison</th>
          <th class="col-date-prevue2">Date 2e livraison</th>
          <th class="col-quantite-prevue2">Qte 2e livraison</th>
          <th class="col-date-prevue3">Date 3e livraison</th>
          <th class="col-quantite-prevue3">Qte 3e livraison</th>
          <th class="col-date-prevue4">Date 4e livraison</th>
          <th class="col-quantite-prevue4">Qte 4e livraison</th>
          <th class="col-bon-livraison">Bon de Livraison</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
      <% if (materielChantiers && materielChantiers.length > 0) { %>
        <% materielChantiers.forEach(function (mc, index) {
             const qRecue = Number(mc.quantite) || 0;
             const qActuelle = mc.quantiteActuelle != null ? Number(mc.quantiteActuelle) : qRecue;
             const qp1 = Number(
               mc.quantitePrevue1 != null
                 ? mc.quantitePrevue1
                 : (mc.quantitePrevue != null ? mc.quantitePrevue : 0)
             ) || 0;
             const qp2 = Number(mc.quantitePrevue2) || 0;
             const qp3 = Number(mc.quantitePrevue3) || 0;
             const qp4 = Number(mc.quantitePrevue4) || 0;
             const totalPrev = qp1 + qp2 + qp3 + qp4;
             const seuil30 = totalPrev > 0 ? totalPrev * 0.3 : null;
             const isLowClient = seuil30 !== null && qActuelle <= seuil30;
             const alertStatus = mc.alertStatus || 'critique';
             const alertRowClass = isLowClient
               ? (alertStatus === 'regle'
                   ? 'alert-low-resolved'
                   : (alertStatus === 'surveillance'
                     ? 'alert-low-monitoring'
                     : 'table-danger stock-low-alert'))
               : '';
        %>
          <tr class="<%= alertRowClass %>">
              <td class="d-none" data-label="ID"><%= mc.id %></td>
              <td class="d-none" data-label="Chantier">
                <%= mc.chantier ? `${mc.chantier.nom} - ${mc.chantier.localisation || ''}` : '' %>
              </td>

             <% if (isAdminUser) { %>
                <td class="col-select text-center" data-label="S√©lection">
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <span class="badge bg-secondary rounded-pill"><%= index + 1 %></span>
                    <input type="checkbox" class="form-check-input materiel-select" value="<%= mc.id %>" data-low-stock="<%= isLowClient ? '1' : '0' %>">
                  </div>
                </td>
              <% } %>

              <td class="col-designation" data-label="D√©signation">
                <%= mc.materiel ? mc.materiel.nom : '' %>
              </td>

              <td class="col-photo cell-photo" data-label="Photo">
                <% if (mc.materiel && mc.materiel.photos && mc.materiel.photos.length > 0) { %>
                  <% const fullPath = mc.materiel.photos[0].chemin
                    .replace(
                      `https://res.cloudinary.com/${process.env.CLOUDINARY_CLOUD_NAME}/image/upload/`,
                      ''
                    );
                  %>
                  <button
                    type="button"
                    class="btn btn-link p-0 border-0"
                    data-bs-toggle="modal"
                    data-bs-target="#globalPhotoModal"
                    data-photo-src="/img-proxy/<%= fullPath %>"
                    data-photo-title="Photo de <%= mc.materiel ? mc.materiel.nom : '' %>"
                  >
                    <img
                      src="/img-proxy/<%= fullPath %>"
                      width="80"
                      alt="Photo de <%= mc.materiel ? mc.materiel.nom : '' %>"
                      class="img-thumbnail"
                    >
                  </button>
                <% } else { %>
                  N/A
                <% } %>
              </td>

              <td class="col-reference" data-label="R√©f√©rence">
                <%= mc.materiel ? (mc.materiel.reference || '-') : '-' %>
              </td>

              <td class="col-marque" data-label="Marque">
                <%= mc.materiel && mc.materiel.marque ? mc.materiel.marque : '-' %>
              </td>

              <td class="col-categorie" data-label="Cat√©gorie">
                <%= mc.materiel && mc.materiel.categorie ? (mc.materiel.categorie.nom || mc.materiel.categorie) : '-' %>
              </td>

              <td class="col-description" data-label="Description">
                <%= mc.materiel && mc.materiel.description ? mc.materiel.description : '-' %>
              </td>

              <td class="col-fournisseur" data-label="Fournisseur">
                <% 
                  const fournisseurName = mc.materiel && mc.materiel.fournisseur 
                    ? (mc.materiel.fournisseur.nom || mc.materiel.fournisseur) 
                    : null; 
                %>

                <% if (fournisseurName) { %>
                  <button
                    type="button"
                    class="btn btn-link p-0 fournisseur-link"
                    data-bs-toggle="modal"
                    data-bs-target="#fournisseurContactModal"
                    data-fournisseur="<%= fournisseurName %>"
                  >
                    <%= fournisseurName %>
                  </button>
                <% } else { %>
                  -
                <% } %>
              </td>

              <td class="col-emplacement" data-label="Emplacement">
                <% if (mc.materiel && mc.materiel.emplacement) { %>
                  <%
                    function afficherChemin(emp) {
                      let chemin = emp.nom;
                      let courant = emp;
                      while (courant.parent) {
                        chemin = `${courant.parent.nom} > ${chemin}`;
                        courant = courant.parent;
                      }
                      return chemin;
                    }
                  %>
                  <%= afficherChemin(mc.materiel.emplacement) %>
                <% } else { %>
                  -
                <% } %>
              </td>

              <td class="col-rack" data-label="Rack"><%= mc.materiel && mc.materiel.rack ? mc.materiel.rack : '-' %></td>
              <td class="col-compartiment" data-label="Compartiment"><%= mc.materiel && mc.materiel.compartiment ? mc.materiel.compartiment : '-' %></td>
              <td class="col-niveau" data-label="Niveau"><%= mc.materiel && mc.materiel.niveau != null ? mc.materiel.niveau : '-' %></td>

              <td class="col-quantite" data-label="Quantit√© re√ßue">
                <%= mc.quantite != null ? mc.quantite : '-' %>
              </td>
              <td class="col-quantite-actuelle" data-label="Quantit√© actuelle">
                <div class="qte-actuelle-value"><%= qActuelle %></div>

                <% if (isLowClient) { %>
                  <% const badgeClass = alertStatus === 'regle'
                    ? 'badge-alert-regle'
                    : (alertStatus === 'surveillance' ? 'badge-alert-surveillance' : 'badge-alert-critique'); %>
                  <% const badgeLabel = alertStatus === 'regle'
                    ? 'Alerte r√©gl√©e'
                    : (alertStatus === 'surveillance' ? 'Alerte √† surveiller' : 'Alerte critique'); %>
                  <% const stockBadgeClass = alertStatus === 'regle'
                    ? 'badge-stock-low badge-stock-low-regle'
                    : (alertStatus === 'surveillance'
                      ? 'badge-stock-low badge-stock-low-surveillance'
                      : 'badge-stock-low badge-stock-low-critique'); %>
                  <div class="qte-alert-details">
                    <span class="<%= stockBadgeClass %>">
                      ‚ö† Stock &lt; 30% du pr√©vu
                    </span>
                    <span class="badge-alert-status <%= badgeClass %>"><%= badgeLabel %></span>
                  </div>
                <% } %>
              </td>
              <td class="col-date-prevue1" data-label="Date 1er livraison">
                <%= formatDateFr(mc.dateLivraisonPrevue1 || mc.dateLivraisonPrevue) || '-' %>
              </td>
              <td class="col-quantite-prevue1" data-label="Qte 1er livraison">
                <div><%= mc.quantitePrevue1 != null ? mc.quantitePrevue1 : (mc.quantitePrevue != null ? mc.quantitePrevue : '-') %></div>
                <% const qteInit1 = mc.quantitePrevueInitiale1 != null ? mc.quantitePrevueInitiale1 : mc.quantitePrevueInitiale; %>
                <% if (qteInit1 != null) { %>
                  <div class="text-muted qte-init-prevue">Qte init pr√©v : <%= qteInit1 %></div>
                <% } %>
              </td>
              <td class="col-date-prevue2" data-label="Date 2e livraison">
                <%= formatDateFr(mc.dateLivraisonPrevue2) || '-' %>
              </td>
              <td class="col-quantite-prevue2" data-label="Qte 2e livraison">
                <div><%= mc.quantitePrevue2 != null ? mc.quantitePrevue2 : '-' %></div>
                <% if (mc.quantitePrevueInitiale2 != null) { %>
                  <div class="text-muted qte-init-prevue">Qte init pr√©v : <%= mc.quantitePrevueInitiale2 %></div>
                <% } %>
              </td>
              <td class="col-date-prevue3" data-label="Date 3e livraison">
                <%= formatDateFr(mc.dateLivraisonPrevue3) || '-' %>
              </td>
              <td class="col-quantite-prevue3" data-label="Qte 3e livraison">
                <div><%= mc.quantitePrevue3 != null ? mc.quantitePrevue3 : '-' %></div>
                <% if (mc.quantitePrevueInitiale3 != null) { %>
                  <div class="text-muted qte-init-prevue">Qte init pr√©v : <%= mc.quantitePrevueInitiale3 %></div>
                <% } %>
              </td>
              <td class="col-date-prevue4" data-label="Date 4e livraison">
                <%= formatDateFr(mc.dateLivraisonPrevue4) || '-' %>
              </td>
              <td class="col-quantite-prevue4" data-label="Qte 4e livraison">
                <div><%= mc.quantitePrevue4 != null ? mc.quantitePrevue4 : '-' %></div>
                <% if (mc.quantitePrevueInitiale4 != null) { %>
                  <div class="text-muted qte-init-prevue">Qte init pr√©v : <%= mc.quantitePrevueInitiale4 %></div>
                <% } %>
              </td>

                <td class="col-bon-livraison" data-column="col-bon-livraison" data-label="Bon de Livraison">
                <%
                  const bdlUrls = Array.isArray(mc.bonLivraisonUrls)
                    ? mc.bonLivraisonUrls
                    : (mc.bonLivraisonUrls ? [mc.bonLivraisonUrls] : []);
                %>
                <% if (bdlUrls.length > 0) { %>
                  <button
                    type="button"
                    class="btn btn-sm btn-info btn-show-bdl"
                    data-bs-toggle="modal"
                    data-bs-target="#globalBdlModal"
                    data-mc-id="<%= mc.id %>"
                    data-bdl-urls="<%= encodeURIComponent(JSON.stringify(bdlUrls)) %>"
                  >
                    Voir (<%= bdlUrls.length %>)
                  </button>
                <% } else { %>
                  -
                <% } %>
              </td>

              <td class="actions col-actions" data-label="Actions">
                <%
                  // Trouve la "ligne source" c√¥t√© chantier courant (pas d'optional chaining ici)
                  var chantierCourantId = (chantierCourant && chantierCourant.id) || null;
                  var sourceMat = null;
                  if (typeof m !== 'undefined' && m && Number(m.chantierId) === Number(chantierCourantId)) {
                    sourceMat = m;
                  } else if (typeof mc !== 'undefined' && mc && mc.materiel && Number(mc.materiel.chantierId) === Number(chantierCourantId)) {
                    sourceMat = mc.materiel;
                  } else if (typeof mc !== 'undefined' && mc && Number(mc.chantierId) === Number(chantierCourantId)) {
                    sourceMat = mc;
                  }
                  var sourceMatId = '';
                  if (sourceMat) {
                    if (typeof sourceMat.materielId !== 'undefined' && sourceMat.materielId !== null) {
                      sourceMatId = sourceMat.materielId;
                    } else {
                      sourceMatId = sourceMat.id;
                    }
                  }
                  var sourceMatNom = (sourceMat && sourceMat.nom)
                    || (typeof mc !== 'undefined' && mc && mc.materiel && mc.materiel.nom)
                    || (typeof mc !== 'undefined' && mc && mc.nom)
                    || '';
                %>
                <div class="btn-wrap">
                  <button
                    type="button"
                    class="btn btn-outline-success btn-sm transfer-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#transferModal"
                    data-action="entree"
                    data-context-type="CHANTIER"
                    data-context-chantier-id="<%= chantierCourant ? chantierCourant.id : '' %>"
                    data-materiel-id="<%= sourceMatId %>"
                    data-materiel-name="<%= sourceMatNom %>"
                    <%= sourceMat ? '' : 'disabled' %>
                  >
                    Entr√©e
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm transfer-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#transferModal"
                    data-action="sortie"
                    data-context-type="CHANTIER"
                    data-context-chantier-id="<%= chantierCourant ? chantierCourant.id : '' %>"
                    data-materiel-id="<%= sourceMatId %>"
                    data-materiel-name="<%= sourceMatNom %>"
                    <%= sourceMat ? '' : 'disabled' %>
                  >
                    Sortie
                  </button>
                  <% if (!sourceMat) { %>
                    <span class="badge bg-danger">Source ID manquant</span>
                  <% } %>
                  <a href="/chantier/materielChantier/info/<%= mc.id %>" class="btn btn-info btn-sm">Info</a>
                  <a
                    href="/chantier/dashboard?chantierId=<%= mc.chantierId %>"
                    class="btn btn-primary btn-sm"
                  >
                    Dashboard
                  </a>
                  <% if (user && user.role === 'admin') { %>
                    <button
                      type="button"
                      class="btn btn-success btn-sm"
                      data-bs-toggle="modal"
                    data-bs-target="#globalReceptionModal"
                    data-mc-id="<%= mc.id %>"
                    data-mat-name="<%= mc.materiel ? mc.materiel.nom : '' %>"
                    data-chantier-name="<%= mc.chantier ? mc.chantier.nom : '' %>"
                    data-quantite-prevue1="<%= mc.quantitePrevue1 || '' %>"
                    data-quantite-prevue2="<%= mc.quantitePrevue2 || '' %>"
                    data-quantite-prevue3="<%= mc.quantitePrevue3 || '' %>"
                    data-quantite-prevue4="<%= mc.quantitePrevue4 || '' %>"
                    data-date-prevue1="<%= mc.dateLivraisonPrevue1 ? mc.dateLivraisonPrevue1.toISOString() : '' %>"
                    data-date-prevue2="<%= mc.dateLivraisonPrevue2 ? mc.dateLivraisonPrevue2.toISOString() : '' %>"
                    data-date-prevue3="<%= mc.dateLivraisonPrevue3 ? mc.dateLivraisonPrevue3.toISOString() : '' %>"
                    data-date-prevue4="<%= mc.dateLivraisonPrevue4 ? mc.dateLivraisonPrevue4.toISOString() : '' %>"
                  >
                    R√©ceptionner
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm mb-1 btn-add-bdl"
                    data-mc-id="<%= mc.id %>"
                  >
                    Ajouter BDL
                  </button>
                  <input
                    type="file"
                    accept="image/*,application/pdf"
                    class="d-none bdl-file-input"
                    data-mc-id="<%= mc.id %>"
                  >
                    <a href="/chantier/materielChantier/modifier/<%= mc.id %>" class="btn btn-warning btn-sm">Modifier</a>
                    <button
                      type="button"
                      class="btn btn-danger btn-sm"
                      data-bs-toggle="modal"
                      data-bs-target="#globalDeleteModal"
                      data-delete-action="/chantier/materielChantier/supprimer/<%= mc.id %>"
                      data-mat-name="<%= mc.materiel ? mc.materiel.nom : '' %>"
                    >
                      Supprimer
                    </button>
                    <a href="/chantier/materielChantier/dupliquer/<%= mc.id %>" class="btn btn-outline-primary btn-sm">Dupliquer</a>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }); %>
        <% } else { %>
          <tr>
            <td colspan="23" class="text-center">Aucune livraison enregistr√©e pour les chantiers.</td>
          </tr>
        <% } %>
      </tbody>
      
        </table>
      </div>
    </div>

  </div>

  <script nonce="<%= nonce %>">
    (function () {
      const toggles = Array.from(document.querySelectorAll('.column-toggle[data-column-class]'));
      if (!toggles.length) {
        return;
      }

      const STORAGE_KEY = 'gs_chantier_columns_v1';

      const storage = (() => {
        try {
          if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') {
            return null;
          }
          const testKey = '__gs_columns_test__';
          window.localStorage.setItem(testKey, '1');
          window.localStorage.removeItem(testKey);
          return window.localStorage;
        } catch (_) {
          return null;
        }
      })();

      const loadState = () => {
        if (!storage) {
          return {};
        }
        try {
          const raw = storage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (_) {
          return {};
        }
      };

      const saveState = (state) => {
        if (!storage) {
          return;
        }
        try {
          storage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (_) {}
      };

      const applyState = (colClasses, visible) => {
        const classes = Array.isArray(colClasses)
          ? colClasses
          : String(colClasses)
              .split(',')
              .map((cls) => cls.trim())
              .filter(Boolean);

        classes.forEach((colClass) => {
          document.querySelectorAll(`.table-stock .${colClass}, [data-column="${colClass}"]`).forEach((cell) => {
            cell.classList.toggle('hidden-column', !visible);
          });
        });
      };

      const state = loadState();

      toggles.forEach((toggle) => {
        const colClass = toggle.dataset.columnClass;
        if (!colClass) {
          return;
        }

        const colClasses = colClass
          .split(',')
          .map((cls) => cls.trim())
          .filter(Boolean);

        if (!colClasses.length) {
          return;
        }

        if (Object.prototype.hasOwnProperty.call(state, colClass)) {
          toggle.checked = Boolean(state[colClass]);
        }

        applyState(colClasses, toggle.checked);

        toggle.addEventListener('change', () => {
          state[colClass] = toggle.checked;
          applyState(colClasses, toggle.checked);
          saveState(state);
        });
      });

      document.querySelectorAll('.table-stock .col-actions').forEach((cell) => {
        cell.classList.remove('hidden-column');
      });
    })();
  </script>

  <!-- Modales globales -->
  <div class="modal fade" id="globalPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="globalPhotoTitle">Photo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body text-center">
          <img id="globalPhotoImg" src="" alt="" class="img-fluid rounded">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="globalReceptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="globalReceptionForm" action="" method="POST">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">R√©ceptionner du mat√©riel</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2"><strong>Mat√©riel :</strong> <span id="receptionMatName"></span></p>
            <p class="mb-3"><strong>Chantier :</strong> <span id="receptionChantierName"></span></p>
            <div class="mb-3">
              <label class="form-label">Livraison pr√©vue :</label>
              <select name="livraisonIndex" class="form-select" id="receptionLivraison"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Quantit√© re√ßue</label>
              <input
                id="receptionQty"
                type="number"
                step="1"
                min="0"
                class="form-control"
                name="quantiteReceptionnee"
                required
                inputmode="decimal"
              />
            </div>
            <div class="mb-3">
              <label class="form-label" for="receptionDate">Date de r√©ception</label>
              <div class="input-group">
                <input
                  type="date"
                  class="form-control"
                  name="dateReception"
                  id="receptionDate"
                  required
                >
                <button
                  class="btn btn-outline-secondary d-none d-lg-inline-flex align-items-center"
                  type="button"
                  id="receptionDatePickerBtn"
                  aria-label="Ouvrir le calendrier"
                >
                  üìÖ
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-success">Valider</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="globalDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="globalDeleteForm" action="" method="POST">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmer la suppression</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            √ätes-vous s√ªr de vouloir supprimer <strong id="deleteMatName"></strong> du chantier ?<br>
            <em>Cette action est irr√©versible.</em>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Supprimer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <% const transferChantiers = Array.isArray(chantiers) ? chantiers : []; %>
  <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="transferForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">
            <span id="transferModalAction">Transfert</span> - <span id="transferModalMateriel"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="contextType" id="transferContextType" value="CHANTIER">
          <input type="hidden" name="contextChantierId" id="transferContextChantierId" value="<%= chantierCourant ? chantierCourant.id : '' %>">
          <input type="hidden" name="materielId" id="transferMaterielId" value="">
          <input type="hidden" name="materielName" id="transferMaterielName" value="">

          <div class="mb-3">
            <label for="transferTargetChantierId" class="form-label">Chantier</label>
            <select class="form-select" name="targetChantierId" id="transferTargetChantierId" required>
              <option value="">-- S√©lectionner un chantier --</option>
              <% transferChantiers.forEach(function(c) { %>
                <option value="<%= c.id %>"><%= c.nom %><% if (c.localisation) { %> - <%= c.localisation %><% } %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label for="transferQuantite" class="form-label">Quantit√©</label>
            <input
              type="number"
              class="form-control"
              id="transferQuantite"
              name="quantite"
              min="0"
              step="1"
              required
            >
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Valider</button>
        </div>
      </form>
    </div>
  </div>

  <% const upcomingDeliveriesList = Array.isArray(upcomingDeliveries) ? upcomingDeliveries : []; %>
  <% const tomorrowDeliveries = upcomingDeliveriesList.filter(delivery => delivery.status === 'tomorrow'); %>
  <% const todayDeliveries = upcomingDeliveriesList.filter(delivery => delivery.status === 'today'); %>
  <% const lateDeliveries = upcomingDeliveriesList.filter(delivery => delivery.status === 'late'); %>
  <div class="modal fade" id="deliveryReminderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title mb-1">Livraisons √† surveiller</h5>
            <div class="text-muted small" id="deliveryReminderSubtitle">0 demain ‚Ä¢ 0 aujourd'hui ‚Ä¢ 0 en retard</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <% const sections = [
            { title: 'Demain', items: tomorrowDeliveries, badgeClass: 'bg-primary' },
            { title: "Aujourd'hui", items: todayDeliveries, badgeClass: 'bg-success' },
            { title: 'En retard', items: lateDeliveries, badgeClass: 'bg-danger' }
          ]; %>
          <% if (!upcomingDeliveriesList.length) { %>
            <div class="text-center text-muted py-4">Aucune livraison imminente.</div>
          <% } else { %>
            <div class="border rounded bg-light-subtle p-2 mb-3">
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-6">
                  <label class="small text-muted" for="deliveryFilterChantier">Chantier</label>
                  <select id="deliveryFilterChantier" class="form-select form-select-sm">
                    <option value="">Tous les chantiers</option>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="small text-muted" for="deliveryFilterFournisseur">Fournisseur</label>
                  <select id="deliveryFilterFournisseur" class="form-select form-select-sm">
                    <option value="">Tous les fournisseurs</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="deliveryFilterEmpty" class="alert alert-light border text-muted small py-2 mb-3 d-none">
              Aucune livraison pour ce filtre.
            </div>
            <% sections.forEach(function(section) { %>
              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h6 class="mb-0 text-uppercase small"><%= section.title %></h6>
                  <span class="badge <%= section.badgeClass %>"><%= section.items.length %></span>
                </div>
                <% if (!section.items.length) { %>
                  <div class="text-muted small">Aucune livraison.</div>
                <% } else { %>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Mat√©riel</th>
                          <th>Chantier</th>
                          <th>Date pr√©vue</th>
                          <th>Message</th>
                          <th class="text-center">Statut</th>
                          <th class="text-center">Ne plus me rappeler</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% section.items.forEach(function(delivery) { %>
                          <tr
                            data-chantier="<%= (delivery.chantierName || '').trim().toLowerCase() %>"
                            data-fournisseur="<%= (delivery.fournisseurName || '').trim().toLowerCase() %>"
                            data-status="<%= delivery.status %>"
                          >
                            <td>
                              <a
                                href="#"
                                class="delivery-material-link"
                                data-material-name="<%= delivery.materielName %>"
                              ><%= delivery.materielName %></a>
                            </td>
                            <td><%= delivery.chantierName %></td>
                            <td><%= formatDateFr(delivery.date) || '-' %></td>
                            <td><%= delivery.message %></td>
                            <td class="text-center">
                              <% if (delivery.status === 'tomorrow') { %>
                                <span class="badge bg-primary">Demain</span>
                              <% } else if (delivery.status === 'today') { %>
                                <span class="badge bg-success">Aujourd'hui</span>
                              <% } else { %>
                                <span class="badge bg-danger">En retard</span>
                              <% } %>
                            </td>
                            <td class="text-center">
                              <input
                                class="form-check-input delivery-dismiss-checkbox"
                                type="checkbox"
                                value="<%= delivery.id %>-<%= delivery.slotIndex %>"
                                aria-label="Ne plus me rappeler"
                              >
                            </td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                <% } %>
              </div>
            <% }); %>
          <% } %>
        </div>
        <div class="modal-footer">
          <div class="form-check me-auto">
            <input class="form-check-input" type="checkbox" id="deliverySelectAll">
            <label class="form-check-label" for="deliverySelectAll">Tout cocher</label>
          </div>
          <button type="button" class="btn btn-outline-secondary" id="hideDeliveryModalToday">Masquer pour aujourd'hui</button>
          <button type="button" class="btn btn-primary" id="confirmDeliveryDismiss">Valider</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="fournisseurContactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Fiche fournisseur : <span id="fournisseurContactName"></span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body" id="fournisseurContactBody">
          <!-- contenu inject√© en JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modale globale pour afficher la liste des BDL -->
  <div class="modal fade" id="globalBdlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bons de livraison</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <ul id="globalBdlList" class="list-unstyled mb-0">
            <!-- rempli dynamiquement en JS -->
          </ul>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <% if (isAdminUser) { %>
    <div class="modal fade" id="massUpdateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="massUpdateForm">
            <div class="modal-header">
              <h5 class="modal-title">Modifier en masse</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                Les valeurs saisies seront appliqu√©es √† toutes les lignes s√©lectionn√©es.
              </div>
              <div class="mb-3">
                <label for="massQuantiteRecue" class="form-label">Qte re√ßue</label>
                <input type="number" class="form-control" id="massQuantiteRecue" name="quantiteRecue" min="0" step="1" placeholder="Laisser vide pour ne pas modifier">
              </div>
              <div class="mb-3">
                <label for="massBdlFile" class="form-label">Ajouter BDL (fichier)</label>
                <input
                  type="file"
                  class="form-control"
                  id="massBdlFile"
                  name="bdlFile"
                  accept="image/*,application/pdf"
                >
                <div class="form-text">Le fichier sera t√©l√©vers√© puis ajout√© √† chaque mat√©riel s√©lectionn√©.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-primary" id="confirmMassUpdate" disabled>Appliquer</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="alertStatusModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="alertStatusForm">
            <div class="modal-header">
              <h5 class="modal-title">Mettre √† jour le statut des alertes</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
              <p class="mb-3">Appliquer un nouveau statut aux lignes s√©lectionn√©es (en alerte ‚â§ 30%).</p>
              <div class="list-group">
                <label class="list-group-item d-flex align-items-center gap-2">
                  <input class="form-check-input" type="radio" name="alertStatusChoice" value="surveillance" required>
                  <span>
                    <strong>Alerte √† surveiller</strong><br>
                    <small class="text-muted">Passe l'alerte en orange pour suivi.</small>
                  </span>
                </label>
                <label class="list-group-item d-flex align-items-center gap-2">
                  <input class="form-check-input" type="radio" name="alertStatusChoice" value="regle">
                  <span>
                    <strong>Alerte r√©gl√©e</strong><br>
                    <small class="text-muted">Marque l'alerte comme r√©solue (vert).</small>
                  </span>
                </label>
                <label class="list-group-item d-flex align-items-center gap-2">
                  <input class="form-check-input" type="radio" name="alertStatusChoice" value="critique">
                  <span>
                    <strong>Alerte critique</strong><br>
                    <small class="text-muted">Revenir au statut critique (rouge).</small>
                  </span>
                </label>
              </div>
              <div class="alert alert-warning mt-3 mb-0" id="alertSelectionInfo">
                S√©lectionnez au moins une ligne en alerte pour activer ce bouton.
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              <button type="submit" class="btn btn-primary" id="confirmAlertStatus" disabled>Appliquer</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <!-- 1) Bootstrap d'abord -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script nonce="<%= nonce %>">
    (function () {
      const viderForm = document.getElementById('viderChantierForm');
      const confirmBtn = document.getElementById('confirmViderChantierButton');
      if (!viderForm || !confirmBtn) return;

      confirmBtn.addEventListener('click', function () {
        const modalEl = document.getElementById('confirmViderChantierModal');
        if (modalEl) {
          const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          modalInstance.hide();
        }
        viderForm.submit();
      });
    })();
  </script>

  <!-- Auto-rechargement des filtres (Stock Chantier) -->
  <script nonce="<%= nonce %>">
    (function () {
      const spinner = document.getElementById('pageSpinner');
      const showSpinner = () => spinner && spinner.classList.add('show');

      const forms = Array.from(document.querySelectorAll('form')).filter((f) => {
        const method = (f.getAttribute('method') || 'GET').toUpperCase();
        const action = f.getAttribute('action') || window.location.pathname;
        return method === 'GET' && /\/chantier(\/)?$/.test(action);
      });

      if (!forms.length) {
        return;
      }

      const form = forms[0];
      const params = new URLSearchParams(window.location.search);

      form.querySelectorAll('input, select').forEach((el) => {
        if (!el.name) {
          return;
        }

        if (el.tagName === 'SELECT') {
          const value = params.get(el.name);
          if (value !== null) {
            el.value = value;
          }
          return;
        }

        if (el.type === 'checkbox' || el.type === 'radio') {
          if (params.getAll(el.name).includes(el.value)) {
            el.checked = true;
          }
          return;
        }

        if (el.type === 'text' || el.type === 'number' || el.type === 'search') {
          const value = params.get(el.name);
          if (value !== null) {
            el.value = value;
          }
        }
      });

      function applyAndReload() {
        const url = new URL(window.location.href);
        const searchParams = url.searchParams;

        Array.from(searchParams.keys()).forEach((key) => searchParams.delete(key));
        new FormData(form).forEach((value, key) => {
          if (value !== null && String(value).trim() !== '') {
            searchParams.append(key, value);
          }
        });

        showSpinner();
        window.location.assign(url.toString());
      }

      form.querySelectorAll('select, input[type="checkbox"], input[type="radio"]').forEach((el) => {
        el.addEventListener('change', () => {
          applyAndReload();
        });
      });

      let timeoutId = null;
      const debounce = (fn, delay = 500) => {
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn(...args), delay);
        };
      };

      const debouncedApply = debounce(applyAndReload, 500);
      form.querySelectorAll('input[type="text"], input[type="search"], input[type="number"]').forEach((el) => {
        el.addEventListener('input', () => debouncedApply());
        el.addEventListener('change', () => applyAndReload());
      });

      form.addEventListener('submit', () => {
        showSpinner();
      });
    })();
  </script>

  <script nonce="<%= nonce %>">
    window.upcomingDeliveries = <%- JSON.stringify(upcomingDeliveriesList || []) %>;
    (function () {
      const deliveries = Array.isArray(window.upcomingDeliveries) ? window.upcomingDeliveries : [];
      if (!deliveries.length) {
        return;
      }

      const userId = <%- JSON.stringify(user && user.id ? user.id : null) %>;
      const hideStorageKey = userId ? `hideDeliveryModalUntil_user_${userId}` : 'hideDeliveryModalUntil';
      const getDateString = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const todayString = getDateString(new Date());
      const hideUntil = localStorage.getItem(hideStorageKey);
      if (hideUntil && hideUntil >= todayString) {
        return;
      }

      const modalElement = document.getElementById('deliveryReminderModal');
      if (!modalElement) {
        return;
      }

      const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
      modalInstance.show();

      const subtitle = document.getElementById('deliveryReminderSubtitle');
      const emptyFilterMessage = document.getElementById('deliveryFilterEmpty');
      const filterChantierSelect = document.getElementById('deliveryFilterChantier');
      const filterFournisseurSelect = document.getElementById('deliveryFilterFournisseur');
      const rows = Array.from(document.querySelectorAll('#deliveryReminderModal tbody tr'));
      const normalizeValue = (value) => String(value || '').trim().toLowerCase();
      const getVisibleRows = () => rows.filter((row) => !row.classList.contains('d-none'));
      const updateSubtitleCounts = () => {
        if (!subtitle) {
          return;
        }
        const counts = getVisibleRows().reduce((acc, row) => {
          const status = row.dataset.status || '';
          if (status === 'tomorrow') {
            acc.tomorrow += 1;
          } else if (status === 'today') {
            acc.today += 1;
          } else if (status === 'late') {
            acc.late += 1;
          }
          return acc;
        }, { tomorrow: 0, today: 0, late: 0 });
        subtitle.textContent = `${counts.tomorrow} demain \u2022 ${counts.today} aujourd'hui \u2022 ${counts.late} en retard`;
      };

      const filterForm = document.querySelector('form[action="/chantier"]');
      const searchInput = document.querySelector('input[name="recherche"]');

      document.querySelectorAll('.delivery-material-link').forEach((link) => {
        link.addEventListener('click', (event) => {
          event.preventDefault();
          const materialName = link.dataset.materialName || '';
          if (searchInput) {
            searchInput.value = materialName;
          }
          if (filterForm) {
            filterForm.submit();
          }
        });
      });

      const checkboxes = Array.from(document.querySelectorAll('.delivery-dismiss-checkbox'));
      const selectAllCheckbox = document.getElementById('deliverySelectAll');
      const getVisibleCheckboxes = () => checkboxes.filter((checkbox) => {
        const row = checkbox.closest('tr');
        return row && !row.classList.contains('d-none');
      });
      const updateSelectAllState = () => {
        if (!selectAllCheckbox) {
          return;
        }
        const visibleCheckboxes = getVisibleCheckboxes();
        if (!visibleCheckboxes.length) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
          return;
        }
        const checkedCount = visibleCheckboxes.filter((checkbox) => checkbox.checked).length;
        selectAllCheckbox.checked = checkedCount === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < visibleCheckboxes.length;
      };

      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
          getVisibleCheckboxes().forEach((checkbox) => {
            checkbox.checked = selectAllCheckbox.checked;
          });
          updateSelectAllState();
        });
      }

      checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', updateSelectAllState);
      });
      updateSelectAllState();

      const hideTodayButton = document.getElementById('hideDeliveryModalToday');
      if (hideTodayButton) {
        hideTodayButton.addEventListener('click', () => {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          localStorage.setItem(hideStorageKey, getDateString(tomorrow));
          modalInstance.hide();
        });
      }

      const confirmButton = document.getElementById('confirmDeliveryDismiss');
      if (confirmButton) {
        confirmButton.addEventListener('click', async () => {
          const checkedBoxes = getVisibleCheckboxes().filter((checkbox) => checkbox.checked);
          if (!checkedBoxes.length) {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
              console.warn('[delivery-dismiss] Aucun item s√©lectionn√© pour la requ√™te.');
            }
            modalInstance.hide();
            return;
          }

          const items = checkedBoxes.map((checkbox) => {
            const raw = checkbox.value || '';
            const [id, slotIndex] = raw.split('-');
            return { id: Number(id), slotIndex: Number(slotIndex) };
          });

          try {
            const resp = await fetch('/chantier/materielChantier/dismiss-delivery-popup', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ items })
            });

            if (!resp.ok) {
              throw new Error('Erreur serveur');
            }

            const data = await resp.json();
            if (!data || !data.success) {
              throw new Error('R√©ponse invalide');
            }
            window.location.reload();
          } catch (err) {
            console.error('Erreur lors de la d√©sactivation du rappel :', err);
            alert('Impossible de mettre √† jour les rappels.');
          }
        });
      }

      const buildSelectOptions = (select, options, allLabel) => {
        if (!select) {
          return;
        }
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = allLabel;
        select.appendChild(defaultOption);
        options.forEach((option) => {
          const opt = document.createElement('option');
          opt.value = option.normalized;
          opt.textContent = option.display;
          select.appendChild(opt);
        });
      };

      const buildChantierOptions = () => {
        const map = new Map();
        deliveries.forEach((delivery) => {
          const display = String(delivery.chantierName || '').trim();
          if (!display) {
            return;
          }
          const normalized = normalizeValue(display);
          if (!map.has(normalized)) {
            map.set(normalized, display);
          }
        });
        return Array.from(map.entries())
          .map(([normalized, display]) => ({ normalized, display }))
          .sort((a, b) => a.display.localeCompare(b.display, 'fr', { sensitivity: 'base' }));
      };

      const buildFournisseurOptions = (selectedChantier) => {
        const map = new Map();
        deliveries.forEach((delivery) => {
          const chantierNormalized = normalizeValue(delivery.chantierName || '');
          if (selectedChantier && chantierNormalized !== selectedChantier) {
            return;
          }
          const display = String(delivery.fournisseurName || '').trim();
          if (!display) {
            return;
          }
          const normalized = normalizeValue(display);
          if (!map.has(normalized)) {
            map.set(normalized, display);
          }
        });
        return Array.from(map.entries())
          .map(([normalized, display]) => ({ normalized, display }))
          .sort((a, b) => a.display.localeCompare(b.display, 'fr', { sensitivity: 'base' }));
      };

      const applyFilters = () => {
        const selectedChantier = normalizeValue(filterChantierSelect && filterChantierSelect.value);
        const selectedFournisseur = normalizeValue(filterFournisseurSelect && filterFournisseurSelect.value);
        rows.forEach((row) => {
          const chantierOk = !selectedChantier || row.dataset.chantier === selectedChantier;
          const fournisseurOk = !selectedFournisseur || row.dataset.fournisseur === selectedFournisseur;
          row.classList.toggle('d-none', !(chantierOk && fournisseurOk));
        });
        updateSubtitleCounts();
        updateSelectAllState();
        if (emptyFilterMessage) {
          emptyFilterMessage.classList.toggle('d-none', getVisibleRows().length > 0);
        }
      };

      if (filterChantierSelect && filterFournisseurSelect) {
        buildSelectOptions(filterChantierSelect, buildChantierOptions(), 'Tous les chantiers');
        buildSelectOptions(filterFournisseurSelect, buildFournisseurOptions(''), 'Tous les fournisseurs');

        filterChantierSelect.addEventListener('change', () => {
          buildSelectOptions(
            filterFournisseurSelect,
            buildFournisseurOptions(normalizeValue(filterChantierSelect.value)),
            'Tous les fournisseurs'
          );
          filterFournisseurSelect.value = '';
          applyFilters();
        });

        filterFournisseurSelect.addEventListener('change', () => {
          applyFilters();
        });
      }

      applyFilters();
    })();
  </script>

  <!-- 2) D√©placer les modales SOUS <body> une fois le DOM pr√™t -->
  <script nonce="<%= nonce %>">
    document.addEventListener('DOMContentLoaded', function () {
      ['globalPhotoModal','globalReceptionModal','globalDeleteModal','transferModal','globalBdlModal','deliveryReminderModal','fournisseurContactModal']
        .forEach(function (id) {
          var el = document.getElementById(id);
          if (el && el.parentNode !== document.body) {
            document.body.appendChild(el);
          }
        });
    });
  </script>

  <script nonce="<%= nonce %>">
    // ‚ö†Ô∏è Les donn√©es viennent d'un export Excel, √† corriger au besoin
// ‚ö†Ô∏è Donn√©es de fiches fournisseurs (mise √† jour depuis ton tableau Excel)
const FOURNISSEUR_CONTACTS = {
  // ---------- TABLEAU ACTUEL (captures) ----------

  "THIRRIEZ": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Audrey Gu√©ant",
        fonction: "Assistante Commerciale IDF",
        tel: "03 74 95 47 60",
        email: "a.gueant@thiriez-literie.fr"
      },
      {
        titre: "Contact 2",
        nom: "Transporteur Desauty",
        tel: "03 21 50 64 65"
      }
    ]
  },

  "BRICOMAN": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Guillaume",
        tel: "06 64 03 37 07",
        email: "guillaume.gabette@bricoman.fr"
      },
      {
        titre: "Contact 2",
        nom: "Yoann TANCHOUX",
        fonction: "Manager des ventes",
        tel: "06 10 88 68 43",
        email: "Tyoann.tanchoux@bricoman.fr"
      },
      {
        titre: "Contact 3",
        nom: "Joanna PADRE",
        fonction: "Manager Service Clients",
        tel: "07 79 01 32 71"
      }
    ]
  },

  "SOTEXPRO": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "S√©verine Gicquel",
        fonction: "Charg√©e de Projet - Paris/Ouest",
        tel: "07 72 14 58 36",
        email: "sgicquel@etoffes-inspire.fr"
      },
      {
        titre: "Contact 2",
        nom: "Priscilla ZIMMERMANN",
        fonction: "Assistante Grands Comptes",
        tel: "+33 4 77 27 60 70",
        email: "pzimmermann@sotexpro.fr"
      }
    ]
  },

  "BARCELONALED": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Fanny Perrin",
        fonction: "Commercial",
        tel: "+34 932 41 80 81",
        email: "commercial@barcelonaled.fr"
      }
    ]
  },

  "JM EXIM MENUISERIE PVC": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Katarzyna Badziag",
        tel: "0048 661 291 480",
        email: "kasia@jmeximfenetres.eu"
      }
    ]
  },

  "QUARANTE SIX": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Isabelle Griffaut",
        fonction: "Charg√©e d‚Äôaffaires",
        tel: "01 34 52 18 70",
        email: "commercial.trappes@quarantesix.fr"
      }
    ]
  },

  "RENOV&REFRESH": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "M√©lanie SORRIAUX",
        fonction: "Responsable de projets",
        tel: "04 77 74 01 01",
        email: "melanie.sorriaux@renov-refresh.com"
      }
    ]
  },

  "SOUSTRAITANT ELECTRICITE": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "PATAMAVONG Christopher",
        tel: "07 60 49 49 64",
        email: "stmi.christopher@gmail.com"
      }
    ]
  },

  "FOUSSIER": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Thierry THOMAS",
        fonction: "FOUSSIER",
        tel: "02 50 82 18 21",
        email: "comptoir.monthlery@foussier.fr"
      },
      {
        titre: "Contact 2",
        nom: "Manuel Castandet",
        tel: "01 78 19 20 00 / 07 60 62 99 29"
      }
    ]
  },

  "HUMELAB": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Guillaume VAILLANT",
        fonction: "Key Account Manager",
        tel: "+33 (0)6 12 03 08 86",
        email: "guillaume.vaillant@humelab.com"
      },
      {
        titre: "Contact 2",
        nom: "Marie Arraiolos",
        fonction: "Assistante Commerciale",
        tel: "+33 (0)6 12 03 06 12",
        email: "marie.arraiolos@humelab.com"
      }
    ]
  },

  "STRATOBOIS": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Jean Louis Demichel",
        fonction: "Responsable Bureau d'√âtudes",
        tel: "06 75 78 78 99",
        email: "jeanlouis.demichel@stratobois.fr"
      },
      {
        titre: "Contact 2",
        nom: "Marie Hello",
        fonction: "Resp adjointe du Bureau d'√âtudes",
        tel: "06 38 30 39 38",
        email: "marie.hello@stratobois.fr"
      },
      {
        titre: "Contact 3",
        nom: "Cyril Fructuoso",
        tel: "06 19 54 47 55",
        email: "cyril.fructuoso@stratobois.fr"
      }
    ]
  },

  "FORBO": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Mathilde R√âGNIER",
        fonction: "Assistante Commerciale Service clients France",
        tel: "03 59 58 00 26",
        email: "adv.france.sudouest@forbo.com"
      },
      {
        titre: "Contact 2",
        fonction: "Service clients France / Grands comptes",
        email: "flooring.france.grandscomptes@forbo.com"
      },
      {
        titre: "Contact 3",
        nom: "Jo√´l Nunes",
        fonction: "Key Account Manager ‚Äì Directeur Grands Comptes H√¥tellerie",
        tel: "+33 6 30 52 22 78"
      }
    ]
  },

  "GROHE": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Arnaud MADELAINE",
        fonction: "Responsable Grands Comptes IDF - KAM Installateurs et B.E",
        tel: "06 07 43 93 19"
      },
      {
        titre: "Contact 2",
        nom: "ELBAZ Ya√´l",
        fonction: "KAM A&D, Grands Comptes Architectes",
        tel: "06 83 09 04 47"
      }
    ]
  },

  "EGE": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Gr√©goire HAILLOT",
        fonction: "Responsable Commercial R√©gional",
        tel: "+33 6 74 74 52 92",
        email: "GRHA@EGECARPETS.COM"
      },
      {
        titre: "Contact 2",
        nom: "Sophie ZANELLI",
        fonction: "Assistante ADV",
        tel: "+33 1 40 60 44 51",
        email: "SOZA@EGECARPETS.COM"
      }
    ]
  },

  "TEMPO MATERIAUX": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "M. Coskun ATLI",
        tel: "+33 (0)6 79 40 64 98 / +33 (0)3 88 26 15 71",
        email: "contact@tempo-materiaux.fr"
      }
    ]
  },

  "France AIR": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "M. Louis BERMEJO",
        fonction: "Technico-Commercial S√©dentaire - Secteur 91 Ouest",
        tel: "01 69 34 85 00",
        email: "louis.bermejo@france-air.com"
      },
      {
        titre: "Contact 2",
        nom: "M. Nicolas JONCKHEERE",
        fonction: "Attach√© Technico-Commercial itin√©rant - Secteur 91 Ouest",
        tel: "06 22 70 92 68",
        email: "nicolas.jonckheere@france-air.com"
      }
    ]
  },

  "ODF": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Carole QUILLIVIC",
        fonction: "Service Commercial",
        tel: "02 35 04 67 00",
        email: "c.quillivic@odf.fr"
      },
      {
        titre: "Contact 2",
        nom: "Kateryna MOLCHENKO",
        fonction: "Service Commercial / Sales Department",
        tel: "03 25 04 67 00",
        email: "k.molchenko@odf.fr"
      }
    ]
  },

  "CEDEO": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Christophe Viana Gomes",
        tel: "01 49 36 26 00",
        email: "Christophe.VianaGomes@cedeo.fr"
      },
      {
        titre: "Contact 2",
        nom: "Nadir",
        tel: "06 98 35 91 08"
      }
    ]
  },

  "GRADA": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Ismail HAJJI",
        fonction: "Technico Commercial S√©dentaire",
        tel: "+33 (0)3 20 11 63 90"
      },
      {
        titre: "Contact 2",
        fonction: "Pour vos Commandes",
        email: "isdfrance@gradafrance.com"
      },
      {
        titre: "Contact 3",
        fonction: "Pour vos Demandes de Prix",
        email: "devis@gradafrance.com"
      }
    ]
  },

  "SONEPAR": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Nora SAGET",
        fonction: "Technico-commerciale S√©dentaire",
        tel: "+33 (0)1 59 23 52 02",
        email: "nora.saget@sonepar.fr"
      },
      {
        titre: "Contact 2",
        nom: "Sophie Schmitt",
        email: "sophie.schmitt@sonepar.fr"
      }
    ]
  },

  "LES RIPEURS": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Camille",
        tel: "06 47 77 82 70",
        email: "contact@lesripeurs.com"
      }
    ]
  },

  "AUDIENCE & CREATION": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "La√´titia Meder",
        fonction: "Responsable Service client",
        tel: "+33 2 40 60 33 02",
        email: "laetitia@audience-creation.fr"
      },
      {
        titre: "Contact 2",
        nom: "Ludivine Rigaux",
        fonction: "Gestionnaire ADV",
        tel: "+33 1 71 54 73 86",
        email: "ludivine@audience-creation.fr"
      }
    ]
  },

  "9EME SENS": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "S√©verine Gervais",
        tel: "06 47 18 37 13",
        email: "gervaisseverine@gmail.com"
      }
    ]
  },

  "WELSPUN": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Karim Baraka",
        fonction: "Account Manager - Welspun World",
        tel: "+44 73 83 149 371",
        email: "Karim.Baraka@Welspun.com"
      }
    ]
  },

  "NEOLOGY": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Pierre DELMAS",
        fonction: "Canap√©s Design",
        tel: "+33 (0)5 55 20 58 22 / +33 (0)6 48 20 12 31",
        email: "p.delmas@neology.tm.fr"
      }
    ]
  },

  "VESCOM": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Pascoal VICENTE",
        fonction: "Assistante commerciale",
        tel: "+33 1 39 97 70 24",
        email: "commandes@vescom.com"
      },
      {
        titre: "Contact 2",
        nom: "Jean Daniel Gauthier",
        fonction: "Charg√© d‚Äôaffaires",
        tel: "+33 7 869 592 79"
      }
    ]
  },

  "EDIL": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Franck THOMAS",
        email: "thomas@edil.biz"
      }
    ]
  },

  "SPM": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "PERRON Galane",
        fonction: "Technico Commerciale S√©dentaire",
        tel: "+33 5 34 39 40 40",
        email: "gperron@spm.fr"
      },
      {
        titre: "Contact 2",
        nom: "Viviane LESCURE",
        fonction: "Assistante Commerciale",
        tel: "05 34 39 40 70",
        email: "suivi.commandes@spm.fr"
      }
    ]
  },

  "POINT P": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Nabile TAHIRI",
        fonction: "Attach√© Technico Commercial",
        tel: "06 32 40 73 60"
      },
      {
        titre: "Contact 2",
        fonction: "Agence d‚ÄôArpajon",
        tel: "+33 (0)1 69 17 13 80",
        email: null
      }
    ]
  },

  // ---------- FOURNISSEURS QUI EXISTAIENT D√âJ√Ä (inchang√©s) ----------

  "PIXELO": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Mihail TOMA",
        fonction: "Dep. Export",
        tel: "+40 742 666 999",
        email: "mihai@primetrustventure.com"
      },
      {
        titre: "Contact 2",
        nom: "Catalin VASILESCU",
        fonction: "Dep. Export",
        tel: "+40 743 98 77 99"
      }
    ]
  },

  "JM EXIM": { // alias, sera synchronis√© plus bas si besoin
    contacts: [
      {
        titre: "Contact 1",
        nom: "Katarzyna Badziag",
        tel: "0048 661 291 480",
        email: "kasia@jmeximfenetres.eu"
      }
    ]
  },

  "HUSSEIN": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Hussein",
        tel: "06 59 31 59 01"
      }
    ]
  },

  "RICHARDSON": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Nicolas Beauflis",
        fonction: "Responsable des Ventes Expo",
        tel: "+33 6 83 43 93 05",
        email: "nicolas.beauflis@geberit.com"
      },
      {
        titre: "Contact 2",
        email: "info@santintio.fr",
        tel: "+33 1 78 90 06 65 (Lun‚Äìven, 8‚Äì17h)"
      }
    ]
  },

  "MPI": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Stephanie Gr√©goire",
        fonction: "Charg√©e d'affaires",
        tel: "+32 4 377 40 81",
        email: "info@mpi.be"
      },
      {
        titre: "Contact 2",
        nom: "Sarah Nizet",
        fonction: "Assistante commerciale"
      },
      {
        titre: "Contact 3",
        nom: "Kelly Jaquet",
        tel: "+32 4 377 91 25"
      }
    ]
  },

  "KINEDO": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Elodie BOUREAU",
        fonction: "Assistante commerciale service chantier",
        tel: "+33 (0)2 40 21 26 79"
      },
      {
        titre: "Contact 2",
        nom: "Charlotte LEFORT",
        fonction: "Assistante Commerciale service chantier",
        tel: "+33 (0)2 40 21 26 79"
      }
    ]
  },

  "TARGETTI": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "Veronique Carrey",
        fonction: "Assistante de Direction Commerciale",
        tel: "+33 1 44 29 08 86",
        email: "veronique.carrey@targetti.com"
      },
      {
        titre: "Contact 2",
        nom: "B√©atrice Gey",
        fonction: "Assistante Commerciale",
        tel: "+33 1 44 29 08 73",
        email: "beatrice.gey@targetti.com"
      }
    ]
  },

  "PURE-COM": {
    contacts: [
      {
        titre: "Contact 1",
        nom: "In√®s Barb√©",
        fonction: "Charg√©e de Marketing Digital & Business Developer",
        tel: "01 64 13 49 80 / 07 67 37 45 56"
      }
    ]
  }
};

// Alias pour g√©rer diff√©rentes √©critures dans la base
FOURNISSEUR_CONTACTS["STMI"] = FOURNISSEUR_CONTACTS["SOUSTRAITANT ELECTRICITE"];
FOURNISSEUR_CONTACTS["TEMPO"] = FOURNISSEUR_CONTACTS["TEMPO MATERIAUX"];
FOURNISSEUR_CONTACTS["France'AIR"] = FOURNISSEUR_CONTACTS["France AIR"];
FOURNISSEUR_CONTACTS["JM EXIM"] = FOURNISSEUR_CONTACTS["JM EXIM MENUISERIE PVC"];

  </script>

  <script nonce="<%= nonce %>">
    document.addEventListener('DOMContentLoaded', function () {
      const modalEl = document.getElementById('fournisseurContactModal');
      if (!modalEl) return;

      const nameEl  = document.getElementById('fournisseurContactName');
      const bodyEl  = document.getElementById('fournisseurContactBody');

      modalEl.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        if (!btn) return;

        const fournisseur = btn.getAttribute('data-fournisseur') || '';
        const data = FOURNISSEUR_CONTACTS[fournisseur];

        if (nameEl) {
          nameEl.textContent = fournisseur || 'Fournisseur';
        }

        if (!bodyEl) return;

        if (!data || !Array.isArray(data.contacts) || data.contacts.length === 0) {
          bodyEl.innerHTML = `
            <p class="mb-0">Aucune fiche de contact n'est enregistr√©e pour ce fournisseur.</p>
          `;
          return;
        }

        const html = data.contacts.map(c => `
          <div class="mb-3 pb-2 border-bottom border-secondary">
            <h6 class="mb-1">${c.titre || ''}</h6>
            <p class="mb-0"><strong>${c.nom || ''}</strong></p>
            ${c.fonction ? `<p class="mb-0">${c.fonction}</p>` : ''}
            ${c.tel ? `<p class="mb-0">üìû ${c.tel}</p>` : ''}
            ${c.email ? `<p class="mb-0">‚úâÔ∏è <a href="mailto:${c.email}">${c.email}</a></p>` : ''}
          </div>
        `).join('');

        bodyEl.innerHTML = html;
      });
    });
  </script>

  <!-- 3) Hydratation des modales (inchang√©) -->
  <script nonce="<%= nonce %>">
    (function(){
      const on = (id, evt, fn) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener(evt, fn);
      };

      on('globalPhotoModal', 'show.bs.modal', (ev) => {
        const btn = ev.relatedTarget;
        const src = btn?.dataset.photoSrc || '';
        const title = btn?.dataset.photoTitle || 'Photo';
        const img = document.getElementById('globalPhotoImg');
        const titleEl = document.getElementById('globalPhotoTitle');
        if (img) img.src = src;
        if (titleEl) titleEl.textContent = title;
      });

      on('globalReceptionModal', 'show.bs.modal', (ev) => {
        const btn = ev.relatedTarget;
        const mcId = btn?.dataset.mcId;
        const matName = btn?.dataset.matName || '';
        const chantierName = btn?.dataset.chantierName || '';
        const form = document.getElementById('globalReceptionForm');
        if (form) {
          form.action = `/chantier/materielChantier/receptionner/${mcId}`;
        }
        const matSpan = document.getElementById('receptionMatName');
        const chantierSpan = document.getElementById('receptionChantierName');
        if (matSpan) matSpan.textContent = matName;
        if (chantierSpan) chantierSpan.textContent = chantierName;
        const qty = document.getElementById('receptionQty');
        if (qty) qty.value = '';
        const livraisonSelect = document.getElementById('receptionLivraison');
        if (livraisonSelect) {
          livraisonSelect.innerHTML = '';
          const addOption = (idx, qtyValue, dateValue) => {
            const parsedQty = Number.parseInt(qtyValue, 10);
            if (Number.isNaN(parsedQty) || parsedQty <= 0) return;
            const option = document.createElement('option');
            option.value = String(idx);
            let dateLabel = '-';
            if (dateValue) {
              const parsedDate = new Date(dateValue);
              if (!Number.isNaN(parsedDate.getTime())) {
                dateLabel = parsedDate.toLocaleDateString('fr-FR');
              }
            }
            option.textContent = `Livraison ${idx} ‚Äì ${dateLabel}`;
            livraisonSelect.appendChild(option);
          };

          addOption(1, btn?.dataset.quantitePrevue1, btn?.dataset.datePrevue1);
          addOption(2, btn?.dataset.quantitePrevue2, btn?.dataset.datePrevue2);
          addOption(3, btn?.dataset.quantitePrevue3, btn?.dataset.datePrevue3);
          addOption(4, btn?.dataset.quantitePrevue4, btn?.dataset.datePrevue4);

          if (!livraisonSelect.options.length) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'R√©ception sans livraison pr√©vue';
            livraisonSelect.appendChild(option);
          }
        }
        const dateInput = document.getElementById('receptionDate');
        if (dateInput) {
          const now = new Date();
          now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          dateInput.value = now.toISOString().split('T')[0];
        }
      });

      on('globalDeleteModal', 'show.bs.modal', (ev) => {
        const btn = ev.relatedTarget;
        const action = btn?.dataset.deleteAction || '#';
        const matName = btn?.dataset.matName || '';
        const form = document.getElementById('globalDeleteForm');
        if (form) {
          form.action = action;
        }
        const matSpan = document.getElementById('deleteMatName');
        if (matSpan) matSpan.textContent = matName;
      });
    })();
  </script>

  <script nonce="<%= nonce %>">
    (function () {
      function setNavbarPadding() {
        var nb = document.querySelector('.navbar');
        if (!nb) return;
        var h = nb.offsetHeight || 64;
        document.documentElement.style.setProperty('--navbar-h', h + 'px');
      }

      window.addEventListener('load', setNavbarPadding);
      window.addEventListener('resize', setNavbarPadding);
      document.addEventListener('readystatechange', setNavbarPadding);
    })();
  </script>

  <script nonce="<%= nonce %>">
    document.addEventListener('DOMContentLoaded', function () {
      var dateInput = document.getElementById('receptionDate');
      var pickerBtn = document.getElementById('receptionDatePickerBtn');
      if (!dateInput || !pickerBtn) {
        return;
      }

      pickerBtn.addEventListener('click', function () {
        if (typeof dateInput.showPicker === 'function') {
          dateInput.showPicker();
          return;
        }
        dateInput.focus();
        if (typeof dateInput.click === 'function') {
          dateInput.click();
        }
      });
    });
  </script>

  <script nonce="<%= nonce %>">
    const toggleBtn = document.getElementById('toggleMode');
    const body = document.body;
    const navBar = document.querySelector('.navbar');
    const modifBtn = document.getElementById('toggleModif');
    const modifInput = document.getElementById('triModification');
    const transferModalElement = document.getElementById('transferModal');
    const transferForm = document.getElementById('transferForm');
    const transferActionLabel = document.getElementById('transferModalAction');
    const transferMaterielLabel = document.getElementById('transferModalMateriel');
    const transferMaterielNameInput = document.getElementById('transferMaterielName');
    const transferTargetSelect = document.getElementById('transferTargetChantierId');
    const transferQuantityInput = document.getElementById('transferQuantite');

    if (transferModalElement) {
      transferModalElement.addEventListener('show.bs.modal', (event) => {
        const triggerButton = event.relatedTarget;
        if (!transferForm || !triggerButton) {
          return;
        }

        transferForm.reset();
        const action = triggerButton.dataset.action || 'entree';
        transferForm.setAttribute('action', `/transferts/${action}`);
        transferForm.dataset.transferAction = action;

        const setInputValue = (selector, value) => {
          const input = transferForm.querySelector(selector);
          if (input) {
            input.value = value;
          }
        };

        setInputValue('[name="contextType"]', triggerButton.dataset.contextType || 'CHANTIER');
        setInputValue('[name="contextChantierId"]', triggerButton.dataset.contextChantierId || '');
        setInputValue('[name="materielId"]', triggerButton.dataset.materielId || '');
        setInputValue('[name="materielName"]', triggerButton.dataset.materielName || '');

        if (transferActionLabel) {
          transferActionLabel.textContent = action === 'entree' ? 'Entr√©e' : 'Sortie';
        }
        if (transferMaterielLabel) {
          transferMaterielLabel.textContent = triggerButton.dataset.materielName || '';
        }
        if (transferTargetSelect) {
          transferTargetSelect.value = '';
        }
        if (transferQuantityInput) {
          transferQuantityInput.value = '';
        }
      });
    }

    if (transferForm) {
      transferForm.addEventListener('submit', (event) => {
        const action = transferForm.dataset.transferAction || 'entree';
        const actionLabel = action === 'entree' ? "l'entr√©e" : 'la sortie';
        const qtyValue = transferQuantityInput ? transferQuantityInput.value.trim() : '';
        const normalizedQty = qtyValue.replace(/,/g, '.');
        const qtyNumber = Number.parseFloat(normalizedQty);
        if (!Number.isFinite(qtyNumber) || qtyNumber <= 0) {
          event.preventDefault();
          return;
        }

        const materialName = transferMaterielNameInput ? transferMaterielNameInput.value : '';
        const selectedOption = transferTargetSelect && transferTargetSelect.selectedIndex >= 0
          ? transferTargetSelect.options[transferTargetSelect.selectedIndex]
          : null;
        const chantierLabel = selectedOption ? selectedOption.text.trim() : '';
        const confirmationMessage = `Confirmer ${actionLabel} de ${qtyValue || qtyNumber} unit√©s\n` +
          `Mat√©riel : ${materialName}\n` +
          `Chantier s√©lectionn√© : ${chantierLabel}`;
        if (!window.confirm(confirmationMessage)) {
          event.preventDefault();
        }
      });
    }

    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        body.classList.toggle('mode-sombre');
        if (body.classList.contains('mode-sombre')) {
          navBar.classList.add('navbar-dark');
          toggleBtn.textContent = 'Mode clair';
        } else {
          navBar.classList.remove('navbar-dark');
          toggleBtn.textContent = 'Mode sombre';
        }
      });
    }

    if(modifBtn){
      modifBtn.addEventListener('click', () => {
        modifInput.value = modifInput.value === 'desc' ? 'asc' : 'desc';
        modifBtn.form.submit();
      });
    }
  </script>

  <script nonce="<%= nonce %>">
    (function () {
      const btn = document.getElementById('toggleCompact');
      if (!btn) return;
      const KEY = 'gs_compact_mobile';

      try {
        if (localStorage.getItem(KEY) === '1') {
          document.body.classList.add('compact-mobile');
        }
      } catch (_) {}

      btn.addEventListener('click', () => {
        document.body.classList.toggle('compact-mobile');
        try {
          localStorage.setItem(KEY, document.body.classList.contains('compact-mobile') ? '1' : '0');
        } catch (_) {}
      });
    })();
  </script>

  <% if (isAdminUser) { %>
    <script nonce="<%= nonce %>">
      (function () {
        const selectAll = document.getElementById('selectAllMateriels');
        const rowCheckboxes = Array.from(document.querySelectorAll('.materiel-select'));
        const openBtn = document.getElementById('openMassUpdate');
        const submitBtn = document.getElementById('confirmMassUpdate');
        const form = document.getElementById('massUpdateForm');
        const qtyInput = document.getElementById('massQuantiteRecue');
        const bdlFileInput = document.getElementById('massBdlFile');
        const alertBtn = document.getElementById('openAlertStatus');
        const alertModal = document.getElementById('alertStatusModal');
        const alertForm = document.getElementById('alertStatusForm');
        const alertSubmit = document.getElementById('confirmAlertStatus');
        const alertSelectionInfo = document.getElementById('alertSelectionInfo');

        const CLOUD_NAME = '<%= cloudinaryCloudName || "" %>';
        const UPLOAD_PRESET = '<%= cloudinaryUploadPresetBdl || "" %>';
        const spinner = document.getElementById('pageSpinner');
        const showSpinner = () => spinner && spinner.classList.add('show');
        const hideSpinner = () => spinner && spinner.classList.remove('show');
        const canUploadBdl = CLOUD_NAME && UPLOAD_PRESET;

        async function uploadBdlFile(file) {
          const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
          const fd = new FormData();
          fd.append('file', file);
          fd.append('upload_preset', UPLOAD_PRESET);
          fd.append('folder', 'bdl');

          const resp = await fetch(url, {
            method: 'POST',
            body: fd
          });

          if (!resp.ok) {
            throw new Error('Cloudinary HTTP ' + resp.status);
          }

          const data = await resp.json();
          return data.secure_url || data.url;
        }

        const getSelectedIds = () => rowCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        const getSelectedAlertIds = () => rowCheckboxes
          .filter(cb => cb.checked && cb.dataset.lowStock === '1')
          .map(cb => cb.value);

        const syncButtons = () => {
          const hasSelection = getSelectedIds().length > 0;
          const hasLowSelection = getSelectedAlertIds().length > 0;
          if (openBtn) openBtn.disabled = !hasSelection;
          if (submitBtn) submitBtn.disabled = !hasSelection;
          if (alertBtn) alertBtn.disabled = !hasLowSelection;
          if (alertSubmit) alertSubmit.disabled = !hasLowSelection;
          if (selectAll) {
            selectAll.checked = hasSelection && rowCheckboxes.every(cb => cb.checked);
            selectAll.indeterminate = !selectAll.checked && hasSelection;
          }
          if (alertSelectionInfo) {
            alertSelectionInfo.textContent = hasLowSelection
              ? `${getSelectedAlertIds().length} ligne(s) en alerte s√©lectionn√©e(s).`
              : 'S√©lectionnez au moins une ligne en alerte pour activer ce bouton.';
          }
        };

        rowCheckboxes.forEach(cb => {
          cb.addEventListener('change', syncButtons);
        });

        if (selectAll) {
          selectAll.addEventListener('change', () => {
            const checked = selectAll.checked;
            rowCheckboxes.forEach(cb => {
              cb.checked = checked;
            });
            syncButtons();
          });
        }

        const validateQuantite = (value) => {
          if (value === '') return true;
          const normalized = value.replace(/,/g, '.');
          const num = Number(normalized);
          return Number.isFinite(num) && num >= 0;
        };

        if (form) {
          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const ids = getSelectedIds();
            const quantiteValue = qtyInput ? qtyInput.value.trim() : '';
            const bdlFile = bdlFileInput && bdlFileInput.files ? bdlFileInput.files[0] : null;

            if (!ids.length) {
              return;
            }

            if (!quantiteValue && !bdlFile) {
              alert('Renseignez au moins une valeur √† appliquer.');
              return;
            }

            if (!validateQuantite(quantiteValue)) {
              alert('La quantit√© re√ßue doit √™tre un nombre positif.');
              return;
            }

            const payload = { ids };
            if (quantiteValue !== '') {
              payload.quantiteRecue = quantiteValue.replace(/,/g, '.');
            }
            if (bdlFile) {
              if (!canUploadBdl) {
                alert('Le t√©l√©versement de BDL n\'est pas configur√©.');
                return;
              }
              try {
                showSpinner();
                const uploadedUrl = await uploadBdlFile(bdlFile);
                payload.bdlUrl = uploadedUrl;
              } catch (uploadErr) {
                console.error('Erreur upload BDL masse :', uploadErr);
                alert("Impossible d'uploader le bon de livraison.");
                return;
              } finally {
                hideSpinner();
              }
            }

            try {
              const resp = await fetch('/chantier/materielChantier/miseAJourMasse', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(txt || 'Erreur serveur');
              }

              window.location.reload();
            } catch (err) {
              console.error('Erreur lors de la mise √† jour en masse :', err);
              alert('Impossible de modifier les lignes s√©lectionn√©es : ' + err.message);
            }
          });
        }

        const massModal = document.getElementById('massUpdateModal');
        if (massModal) {
          massModal.addEventListener('show.bs.modal', () => {
            syncButtons();
          });
          massModal.addEventListener('hidden.bs.modal', () => {
            if (form) {
              form.reset();
            }
            if (bdlFileInput) {
              bdlFileInput.value = '';
            }
          });
        }

        if (alertForm) {
          alertForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const alertIds = getSelectedAlertIds();
            const choice = document.querySelector('input[name="alertStatusChoice"]:checked');

            if (!alertIds.length) {
              alert('S√©lectionnez au moins une ligne en alerte.');
              return;
            }

            if (!choice) {
              alert('Choisissez un statut √† appliquer.');
              return;
            }

            try {
              const resp = await fetch('/chantier/materielChantier/alerteStatut', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: alertIds, statut: choice.value })
              });

              if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(txt || 'Erreur serveur');
              }

              window.location.reload();
            } catch (err) {
              console.error('Erreur lors de la mise √† jour du statut alerte :', err);
              alert('Impossible de mettre √† jour les alertes : ' + err.message);
            }
          });
        }

        if (alertModal) {
          alertModal.addEventListener('show.bs.modal', () => {
            syncButtons();
          });
          alertModal.addEventListener('hidden.bs.modal', () => {
            const selected = alertForm ? alertForm.querySelectorAll('input[name="alertStatusChoice"]') : [];
            selected.forEach(input => { input.checked = false; });
          });
        }

        syncButtons();
      })();
    </script>
  <% } %>

  <!-- Upload direct Cloudinary pour les BDL -->
  <script nonce="<%= nonce %>">
    (function () {
      const CLOUD_NAME = '<%= cloudinaryCloudName || "" %>';
      const UPLOAD_PRESET = '<%= cloudinaryUploadPresetBdl || "" %>';

      if (!CLOUD_NAME || !UPLOAD_PRESET) {
        console.warn('Cloudinary BDL non configur√© (CLOUD_NAME ou PRESET manquant).');
        return;
      }

      const spinner = document.getElementById('pageSpinner');
      const showSpinner = () => spinner && spinner.classList.add('show');
      const hideSpinner = () => spinner && spinner.classList.remove('show');

      async function uploadToCloudinary(file) {
        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', 'bdl');

        const resp = await fetch(url, {
          method: 'POST',
          body: fd
        });

        if (!resp.ok) {
          throw new Error('Cloudinary HTTP ' + resp.status);
        }

        const data = await resp.json();
        return data.secure_url || data.url;
      }

      async function enregistrerBdl(mcId, bdlUrl) {
        const resp = await fetch(`/chantier/materielChantier/${mcId}/ajouterBDL`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: new URLSearchParams({ url: bdlUrl })
        });
        if (!resp.ok) {
          throw new Error('Erreur serveur lors de la sauvegarde du BDL');
        }
      }

      document.querySelectorAll('.btn-add-bdl').forEach((btn) => {
        const mcId = btn.dataset.mcId;
        const input = document.querySelector(`.bdl-file-input[data-mc-id="${mcId}"]`);
        if (!input) return;

        btn.addEventListener('click', () => input.click());

        input.addEventListener('change', async () => {
          const file = input.files[0];
          if (!file) return;

          try {
            showSpinner();
            const cloudUrl = await uploadToCloudinary(file);
            await enregistrerBdl(mcId, cloudUrl);
            window.location.reload();
          } catch (err) {
            console.error('Erreur BDL Cloudinary :', err);
            alert("Erreur lors de l'upload du bon de livraison.");
          } finally {
            hideSpinner();
            input.value = '';
          }
        });
      });
    })();
  </script>


  <!-- Script pour la modale BDL : liste de tous les bons de livraison -->
  <script nonce="<%= nonce %>">
    (function () {
      var bdlModal = document.getElementById('globalBdlModal');
      if (!bdlModal) return;

      var listEl = document.getElementById('globalBdlList');
      if (!listEl) return;

      var currentBtn = null;
      var currentUrls = [];
      var currentMcId = '';

      bdlModal.addEventListener('show.bs.modal', function (event) {
        var btn = event.relatedTarget;
        if (!btn) return;

        var raw = btn.getAttribute('data-bdl-urls') || '[]';
        currentMcId = btn.getAttribute('data-mc-id') || '';
        currentBtn = btn;
        var urls = [];
        try {
          urls = JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          console.warn('Impossible de parser la liste des BDL :', e);
          urls = [];
        }

        currentUrls = urls.slice();

        // nettoyage
        listEl.innerHTML = '';

        if (!urls.length) {
          var liEmpty = document.createElement('li');
          liEmpty.textContent = 'Aucun bon de livraison enregistr√©.';
          listEl.appendChild(liEmpty);
          return;
        }

        urls.forEach(function (u, idx) {
          if (!u) return;
          var li = document.createElement('li');
          li.className = 'mb-2';

          var a = document.createElement('a');
          a.href = u;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Bon de livraison ' + (idx + 1);

          li.appendChild(a);

          var deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn btn-sm btn-outline-danger ms-2';
          deleteBtn.textContent = 'Supprimer BDL';

          deleteBtn.addEventListener('click', async function () {
            if (!currentMcId) return;
            var confirmation = confirm('Supprimer ce bon de livraison ?');
            if (!confirmation) return;

            try {
              var resp = await fetch(`/chantier/materielChantier/${currentMcId}/supprimerBDL`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: new URLSearchParams({ url: u })
              });

              if (!resp.ok) {
                throw new Error('HTTP ' + resp.status);
              }

              var removeIdx = currentUrls.indexOf(u);
              if (removeIdx !== -1) {
                currentUrls.splice(removeIdx, 1);
              }

              li.remove();

              if (currentBtn) {
                if (currentUrls.length > 0) {
                  currentBtn.textContent = 'Voir (' + currentUrls.length + ')';
                  currentBtn.setAttribute('data-bdl-urls', encodeURIComponent(JSON.stringify(currentUrls)));
                } else {
                  var parentTd = currentBtn.closest('td');
                  if (parentTd) {
                    parentTd.textContent = '-';
                  }
                }
              }

              if (!listEl.children.length) {
                var liEmpty = document.createElement('li');
                liEmpty.textContent = 'Aucun bon de livraison enregistr√©.';
                listEl.appendChild(liEmpty);
              }
            } catch (err) {
              console.error('Erreur suppression BDL :', err);
              alert('Impossible de supprimer ce bon de livraison.');
            }
          });

          li.appendChild(deleteBtn);
          listEl.appendChild(li);
        });
      });
    })();
  </script>

  <!-- Historique chantier : reprendre automatiquement le filtre chantier courant -->
  <script nonce="<%= nonce %>">
    (function () {
      const btnHistorique = document.getElementById('btnHistoriqueChantier');
      if (!btnHistorique) return;

      btnHistorique.addEventListener('click', function (e) {
        e.preventDefault();

        // On suppose que le select de filtre chantier a name="chantierId"
        const chantierSelect = document.querySelector('select[name="chantierId"]');

        let url = '/chantier/historique';

        if (chantierSelect && chantierSelect.value && chantierSelect.value !== 'all') {
          const params = new URLSearchParams({ chantierId: chantierSelect.value });
          url += '?' + params.toString();
        }

        window.location.href = url;
      });
    })();
  </script>

</body>
</html>
