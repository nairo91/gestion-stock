<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Gestion de Stock</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Votre style CSS perso -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    :root {
      --navbar-h: 64px;
    }

    body {
      padding-top: var(--navbar-h);
    }

    /* === conteneur plus large (PC) === */
    @media (min-width: 1400px) {
      .container,
      .container-lg,
      .container-xl,
      .container-xxl {
        max-width: 1600px;
      }
    }

    .navbar.fixed-top,
    .navbar.sticky-top {
      z-index: 1030;
    }

    /* --- STOCK TABLE: force one-row, enable horizontal scroll --- */
    .stock-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-stock {
      border-collapse: separate;
      table-layout: fixed;
      min-width: 1280px;
    }

    .table-stock th,
    .table-stock td {
      vertical-align: middle;
      white-space: nowrap;
      line-height: 1.25;
    }

    .table-stock .btn {
      white-space: nowrap;
    }

    .table-stock td .btn-group,
    .table-stock td .btn-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .table-stock .cell-photo img {
      display: block;
      max-width: 90px;
      height: auto;
      margin: 0 auto;
    }

    @media (max-width: 1200px) {
      .table-stock th:last-child,
      .table-stock td:last-child {
        position: sticky;
        right: 0;
        background: rgba(22, 18, 37, .92);
        backdrop-filter: blur(2px);
        z-index: 2;
      }
    }

    @media (max-width: 768px) {
      .table-stock .col-designation {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        word-break: break-word;
        hyphens: auto;
        min-width: 220px !important;
      }
      .table-stock .col-emplacement {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: clip !important;
        word-break: break-word;
        hyphens: auto;
        min-width: 140px !important;
      }
      .table-stock {
        min-width: 1250px;
      }
    }

    /* === MODE COMPACT+ (mobile : tout tenir sans scroller) === */
    body.compact-mobile .table-stock {
      min-width: 100% !important;
      width: 100%;
      table-layout: fixed;
      font-size: 12px;
    }

    body.compact-mobile .table-stock th,
    body.compact-mobile .table-stock td {
      padding: 6px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.25;
    }

    body.compact-mobile .table-stock .cell-photo img {
      max-width: 44px;
    }

    body.compact-mobile .table-materiel thead th {
      font-size: 11px;
      padding: 8px 6px;
    }

    body.compact-mobile .table-stock th:nth-child(3),
    body.compact-mobile .table-stock td:nth-child(3) {
      min-width: 90px;
    }

    body.compact-mobile .table-stock .col-designation,
    body.compact-mobile .table-stock .col-emplacement {
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      word-break: break-word;
      hyphens: auto;
    }
    body.compact-mobile .table-stock .col-designation {
      min-width: 160px;
    }
    body.compact-mobile .table-stock .col-emplacement {
      min-width: 120px;
    }

    body.compact-mobile .table-stock th:nth-child(5),
    body.compact-mobile .table-stock td:nth-child(5) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock th:nth-child(6),
    body.compact-mobile .table-stock td:nth-child(6) {
      min-width: 80px;
    }

    body.compact-mobile .table-stock th:nth-child(7),
    body.compact-mobile .table-stock td:nth-child(7) {
      min-width: 100px;
    }

    body.compact-mobile .table-stock th:nth-child(8),
    body.compact-mobile .table-stock td:nth-child(8) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock td .btn-group,
    body.compact-mobile .table-stock td .btn-wrap {
      gap: 4px;
    }

    body.compact-mobile .table-stock td .btn {
      padding: 4px 6px;
      font-size: 12px;
    }

    /* =================== MODE SOMBRE =================== */
    body.mode-sombre {
      /* Fond général très foncé mais non noir */
      background-color: #121212;
      color: #e0e0e0;
    }
    body.mode-sombre .navbar {
      background-color: #1f1f1f !important;
    }
    body.mode-sombre .navbar.navbar-light .navbar-brand,
    body.mode-sombre .navbar.navbar-light .nav-link {
      color: #e0e0e0 !important;
    }
    body.mode-sombre .card {
      background-color: #1f1f1f;
      color: #e0e0e0;
    }
    body.mode-sombre .card-header {
      background-color: #2c2c2c;
      color: #fff;
    }
    body.mode-sombre .form-control {
      background-color: #2c2c2c;
      color: #fff;
      border-color: #444;
    }

    /* =================== MENUS DÉROULANTS (SELECT) =================== */
    .form-select {
      /* Supprime l’apparence native pour pouvoir injecter l’icône */
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      /* Pour Edge / IE */
      &::-ms-expand {
        display: none;
      }

      /* Couleur de fond et texte en mode clair */
      background-color: #fff;
      color: #333;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;

      /* Icône PNG (flèche) pour le mode clair */
      background-image: url("/images/arrow-light.png");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 20px auto;
      padding-right: 2rem; /* Laisser la place pour la flèche */
    }

    /* =================== MODE SOMBRE POUR LES SELECT =================== */
    body.mode-sombre .form-select {
      background-color: #2c2c2c !important;
      color: #fff !important;
      border-color: #444 !important;

      /* Icône PNG (flèche) pour le mode sombre */
      background-image: url("/images/arrow-dark.png");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 20px auto;
    }

    /* =================== TABLEAU EN MODE SOMBRE =================== */
    body.mode-sombre table.table-bordered {
      border-color: #444;
      background-color: var(--bs-table-bg);
    }
    body.mode-sombre .table thead th {
      background-color: #2c2c2c;
      color: #fff;
    }
    body.mode-sombre .table-striped > tbody > tr:nth-of-type(odd) {
      --bs-table-accent-bg: #2a2a2a;
    }
  </style>
</head>

<body>
  <% const formatQuantity = value => Number(value ?? 0).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); %>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Gestion de Stock</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarContent" aria-controls="navbarContent"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Espace droit de la navbar -->
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <!-- Bouton pour basculer mode sombre -->
            <button id="toggleCompact" class="btn btn-outline-secondary me-2">Compact+</button>
            <button id="toggleMode" class="btn btn-outline-secondary me-2">Mode sombre</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="d-flex gap-2 mt-2">
    <a href="https://receptionbr.onrender.com/selection.html" class="btn btn-primary">Gestion Tâches</a>
    <a href="https://receptionbr.onrender.com/" class="btn btn-primary">Réception</a>
  </div>

  <!-- Contenu principal -->
  <div class="container mt-4">

    <!-- Formulaire de recherche/filtrage (dans une card) -->
    <div class="card mb-4">
      <div class="card-header">
        <strong>Filtrer le stock</strong>
      </div>
      <div class="card-body">
        <form class="row g-3" method="GET" action="/materiel">
          <!-- Nom -->
          <div class="col-md-2">
            <label for="nom" class="form-label">Nom</label>
            <input type="text" class="form-control" name="nom" id="nom"
                   placeholder="ex: Bois" value="<%= query.nom || '' %>">
          </div>

           <!-- Référence  ✅ NOUVEAU -->
           <div class="col-md-2">
            <label for="reference" class="form-label">Référence</label>
            <input  type="text" class="form-control" id="reference" name="reference"
                    placeholder="ex: RFHRU658DG" value="<%= query.reference || '' %>">
          </div>

          <!-- Catégorie -->
          <div class="col-md-2">
            <label for="categorie" class="form-label">Catégorie</label>
            <select name="categorie" id="categorie" class="form-select">
              <option value="">Toutes catégories</option>
              <option value="Électricité" <%= (query.categorie === 'Électricité') ? 'selected' : '' %>>Électricité</option>
              <option value="Plomberie" <%= (query.categorie === 'Plomberie') ? 'selected' : '' %>>Plomberie</option>
              <option value="CVC" <%= (query.categorie === 'CVC') ? 'selected' : '' %>>CVC</option>
              <option value="Plâtrerie" <%= (query.categorie === 'Plâtrerie') ? 'selected' : '' %>>Plâtrerie</option>
              <option value="Menuiserie INT" <%= (query.categorie === 'Menuiserie INT') ? 'selected' : '' %>>Menuiserie INT</option>
              <option value="Menuiserie EXT" <%= (query.categorie === 'Menuiserie EXT') ? 'selected' : '' %>>Menuiserie EXT</option>
              <option value="Maçonnerie" <%= (query.categorie === 'Maçonnerie') ? 'selected' : '' %>>Maçonnerie</option>
              <option value="Revêtement de sol" <%= (query.categorie === 'Revêtement de sol') ? 'selected' : '' %>>Revêtement de sol</option>
              <option value="Revêtement mural" <%= (query.categorie === 'Revêtement mural') ? 'selected' : '' %>>Revêtement mural</option>
              <option value="Quincaillerie" <%= (query.categorie === 'Quincaillerie') ? 'selected' : '' %>>Quincaillerie</option>
              <option value="Fixations (visseries, colles…)" <%= (query.categorie === 'Fixations (visseries, colles…)') ? 'selected' : '' %>>Fixations (visseries, colles…)</option>
              <option value="Outillage Électroportatif" <%= (query.categorie === 'Outillage Électroportatif') ? 'selected' : '' %>>Outillage Électroportatif</option>
              <option value="Autres" <%= (query.categorie === 'Autres') ? 'selected' : '' %>>Autres</option>
            </select>
          </div>

          <!-- Rack -->
          <div class="col-md-2">
            <label for="rack" class="form-label">Rack</label>
            <select name="rack" id="rack" class="form-select">
              <option value="">Tous les racks</option>
              <option value="RM1" <%= (query.rack === 'RM1') ? 'selected' : '' %>>RM1</option>
              <option value="RM2" <%= (query.rack === 'RM2') ? 'selected' : '' %>>RM2</option>
              <option value="RM3" <%= (query.rack === 'RM3') ? 'selected' : '' %>>RM3</option>
              <option value="RM4" <%= (query.rack === 'RM4') ? 'selected' : '' %>>RM4</option>
              <option value="RM5" <%= (query.rack === 'RM5') ? 'selected' : '' %>>RM5</option>
              <option value="RM6" <%= (query.rack === 'RM6') ? 'selected' : '' %>>RM6</option>
              <option value="RM7" <%= (query.rack === 'RM7') ? 'selected' : '' %>>RM7</option>
              <option value="RM8" <%= (query.rack === 'RM8') ? 'selected' : '' %>>RM8</option>
              <option value="RM9" <%= (query.rack === 'RM9') ? 'selected' : '' %>>RM9</option>
              <option value="RM10" <%= (query.rack === 'RM10') ? 'selected' : '' %>>RM10</option>
              <option value="GL" <%= (query.rack === 'GL') ? 'selected' : '' %>>GL</option>
              <option value="RK" <%= (query.rack === 'RK') ? 'selected' : '' %>>RK</option>
              <option value="ZS" <%= (query.rack === 'ZS') ? 'selected' : '' %>>Zone Sécu (ZS)</option>
              <option value="Mezza" <%= (query.rack === 'Mezza') ? 'selected' : '' %>>Mezza</option>
              <option value="Contenaire" <%= (query.rack === 'Contenaire') ? 'selected' : '' %>>Contenaire</option>
              <option value="A"   <%= (query.rack === 'A')   ? 'selected' : '' %>>A</option>
              <option value="B"   <%= (query.rack === 'B')   ? 'selected' : '' %>>B</option>
              <option value="C"   <%= (query.rack === 'C')   ? 'selected' : '' %>>C</option>
            </select>
          </div>

          <!-- Compartiment -->
          <div class="col-md-2">
            <label for="compartiment" class="form-label">Compartiment</label>
            <select name="compartiment" id="compartiment" class="form-select">
              <option value="">Tous les compartiments</option>
              <option value="A" <%= (query.compartiment === 'A') ? 'selected' : '' %>>A</option>
              <option value="B" <%= (query.compartiment === 'B') ? 'selected' : '' %>>B</option>
              <option value="C" <%= (query.compartiment === 'C') ? 'selected' : '' %>>C</option>
              <option value="D" <%= (query.compartiment === 'D') ? 'selected' : '' %>>D</option>
              <option value="E" <%= (query.compartiment === 'E') ? 'selected' : '' %>>E</option>
              <option value="F" <%= (query.compartiment === 'F') ? 'selected' : '' %>>F</option>
              <option value="G" <%= (query.compartiment === 'G') ? 'selected' : '' %>>G</option>
              <option value="H" <%= (query.compartiment === 'H') ? 'selected' : '' %>>H</option>
              <option value="I" <%= (query.compartiment === 'I') ? 'selected' : '' %>>I</option>
              <option value="J" <%= (query.compartiment === 'J') ? 'selected' : '' %>>J</option>
              <option value="K" <%= (query.compartiment === 'K') ? 'selected' : '' %>>K</option>
              <option value="L" <%= (query.compartiment === 'L') ? 'selected' : '' %>>L</option>
              <option value="M" <%= (query.compartiment === 'M') ? 'selected' : '' %>>M</option>
              <option value="N" <%= (query.compartiment === 'N') ? 'selected' : '' %>>N</option>
              <option value="O" <%= (query.compartiment === 'O') ? 'selected' : '' %>>O</option>
              <option value="P" <%= (query.compartiment === 'P') ? 'selected' : '' %>>P</option>
              <option value="1" <%= (query.compartiment === '1') ? 'selected' : '' %>>1</option>
              <option value="2" <%= (query.compartiment === '2') ? 'selected' : '' %>>2</option>
              <option value="3" <%= (query.compartiment === '3') ? 'selected' : '' %>>3</option>
              <option value="4" <%= (query.compartiment === '4') ? 'selected' : '' %>>4</option>
              <option value="5" <%= (query.compartiment === '5') ? 'selected' : '' %>>5</option>
              <option value="6" <%= (query.compartiment === '6') ? 'selected' : '' %>>6</option>
              <option value="7" <%= (query.compartiment === '7') ? 'selected' : '' %>>7</option>
              <option value="8" <%= (query.compartiment === '8') ? 'selected' : '' %>>8</option>
            </select>
          </div>

          <!-- Niveau -->
          <div class="col-md-2">
            <label for="niveau" class="form-label">Niveau</label>
            <select name="niveau" id="niveau" class="form-select">
              <option value="">Tous les niveaux</option>
              <option value="0" <%= (query.niveau === '0') ? 'selected' : '' %>>0</option>
              <option value="1" <%= (query.niveau === '1') ? 'selected' : '' %>>1</option>
              <option value="2" <%= (query.niveau === '2') ? 'selected' : '' %>>2</option>
              <option value="3" <%= (query.niveau === '3') ? 'selected' : '' %>>3</option>
              <option value="4" <%= (query.niveau === '4') ? 'selected' : '' %>>4</option>
              <option value="5" <%= (query.niveau === '5') ? 'selected' : '' %>>5</option>
              <option value="6" <%= (query.niveau === '6') ? 'selected' : '' %>>6</option>
            </select>
          </div>

          <!-- Position -->
          <div class="col-md-2">
            <label for="position" class="form-label">Position</label>
            <select name="position" id="position" class="form-select">
              <option value="">Toutes les positions</option>
              <option value="P1" <%= (query.position === 'P1') ? 'selected' : '' %>>P1</option>
              <option value="P2" <%= (query.position === 'P2') ? 'selected' : '' %>>P2</option>
              <option value="P3" <%= (query.position === 'P3') ? 'selected' : '' %>>P3</option>
            </select>
          </div>

          <!-- Prix min -->
          <div class="col-md-2">
            <label for="minPrix" class="form-label">Prix min</label>
            <input type="number" step="0.01" class="form-control" name="minPrix" id="minPrix"
                   placeholder="ex: 10" value="<%= query.minPrix || '' %>">
          </div>

          <!-- Prix max -->
          <div class="col-md-2">
            <label for="maxPrix" class="form-label">Prix max</label>
            <input type="number" step="0.01" class="form-control" name="maxPrix" id="maxPrix"
                   placeholder="ex: 100" value="<%= query.maxPrix || '' %>">
          </div>

          <!-- Qte min -->
          <div class="col-md-2">
            <label for="minQuantite" class="form-label">Qté min</label>
            <input type="number" class="form-control" name="minQuantite" id="minQuantite"
                   placeholder="ex: 1" value="<%= query.minQuantite || '' %>">
          </div>

          <!-- Qte max -->
          <div class="col-md-2">
            <label for="maxQuantite" class="form-label">Qté max</label>
            <input type="number" class="form-control" name="maxQuantite" id="maxQuantite"
                   placeholder="ex: 100" value="<%= query.maxQuantite || '' %>">
          </div>

          <!-- Bouton Rechercher -->
          <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">Rechercher</button>
          </div>

          <!-- Bouton Réinitialiser -->
          <div class="col-md-2 align-self-end">
            <a href="/materiel" class="btn btn-outline-secondary w-100">Réinitialiser</a>
          </div>

          <div class="col-md-2 align-self-end">
            <a href="/materiel/scanner" class="btn btn-info">Scanner QR/Code-barres</a>

          </div>
        </form>
      </div>
    </div>

    <!-- Boutons « communs » accessibles à tout utilisateur connecté -->
<div class="mb-3">
  <a href="/vehicule" class="btn btn-warning">Stock Véhicule</a>
          <a href="/chantier" class="btn btn-warning">Stock Chantier</a>
</div>

    <!-- Bloc Actions Admin (si role=admin) -->
    <% if (user && user.role === 'admin') { %>
      <div class="card mb-3">
        <div class="card-header">
          <strong>Actions Administrateur</strong>
        </div>
        <div class="card-body d-flex flex-wrap gap-2">
          <a href="/user/gestion" class="btn btn-info mb-3">Gérer les rôles</a>


          <a href="/materiel/ajouter" class="btn btn-success">Ajouter un matériel</a>
          <a href="/materiel/export/csv" class="btn btn-outline-success">Exporter CSV</a>
          <a href="/materiel/export/excel" class="btn btn-outline-success">Exporter Excel</a>
          <a href="/materiel/export/pdf" class="btn btn-outline-danger">Exporter PDF</a>
          <a href="/materiel/historique" class="btn btn-info">Voir l'historique</a>
         
          <a href="/bonLivraison/ajouter" class="btn btn-secondary">Ajouter Bon de Livraison</a>
          <a href="/bonLivraison" class="btn btn-secondary">Voir Bons de Livraison</a>
        </div>
      </div>
    <% } %>

    <!-- Bouton Déconnexion -->
    <div class="mb-4">
      <form action="/auth/logout" method="POST" style="display:inline;">
        <button type="submit" class="btn btn-secondary">Déconnexion</button>
      </form>
    </div>

    <!-- Tableau du stock -->
    <% const formatEmplacement = (materiel) => {
         const parts = [];
         if (materiel.rack) parts.push(materiel.rack);
         if (materiel.compartiment) parts.push(materiel.compartiment);
         if (materiel.niveau !== null && materiel.niveau !== undefined) parts.push(materiel.niveau);
         if (materiel.position) parts.push(materiel.position);
         return parts.join('-');
       };
    %>
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Liste du stock (Dépôt)</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-wrapper">
          <div class="stock-table-wrap">
            <table class="table table-bordered table-striped table-materiel align-middle table-stock">
            <thead>
              <tr>
                <th class="col-designation">Nom</th>
                <th class="col-reference">Référence</th>
                <th class="col-quantite">Quantité</th>
                <th class="col-categorie">Catégorie</th>
                <th class="col-emplacement">Emplacement stock</th>
                <th class="col-description">Description</th>
                <th class="col-photo">Photos</th>
                <th class="col-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% materiels.forEach(function(m) { %>
                <tr>
                  <td data-label="Nom" class="col-designation"><%= m.nom %></td>
                  <td data-label="Référence" class="col-reference"><%= m.reference %></td>
                  <td data-label="Quantité" class="col-quantite">
                    <%= formatQuantity(m.quantite) %>
                    <% if (Number(m.quantite) < 5) { %>
                      <span class="badge bg-danger ms-1">Stock faible</span>
                    <% } %>
                  </td>
                  <td data-label="Catégorie" class="col-categorie"><%= m.categorie %></td>
                  <td data-label="Emplacement stock" class="col-emplacement"><%= formatEmplacement(m) %></td>
                  <td data-label="Description" class="col-description"><%= m.description %></td>
                  <td data-label="Photos" class="col-photo cell-photo">
                      <% if (m.photos && m.photos.length > 0) { %>
                        <% m.photos.forEach(function(photo) { %>
                          <a href="/<%= photo.chemin.replace(/\\/g, '/') %>" target="_blank" class="me-1">
                            <img src="/<%= photo.chemin.replace(/\\/g, '/') %>" alt="Photo" style="width: 50px; height: auto;">
                          </a>
                        <% }) %>
                      <% } else { %>
                        <span class="text-muted">Aucune</span>
                      <% } %>
                  </td>
                  <td data-label="Actions" class="actions col-actions">
                    <div class="btn-wrap">
                      <button
                        type="button"
                        class="btn btn-outline-success btn-sm transfer-btn"
                        data-action="entree"
                        data-context-type="DEPOT"
                        data-context-chantier-id=""
                        data-materiel-id="<%= m.id %>"
                        data-materiel-name="<%= m.nom %>"
                      >
                        Entrée
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm transfer-btn"
                        data-action="sortie"
                        data-context-type="DEPOT"
                        data-context-chantier-id=""
                        data-materiel-id="<%= m.id %>"
                        data-materiel-name="<%= m.nom %>"
                      >
                        Sortie
                      </button>
                      <a href="/materiel/info/<%= m.id %>" class="btn btn-info btn-sm">Info</a>
                      <% if (user && user.role === 'admin') { %>
                        <a href="/materiel/editer/<%= m.id %>" class="btn btn-primary btn-sm">Modifier</a>
                        <a href="/materiel/modifier/<%= m.id %>" class="btn btn-warning btn-sm">Modifier Quantité</a>
                        <form action="/materiel/supprimer/<%= m.id %>" method="POST" onsubmit="return confirm('Voulez-vous vraiment supprimer ce matériel ?');">
                          <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- /container -->

  <% const transferChantiers = Array.isArray(chantiers) ? chantiers : []; %>
  <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="transferForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">
            <span id="transferModalAction">Transfert</span> - <span id="transferModalMateriel"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="contextType" id="transferContextType" value="DEPOT">
          <input type="hidden" name="contextChantierId" id="transferContextChantierId" value="">
          <input type="hidden" name="materielId" id="transferMaterielId" value="">
          <input type="hidden" name="materielName" id="transferMaterielName" value="">

          <div class="mb-3">
            <label for="transferTargetChantierId" class="form-label">Chantier</label>
            <select class="form-select" name="targetChantierId" id="transferTargetChantierId" required>
              <option value="">-- Sélectionner un chantier --</option>
              <% transferChantiers.forEach(function(c) { %>
                <option value="<%= c.id %>"><%= c.nom %><% if (c.localisation) { %> - <%= c.localisation %><% } %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label for="transferQuantite" class="form-label">Quantité</label>
            <input
              type="number"
              class="form-control"
              id="transferQuantite"
              name="quantite"
              min="0.01"
              step="0.01"
              required
            >
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Valider</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts Bootstrap -->
  <script src="/js/bootstrap.bundle.min.js"></script>

  <script nonce="<%= nonce %>">
    (function () {
      function setNavbarPadding() {
        var nb = document.querySelector('.navbar');
        if (!nb) return;
        var h = nb.offsetHeight || 64;
        document.documentElement.style.setProperty('--navbar-h', h + 'px');
      }

      window.addEventListener('load', setNavbarPadding);
      window.addEventListener('resize', setNavbarPadding);
      document.addEventListener('readystatechange', setNavbarPadding);
    })();
  </script>

  <!-- Script de bascule mode sombre -->
  <!-- Si vous avez une CSP stricte, n’oubliez pas le nonce. Exemple : <script nonce="<%= nonce %>"> -->
  <script nonce="<%= nonce %>">
    const toggleBtn = document.getElementById('toggleMode');
    const body = document.body;
    const navBar = document.querySelector('.navbar');

    const transferModalElement = document.getElementById('transferModal');
    const transferForm = document.getElementById('transferForm');
    const transferActionLabel = document.getElementById('transferModalAction');
    const transferMaterielLabel = document.getElementById('transferModalMateriel');
    const transferContextTypeInput = document.getElementById('transferContextType');
    const transferContextChantierInput = document.getElementById('transferContextChantierId');
    const transferMaterielIdInput = document.getElementById('transferMaterielId');
    const transferMaterielNameInput = document.getElementById('transferMaterielName');
    const transferTargetSelect = document.getElementById('transferTargetChantierId');
    const transferQuantityInput = document.getElementById('transferQuantite');
    let transferModalInstance = null;

    if (transferModalElement && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
      transferModalInstance = new window.bootstrap.Modal(transferModalElement);
    }

    document.querySelectorAll('.transfer-btn').forEach(button => {
      button.addEventListener('click', () => {
        if (!transferForm) {
          return;
        }

        transferForm.reset();
        const action = button.dataset.action || 'entree';
        transferForm.setAttribute('action', `/transferts/${action}`);
        if (transferContextTypeInput) {
          transferContextTypeInput.value = button.dataset.contextType || 'DEPOT';
        }
        if (transferContextChantierInput) {
          transferContextChantierInput.value = button.dataset.contextChantierId || '';
        }
        if (transferMaterielIdInput) {
          transferMaterielIdInput.value = button.dataset.materielId || '';
        }
        if (transferMaterielNameInput) {
          transferMaterielNameInput.value = button.dataset.materielName || '';
        }
        if (transferMaterielLabel) {
          transferMaterielLabel.textContent = button.dataset.materielName || '';
        }
        if (transferTargetSelect) {
          transferTargetSelect.value = '';
        }
        if (transferQuantityInput) {
          transferQuantityInput.value = '';
        }
        if (transferForm) {
          transferForm.dataset.transferAction = action;
        }
        if (transferActionLabel) {
          transferActionLabel.textContent = action === 'entree' ? 'Entrée' : 'Sortie';
        }

        if (transferModalInstance) {
          transferModalInstance.show();
        }
      });
    });

    if (transferForm) {
      transferForm.addEventListener('submit', (event) => {
        const action = transferForm.dataset.transferAction || 'entree';
        const actionLabel = action === 'entree' ? "l'entrée" : 'la sortie';
        const qtyValue = transferQuantityInput ? transferQuantityInput.value.trim() : '';
        const normalizedQty = qtyValue.replace(/,/g, '.');
        const qtyNumber = Number.parseFloat(normalizedQty);
        if (!Number.isFinite(qtyNumber) || qtyNumber <= 0) {
          event.preventDefault();
          return;
        }

        const materialName = transferMaterielNameInput ? transferMaterielNameInput.value : '';
        const selectedOption = transferTargetSelect && transferTargetSelect.selectedIndex >= 0
          ? transferTargetSelect.options[transferTargetSelect.selectedIndex]
          : null;
        const chantierLabel = selectedOption ? selectedOption.text.trim() : '';
        const confirmationMessage = `Confirmer ${actionLabel} de ${qtyValue || qtyNumber} unités\n` +
          `Matériel : ${materialName}\n` +
          `Chantier sélectionné : ${chantierLabel}`;
        if (!window.confirm(confirmationMessage)) {
          event.preventDefault();
        }
      });
    }

    toggleBtn.addEventListener('click', () => {
      body.classList.toggle('mode-sombre');
      if (body.classList.contains('mode-sombre')) {
        // On passe la navbar en mode sombre
        navBar.classList.remove('navbar-light', 'bg-light');
        navBar.classList.add('navbar-dark');
      } else {
        // On repasse la navbar en mode clair
        navBar.classList.remove('navbar-dark');
        navBar.classList.add('navbar-light', 'bg-light');
      }
    });
  </script>

  <script nonce="<%= nonce %>">
    (function () {
      const btn = document.getElementById('toggleCompact');
      if (!btn) return;
      const KEY = 'gs_compact_mobile';

      try {
        if (localStorage.getItem(KEY) === '1') {
          document.body.classList.add('compact-mobile');
        }
      } catch (_) {}

      btn.addEventListener('click', () => {
        document.body.classList.toggle('compact-mobile');
        try {
          localStorage.setItem(KEY, document.body.classList.contains('compact-mobile') ? '1' : '0');
        } catch (_) {}
      });
    })();
  </script>
</body>
</html>
