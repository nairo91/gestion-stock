<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Gestion de Stock</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Votre style CSS perso -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    @import url('https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.17/index.min.css');

    :root {
      --violet-dark: #0f021f;
      --violet-mid: #3b0a6a;
      --violet-light: #7b3ef3;
      --violet-accent: #a978ff;
      --card-bg: rgba(17, 6, 32, 0.78);
      --card-border: rgba(169, 120, 255, 0.22);
      --text-primary: #f7f4ff;
      --text-muted: rgba(247, 244, 255, 0.7);
      --shadow-lg: 0 22px 60px rgba(8, 2, 22, 0.55);
      --navbar-h: 64px;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, rgba(123, 62, 243, 0.32), transparent 48%),
                  radial-gradient(circle at bottom right, rgba(59, 10, 106, 0.55), transparent 52%),
                  linear-gradient(130deg, #080111 0%, #1a0533 40%, #2d0a52 100%);
      color: var(--text-primary);
      font-family: 'Inter', 'Segoe UI', sans-serif;
      margin: 0;
      padding-top: var(--navbar-h);
      backdrop-filter: blur(8px);
    }

    .navbar {
      background: linear-gradient(120deg, rgba(15, 2, 31, 0.92), rgba(59, 10, 106, 0.9));
      border-bottom: 1px solid rgba(169, 120, 255, 0.24);
      backdrop-filter: blur(16px);
      box-shadow: 0 14px 38px rgba(7, 1, 22, 0.45);
      padding-top: 0.35rem;
      padding-bottom: 0.35rem;
    }

    .navbar.fixed-top,
    .navbar.sticky-top {
      z-index: 1030;
    }

    .navbar .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      font-size: 1.1rem;
      letter-spacing: 0.05rem;
      color: #fff !important;
      text-transform: uppercase;
    }

    .navbar .navbar-toggler {
      border-color: rgba(255, 255, 255, 0.35);
    }

    .navbar .navbar-toggler-icon {
      filter: invert(1);
    }

    .navbar .btn {
      border-radius: 999px;
      border: 1px solid rgba(169, 120, 255, 0.35);
      color: #fff;
      background: rgba(123, 62, 243, 0.12);
      padding: 0.45rem 1.2rem;
      box-shadow: 0 12px 28px rgba(8, 2, 22, 0.35);
    }

    .navbar .btn:hover {
      background: rgba(169, 120, 255, 0.22);
      border-color: rgba(169, 120, 255, 0.55);
    }

    .top-shortcuts {
      position: fixed;
      top: calc(var(--navbar-h) + 1.4rem);
      right: 2.5rem;
      display: flex;
      gap: 0.75rem;
      z-index: 1020;
    }

    .top-shortcuts a {
      border-radius: 999px;
      border: 1px solid rgba(169, 120, 255, 0.28);
      background: rgba(12, 2, 28, 0.68);
      color: var(--text-primary);
      padding: 0.55rem 1.3rem;
      font-weight: 600;
      letter-spacing: 0.02rem;
      text-decoration: none;
      box-shadow: 0 16px 36px rgba(8, 2, 22, 0.45);
      transition: all 0.25s ease;
    }

    .top-shortcuts a:hover {
      background: rgba(123, 62, 243, 0.28);
      border-color: rgba(169, 120, 255, 0.55);
      transform: translateY(-2px);
    }

    .content-wrapper {
      margin-top: 3rem;
      margin-bottom: 4rem;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1.5rem;
      background: linear-gradient(135deg, rgba(123, 62, 243, 0.2), rgba(15, 2, 31, 0.7));
      border: 1px solid rgba(169, 120, 255, 0.28);
      border-radius: 22px;
      padding: 2.3rem;
      box-shadow: 0 22px 55px rgba(7, 1, 20, 0.52);
    }

    .page-header h1 {
      margin: 0;
      font-size: 2.65rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .page-header p {
      margin: 0.45rem 0 0;
      color: var(--text-muted);
      max-width: 520px;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .action-buttons .btn {
      border-radius: 14px;
      padding: 0.65rem 1.4rem;
      font-weight: 600;
      box-shadow: 0 16px 34px rgba(8, 2, 22, 0.35);
    }

    .btn {
      border-radius: 12px;
      font-weight: 600;
      letter-spacing: 0.01rem;
      border: 1px solid transparent;
      transition: all 0.25s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4f32ff, #7f56ff);
      border-color: rgba(169, 120, 255, 0.6);
      color: #fff;
    }

    .btn-primary:hover {
      box-shadow: 0 16px 36px rgba(79, 50, 255, 0.45);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.22);
      color: #fff;
    }

    .btn-secondary:hover {
      background: rgba(169, 120, 255, 0.18);
      border-color: rgba(169, 120, 255, 0.4);
    }

    .btn-info {
      background: linear-gradient(135deg, #4895ff, #7bc3ff);
      border: none;
      color: #061123;
    }

    .btn-info:hover {
      box-shadow: 0 16px 32px rgba(72, 149, 255, 0.35);
      color: #020b16;
    }

    .btn-success {
      background: linear-gradient(135deg, #16b88f, #5ee7c2);
      color: #03130f;
      border: none;
    }

    .btn-success:hover {
      box-shadow: 0 16px 32px rgba(22, 184, 143, 0.45);
      transform: translateY(-1px);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffa928, #ff7e2f);
      border: none;
      color: #2b0a08;
    }

    .btn-warning:hover {
      box-shadow: 0 16px 34px rgba(255, 121, 47, 0.4);
    }

    .btn-outline-secondary {
      background: rgba(12, 2, 28, 0.4);
      color: var(--text-primary);
      border-color: rgba(169, 120, 255, 0.4);
    }

    .btn-outline-secondary:hover {
      background: rgba(123, 62, 243, 0.2);
      color: #fff;
    }

    .btn-outline-success {
      color: #6be7c8;
      border-color: rgba(107, 231, 200, 0.6);
      background: transparent;
    }

    .btn-outline-success:hover {
      background: rgba(107, 231, 200, 0.2);
      color: #082019;
    }

    .btn-outline-danger {
      color: #ff7a92;
      border-color: rgba(255, 122, 146, 0.65);
      background: transparent;
    }

    .btn-outline-danger:hover {
      background: rgba(255, 90, 122, 0.24);
      color: #fff;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff5c7a, #ff3564);
      border: none;
    }

    .glass-card,
    .card {
      background: var(--card-bg);
      border-radius: 22px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-lg);
      color: var(--text-primary);
      backdrop-filter: blur(16px);
    }

    .card-header {
      background: transparent;
      border-bottom: 1px solid rgba(169, 120, 255, 0.22);
      color: var(--text-primary);
      padding: 1.3rem 1.8rem 1.1rem;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.03rem;
    }

    .card-body {
      padding: 1.8rem;
    }

    label.form-label {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .form-control,
    .form-select {
      border-radius: 12px;
      border: 1px solid rgba(169, 120, 255, 0.35);
      background: rgba(18, 8, 40, 0.75);
      color: var(--text-primary);
      box-shadow: inset 0 0 0 1px rgba(123, 62, 243, 0.08);
    }

    .form-control::placeholder {
      color: rgba(247, 244, 255, 0.55);
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(187, 170, 255, 0.65);
      box-shadow: 0 0 0 0.25rem rgba(123, 106, 255, 0.25);
      background: rgba(26, 12, 54, 0.88);
      color: #fff;
    }

    .form-select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 2.2rem;
      background-image: url('/images/arrow-dark.png');
      background-repeat: no-repeat;
      background-position: right 0.85rem center;
      background-size: 16px auto;
    }

    .form-select option {
      background: #160831;
      color: #fff;
    }

    .filters-card .btn {
      width: 100%;
    }

    .filters-card .btn-info,
    .filters-card .btn-primary,
    .filters-card .btn-outline-secondary {
      width: 100%;
      min-height: 44px;
    }

    .card-body.d-flex .btn {
      min-width: 200px;
    }

    .stock-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table {
      margin: 0;
      color: var(--text-primary);
      border-color: rgba(169, 120, 255, 0.22);
    }

    .table thead th {
      border-bottom: 1px solid rgba(169, 120, 255, 0.3);
      background: linear-gradient(135deg, rgba(59, 10, 106, 0.9), rgba(17, 6, 32, 0.9));
      color: #fff;
      letter-spacing: 0.05rem;
    }

    .table tbody tr {
      background: rgba(12, 5, 28, 0.85);
    }

    .table-striped > tbody > tr:nth-of-type(odd) {
      --bs-table-accent-bg: rgba(31, 14, 55, 0.75);
    }

    .table tbody tr:hover {
      background: rgba(82, 40, 130, 0.35);
    }

    .table th,
    .table td {
      border-color: rgba(169, 120, 255, 0.18);
      vertical-align: middle;
    }

    .table td .btn {
      border-radius: 10px;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      box-shadow: none;
    }

    .table td .btn.btn-outline-success,
    .table td .btn.btn-outline-danger {
      border-width: 1px;
    }

    .table td .btn-info,
    .table td .btn-primary,
    .table td .btn-warning,
    .table td .btn-danger {
      box-shadow: 0 8px 22px rgba(8, 2, 22, 0.4);
    }

    .badge.bg-danger {
      background: linear-gradient(135deg, #ff4d6d, #ff1e56);
      color: #fff;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
    }

    .text-muted {
      color: var(--text-muted) !important;
    }

    .table-stock {
      border-collapse: separate;
      table-layout: fixed;
      min-width: 1280px;
    }

    .table-stock th,
    .table-stock td {
      white-space: nowrap;
      line-height: 1.25;
    }

    .table-stock .col-description,
    .table-stock .col-emplacement,
    .table-stock .col-designation {
      white-space: normal;
    }

    .table-stock .btn {
      white-space: nowrap;
    }

    .table-stock th.col-actions,
    .table-stock td.col-actions {
      position: relative;
      overflow: visible;
      white-space: normal;
      z-index: 1;
    }

    .table-stock td .btn-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .table-stock .cell-photo img {
      display: block;
      max-width: 90px;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 6px 14px rgba(10, 2, 26, 0.45);
    }

    @media (max-width: 1400px) {
      .container,
      .container-lg,
      .container-xl,
      .container-xxl {
        max-width: 95%;
      }
    }

    @media (max-width: 1200px) {
      .table-stock th:last-child,
      .table-stock td:last-child {
        position: sticky;
        right: 0;
        background: rgba(22, 12, 45, 0.92);
        backdrop-filter: blur(6px);
        z-index: 2;
      }
    }

    @media (max-width: 992px) {
      .page-header {
        padding: 2rem;
      }

      .page-header h1 {
        font-size: 2.2rem;
      }

      .top-shortcuts {
        position: static;
        margin: 1.5rem 0 0;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .table-stock {
        min-width: 1250px;
      }

      .table-stock .col-designation {
        min-width: 220px !important;
      }

      .table-stock .col-emplacement {
        min-width: 140px !important;
      }

      .table-stock .col-actions {
        overflow: visible !important;
      }

      .action-buttons .btn {
        width: 100%;
      }
    }

    /* === MODE COMPACT+ (mobile : tout tenir sans scroller) === */
    body.compact-mobile .table-stock {
      min-width: 100% !important;
      width: 100%;
      table-layout: fixed;
      font-size: 12px;
    }

    body.compact-mobile .table-stock th,
    body.compact-mobile .table-stock td {
      padding: 6px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.25;
    }

    body.compact-mobile .table-stock .cell-photo img {
      max-width: 44px;
    }

    body.compact-mobile .table-materiel thead th {
      font-size: 11px;
      padding: 8px 6px;
    }

    body.compact-mobile .table-stock th:nth-child(3),
    body.compact-mobile .table-stock td:nth-child(3) {
      min-width: 90px;
    }

    body.compact-mobile .table-stock .col-designation,
    body.compact-mobile .table-stock .col-emplacement {
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
      word-break: break-word;
      hyphens: auto;
    }

    body.compact-mobile .table-stock .col-designation {
      min-width: 160px;
    }

    body.compact-mobile .table-stock .col-emplacement {
      min-width: 120px;
    }

    body.compact-mobile .table-stock th:nth-child(5),
    body.compact-mobile .table-stock td:nth-child(5) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock th:nth-child(6),
    body.compact-mobile .table-stock td:nth-child(6) {
      min-width: 80px;
    }

    body.compact-mobile .table-stock th:nth-child(7),
    body.compact-mobile .table-stock td:nth-child(7) {
      min-width: 100px;
    }

    body.compact-mobile .table-stock th:nth-child(8),
    body.compact-mobile .table-stock td:nth-child(8) {
      min-width: 70px;
    }

    body.compact-mobile .table-stock td .btn-group,
    body.compact-mobile .table-stock td .btn-wrap {
      gap: 4px;
    }

    body.compact-mobile .table-stock td .btn {
      padding: 4px 6px;
      font-size: 12px;
    }

    body.compact-mobile .table-stock th.col-actions,
    body.compact-mobile .table-stock td.col-actions {
      overflow: visible !important;
      white-space: normal !important;
    }

    .modal-content {
      background: rgba(12, 4, 28, 0.95);
      border: 1px solid rgba(169, 120, 255, 0.35);
      box-shadow: 0 18px 38px rgba(8, 2, 22, 0.5);
      color: var(--text-primary);
      backdrop-filter: blur(18px);
    }

    .modal-header,
    .modal-footer {
      border-color: rgba(169, 120, 255, 0.18);
    }

    .modal-content .form-control,
    .modal-content .form-select {
      background: rgba(18, 8, 40, 0.8);
      border: 1px solid rgba(169, 120, 255, 0.4);
      color: var(--text-primary);
    }

    .modal-content .form-control:focus,
    .modal-content .form-select:focus {
      border-color: rgba(187, 170, 255, 0.65);
      box-shadow: 0 0 0 0.25rem rgba(123, 106, 255, 0.25);
    }

    body.mode-sombre {
      background: #05010b;
      color: var(--text-primary);
    }

    body.mode-sombre .navbar {
      background: linear-gradient(120deg, rgba(5, 0, 12, 0.95), rgba(21, 2, 45, 0.95));
    }

    body.mode-sombre .card,
    body.mode-sombre .glass-card {
      background: rgba(10, 2, 24, 0.88);
    }

    body.mode-sombre .table thead th {
      background: linear-gradient(135deg, rgba(21, 2, 45, 0.95), rgba(59, 10, 106, 0.95));
    }

    body.mode-sombre .form-select {
      background-image: url('/images/arrow-dark.png');
    }
  </style>
</head>

<body>
  <% const formatQuantity = value => Number(value ?? 0).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); %>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/materiel">Gestion de Stock Dépôt</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Basculer la navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarContent">
        <ul class="navbar-nav ms-auto align-items-center gap-2">
          <li class="nav-item">
            <button id="toggleCompact" class="btn btn-outline-secondary">Compact+</button>
          </li>
          <li class="nav-item">
            <button id="toggleMode" class="btn btn-outline-secondary">Mode sombre</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="top-shortcuts">
    <a href="https://receptionbr.onrender.com/selection.html">Gestion Tâches</a>
    <a href="https://receptionbr.onrender.com/">Réception</a>
  </div>

  <div class="container content-wrapper">
    <div class="page-header">
      <div>
        <h1>Inventaire dépôt</h1>
        <p>Supervisez l'ensemble du stock du dépôt avec une interface violette élégante, cohérente avec notre identité visuelle.</p>
      </div>
      <div class="action-buttons">
        <a href="/vehicule" class="btn btn-warning">Stock Véhicule</a>
        <a href="/chantier" class="btn btn-warning">Stock Chantier</a>
      </div>
    </div>

    <div class="card glass-card mb-4 filters-card">
      <div class="card-header">
        <strong>Filtrer le stock</strong>
      </div>
      <div class="card-body">
        <form class="row g-3" method="GET" action="/materiel">
          <!-- Nom -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="nom" class="form-label">Nom</label>
            <input type="text" class="form-control" name="nom" id="nom"
                   placeholder="ex: Bois" value="<%= query.nom || '' %>">
          </div>

           <!-- Référence  ✅ NOUVEAU -->
           <div class="col-12 col-sm-6 col-lg-2">
            <label for="reference" class="form-label">Référence</label>
            <input  type="text" class="form-control" id="reference" name="reference"
                    placeholder="ex: RFHRU658DG" value="<%= query.reference || '' %>">
          </div>

          <!-- Catégorie -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="categorie" class="form-label">Catégorie</label>
            <select name="categorie" id="categorie" class="form-select">
              <option value="">Toutes catégories</option>
              <option value="Électricité" <%= (query.categorie === 'Électricité') ? 'selected' : '' %>>Électricité</option>
              <option value="Plomberie" <%= (query.categorie === 'Plomberie') ? 'selected' : '' %>>Plomberie</option>
              <option value="CVC" <%= (query.categorie === 'CVC') ? 'selected' : '' %>>CVC</option>
              <option value="Plâtrerie" <%= (query.categorie === 'Plâtrerie') ? 'selected' : '' %>>Plâtrerie</option>
              <option value="Menuiserie INT" <%= (query.categorie === 'Menuiserie INT') ? 'selected' : '' %>>Menuiserie INT</option>
              <option value="Menuiserie EXT" <%= (query.categorie === 'Menuiserie EXT') ? 'selected' : '' %>>Menuiserie EXT</option>
              <option value="Maçonnerie" <%= (query.categorie === 'Maçonnerie') ? 'selected' : '' %>>Maçonnerie</option>
              <option value="Revêtement de sol" <%= (query.categorie === 'Revêtement de sol') ? 'selected' : '' %>>Revêtement de sol</option>
              <option value="Revêtement mural" <%= (query.categorie === 'Revêtement mural') ? 'selected' : '' %>>Revêtement mural</option>
              <option value="Quincaillerie" <%= (query.categorie === 'Quincaillerie') ? 'selected' : '' %>>Quincaillerie</option>
              <option value="Fixations (visseries, colles…)" <%= (query.categorie === 'Fixations (visseries, colles…)') ? 'selected' : '' %>>Fixations (visseries, colles…)</option>
              <option value="Outillage Électroportatif" <%= (query.categorie === 'Outillage Électroportatif') ? 'selected' : '' %>>Outillage Électroportatif</option>
              <option value="Autres" <%= (query.categorie === 'Autres') ? 'selected' : '' %>>Autres</option>
            </select>
          </div>

          <!-- Rack -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="rack" class="form-label">Rack</label>
            <select name="rack" id="rack" class="form-select">
              <option value="">Tous les racks</option>
              <option value="RM1" <%= (query.rack === 'RM1') ? 'selected' : '' %>>RM1</option>
              <option value="RM2" <%= (query.rack === 'RM2') ? 'selected' : '' %>>RM2</option>
              <option value="RM3" <%= (query.rack === 'RM3') ? 'selected' : '' %>>RM3</option>
              <option value="RM4" <%= (query.rack === 'RM4') ? 'selected' : '' %>>RM4</option>
              <option value="RM5" <%= (query.rack === 'RM5') ? 'selected' : '' %>>RM5</option>
              <option value="RM6" <%= (query.rack === 'RM6') ? 'selected' : '' %>>RM6</option>
              <option value="RM7" <%= (query.rack === 'RM7') ? 'selected' : '' %>>RM7</option>
              <option value="RM8" <%= (query.rack === 'RM8') ? 'selected' : '' %>>RM8</option>
              <option value="RM9" <%= (query.rack === 'RM9') ? 'selected' : '' %>>RM9</option>
              <option value="RM10" <%= (query.rack === 'RM10') ? 'selected' : '' %>>RM10</option>
              <option value="GL" <%= (query.rack === 'GL') ? 'selected' : '' %>>GL</option>
              <option value="RK" <%= (query.rack === 'RK') ? 'selected' : '' %>>RK</option>
              <option value="ZS" <%= (query.rack === 'ZS') ? 'selected' : '' %>>Zone Sécu (ZS)</option>
              <option value="Mezza" <%= (query.rack === 'Mezza') ? 'selected' : '' %>>Mezza</option>
              <option value="Contenaire" <%= (query.rack === 'Contenaire') ? 'selected' : '' %>>Contenaire</option>
              <option value="A"   <%= (query.rack === 'A')   ? 'selected' : '' %>>A</option>
              <option value="B"   <%= (query.rack === 'B')   ? 'selected' : '' %>>B</option>
              <option value="C"   <%= (query.rack === 'C')   ? 'selected' : '' %>>C</option>
            </select>
          </div>

          <!-- Compartiment -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="compartiment" class="form-label">Compartiment</label>
            <select name="compartiment" id="compartiment" class="form-select">
              <option value="">Tous les compartiments</option>
              <option value="A" <%= (query.compartiment === 'A') ? 'selected' : '' %>>A</option>
              <option value="B" <%= (query.compartiment === 'B') ? 'selected' : '' %>>B</option>
              <option value="C" <%= (query.compartiment === 'C') ? 'selected' : '' %>>C</option>
              <option value="D" <%= (query.compartiment === 'D') ? 'selected' : '' %>>D</option>
              <option value="E" <%= (query.compartiment === 'E') ? 'selected' : '' %>>E</option>
              <option value="F" <%= (query.compartiment === 'F') ? 'selected' : '' %>>F</option>
              <option value="G" <%= (query.compartiment === 'G') ? 'selected' : '' %>>G</option>
              <option value="H" <%= (query.compartiment === 'H') ? 'selected' : '' %>>H</option>
              <option value="I" <%= (query.compartiment === 'I') ? 'selected' : '' %>>I</option>
              <option value="J" <%= (query.compartiment === 'J') ? 'selected' : '' %>>J</option>
              <option value="K" <%= (query.compartiment === 'K') ? 'selected' : '' %>>K</option>
              <option value="L" <%= (query.compartiment === 'L') ? 'selected' : '' %>>L</option>
              <option value="M" <%= (query.compartiment === 'M') ? 'selected' : '' %>>M</option>
              <option value="N" <%= (query.compartiment === 'N') ? 'selected' : '' %>>N</option>
              <option value="O" <%= (query.compartiment === 'O') ? 'selected' : '' %>>O</option>
              <option value="P" <%= (query.compartiment === 'P') ? 'selected' : '' %>>P</option>
              <option value="1" <%= (query.compartiment === '1') ? 'selected' : '' %>>1</option>
              <option value="2" <%= (query.compartiment === '2') ? 'selected' : '' %>>2</option>
              <option value="3" <%= (query.compartiment === '3') ? 'selected' : '' %>>3</option>
              <option value="4" <%= (query.compartiment === '4') ? 'selected' : '' %>>4</option>
              <option value="5" <%= (query.compartiment === '5') ? 'selected' : '' %>>5</option>
              <option value="6" <%= (query.compartiment === '6') ? 'selected' : '' %>>6</option>
              <option value="7" <%= (query.compartiment === '7') ? 'selected' : '' %>>7</option>
              <option value="8" <%= (query.compartiment === '8') ? 'selected' : '' %>>8</option>
            </select>
          </div>

          <!-- Niveau -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="niveau" class="form-label">Niveau</label>
            <select name="niveau" id="niveau" class="form-select">
              <option value="">Tous les niveaux</option>
              <option value="0" <%= (query.niveau === '0') ? 'selected' : '' %>>0</option>
              <option value="1" <%= (query.niveau === '1') ? 'selected' : '' %>>1</option>
              <option value="2" <%= (query.niveau === '2') ? 'selected' : '' %>>2</option>
              <option value="3" <%= (query.niveau === '3') ? 'selected' : '' %>>3</option>
              <option value="4" <%= (query.niveau === '4') ? 'selected' : '' %>>4</option>
              <option value="5" <%= (query.niveau === '5') ? 'selected' : '' %>>5</option>
              <option value="6" <%= (query.niveau === '6') ? 'selected' : '' %>>6</option>
            </select>
          </div>

          <!-- Position -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="position" class="form-label">Position</label>
            <select name="position" id="position" class="form-select">
              <option value="">Toutes les positions</option>
              <option value="P1" <%= (query.position === 'P1') ? 'selected' : '' %>>P1</option>
              <option value="P2" <%= (query.position === 'P2') ? 'selected' : '' %>>P2</option>
              <option value="P3" <%= (query.position === 'P3') ? 'selected' : '' %>>P3</option>
            </select>
          </div>

          <!-- Prix min -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="minPrix" class="form-label">Prix min</label>
            <input type="number" step="0.01" class="form-control" name="minPrix" id="minPrix"
                   placeholder="ex: 10" value="<%= query.minPrix || '' %>">
          </div>

          <!-- Prix max -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="maxPrix" class="form-label">Prix max</label>
            <input type="number" step="0.01" class="form-control" name="maxPrix" id="maxPrix"
                   placeholder="ex: 100" value="<%= query.maxPrix || '' %>">
          </div>

          <!-- Qte min -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="minQuantite" class="form-label">Qté min</label>
            <input type="number" class="form-control" name="minQuantite" id="minQuantite"
                   placeholder="ex: 1" value="<%= query.minQuantite || '' %>">
          </div>

          <!-- Qte max -->
          <div class="col-12 col-sm-6 col-lg-2">
            <label for="maxQuantite" class="form-label">Qté max</label>
            <input type="number" class="form-control" name="maxQuantite" id="maxQuantite"
                   placeholder="ex: 100" value="<%= query.maxQuantite || '' %>">
          </div>

          <!-- Bouton Rechercher -->
          <div class="col-12 col-sm-6 col-lg-2 align-self-end d-grid">
            <button type="submit" class="btn btn-primary">Rechercher</button>
          </div>

          <!-- Bouton Réinitialiser -->
          <div class="col-12 col-sm-6 col-lg-2 align-self-end d-grid">
            <a href="/materiel" class="btn btn-outline-secondary">Réinitialiser</a>
          </div>

          <div class="col-12 col-sm-6 col-lg-2 align-self-end d-grid">
            <a href="/materiel/scanner" class="btn btn-info">Scanner QR/Code-barres</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Bloc Actions Admin (si role=admin) -->
    <% if (user && user.role === 'admin') { %>
      <div class="card glass-card mb-4">
        <div class="card-header">
          <strong>Actions administrateur</strong>
        </div>
        <div class="card-body d-flex flex-wrap gap-3">
          <a href="/user/gestion" class="btn btn-info">Gérer les rôles</a>
          <a href="/materiel/ajouter" class="btn btn-success">Ajouter un matériel</a>
          <a href="/materiel/export/csv" class="btn btn-outline-success">Exporter CSV</a>
          <a href="/materiel/export/excel" class="btn btn-outline-success">Exporter Excel</a>
          <a href="/materiel/export/pdf" class="btn btn-outline-danger">Exporter PDF</a>
          <a href="/materiel/historique" class="btn btn-info">Voir l'historique</a>
          <a href="/bonLivraison/ajouter" class="btn btn-secondary">Ajouter Bon de Livraison</a>
          <a href="/bonLivraison" class="btn btn-secondary">Voir Bons de Livraison</a>
        </div>
      </div>
    <% } %>

    <!-- Bouton Déconnexion -->
    <div class="card glass-card mb-4 p-3">
      <form action="/auth/logout" method="POST" class="d-flex flex-wrap align-items-center gap-3 mb-0">
        <span class="text-muted">Sécurisez vos données en vous déconnectant après utilisation.</span>
        <button type="submit" class="btn btn-secondary">Déconnexion</button>
      </form>
    </div>

    <!-- Tableau du stock -->
    <% const formatEmplacement = (materiel) => {
         const parts = [];
         if (materiel.rack) parts.push(materiel.rack);
         if (materiel.compartiment) parts.push(materiel.compartiment);
         if (materiel.niveau !== null && materiel.niveau !== undefined) parts.push(materiel.niveau);
         if (materiel.position) parts.push(materiel.position);
         return parts.join('-');
       };
    %>
    <div class="card glass-card">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h5 class="mb-0">Liste du stock (Dépôt)</h5>
        <small class="text-muted">Visualisez, transférez et suivez vos matériels en temps réel.</small>
      </div>
      <div class="card-body p-0">
        <div class="table-wrapper">
          <div class="stock-table-wrap">
            <table class="table table-bordered table-striped table-materiel align-middle table-stock">
            <thead>
              <tr>
                <th class="col-designation">Nom</th>
                <th class="col-reference">Référence</th>
                <th class="col-quantite">Quantité</th>
                <th class="col-categorie">Catégorie</th>
                <th class="col-emplacement">Emplacement stock</th>
                <th class="col-description">Description</th>
                <th class="col-photo">Photos</th>
                <th class="col-actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% materiels.forEach(function(m) { %>
                <tr>
                  <td data-label="Nom" class="col-designation"><%= m.nom %></td>
                  <td data-label="Référence" class="col-reference"><%= m.reference %></td>
                  <td data-label="Quantité" class="col-quantite">
                    <%= formatQuantity(m.quantite) %>
                    <% if (Number(m.quantite) < 5) { %>
                      <span class="badge bg-danger ms-1">Stock faible</span>
                    <% } %>
                  </td>
                  <td data-label="Catégorie" class="col-categorie"><%= m.categorie %></td>
                  <td data-label="Emplacement stock" class="col-emplacement"><%= formatEmplacement(m) %></td>
                  <td data-label="Description" class="col-description"><%= m.description %></td>
                  <td data-label="Photos" class="col-photo cell-photo">
                      <% if (m.photos && m.photos.length > 0) { %>
                        <% m.photos.forEach(function(photo) { %>
                          <a href="/<%= photo.chemin.replace(/\\/g, '/') %>" target="_blank" class="me-1">
                            <img src="/<%= photo.chemin.replace(/\\/g, '/') %>" alt="Photo" style="width: 50px; height: auto;">
                          </a>
                        <% }) %>
                      <% } else { %>
                        <span class="text-muted">Aucune</span>
                      <% } %>
                  </td>
                  <td data-label="Actions" class="actions col-actions">
                    <div class="btn-wrap">
                      <button
                        type="button"
                        class="btn btn-outline-success btn-sm transfer-btn"
                        data-action="entree"
                        data-context-type="DEPOT"
                        data-context-chantier-id=""
                        data-materiel-id="<%= m.id %>"
                        data-materiel-name="<%= m.nom %>"
                      >
                        Entrée
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger btn-sm transfer-btn"
                        data-action="sortie"
                        data-context-type="DEPOT"
                        data-context-chantier-id=""
                        data-materiel-id="<%= m.id %>"
                        data-materiel-name="<%= m.nom %>"
                      >
                        Sortie
                      </button>
                      <a href="/materiel/info/<%= m.id %>" class="btn btn-info btn-sm">Info</a>
                      <% if (user && user.role === 'admin') { %>
                        <a href="/materiel/editer/<%= m.id %>" class="btn btn-primary btn-sm">Modifier</a>
                        <a href="/materiel/modifier/<%= m.id %>" class="btn btn-warning btn-sm">Modifier Quantité</a>
                        <form action="/materiel/supprimer/<%= m.id %>" method="POST" onsubmit="return confirm('Voulez-vous vraiment supprimer ce matériel ?');">
                          <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- /container -->

  <% const transferChantiers = Array.isArray(chantiers) ? chantiers : []; %>
  <div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="transferForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">
            <span id="transferModalAction">Transfert</span> - <span id="transferModalMateriel"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="contextType" id="transferContextType" value="DEPOT">
          <input type="hidden" name="contextChantierId" id="transferContextChantierId" value="">
          <input type="hidden" name="materielId" id="transferMaterielId" value="">
          <input type="hidden" name="materielName" id="transferMaterielName" value="">

          <div class="mb-3">
            <label for="transferTargetChantierId" class="form-label">Chantier</label>
            <select class="form-select" name="targetChantierId" id="transferTargetChantierId" required>
              <option value="">-- Sélectionner un chantier --</option>
              <% transferChantiers.forEach(function(c) { %>
                <option value="<%= c.id %>"><%= c.nom %><% if (c.localisation) { %> - <%= c.localisation %><% } %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label for="transferQuantite" class="form-label">Quantité</label>
            <input
              type="number"
              class="form-control"
              id="transferQuantite"
              name="quantite"
              min="0.01"
              step="0.01"
              required
            >
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Valider</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts Bootstrap -->
  <script src="/js/bootstrap.bundle.min.js"></script>

  <script nonce="<%= nonce %>">
    (function () {
      function setNavbarPadding() {
        var nb = document.querySelector('.navbar');
        if (!nb) return;
        var h = nb.offsetHeight || 64;
        document.documentElement.style.setProperty('--navbar-h', h + 'px');
      }

      window.addEventListener('load', setNavbarPadding);
      window.addEventListener('resize', setNavbarPadding);
      document.addEventListener('readystatechange', setNavbarPadding);
    })();
  </script>

  <!-- Script de bascule mode sombre -->
  <!-- Si vous avez une CSP stricte, n’oubliez pas le nonce. Exemple : <script nonce="<%= nonce %>"> -->
  <script nonce="<%= nonce %>">
    const toggleBtn = document.getElementById('toggleMode');
    const body = document.body;
    const navBar = document.querySelector('.navbar');

    const transferModalElement = document.getElementById('transferModal');
    const transferForm = document.getElementById('transferForm');
    const transferActionLabel = document.getElementById('transferModalAction');
    const transferMaterielLabel = document.getElementById('transferModalMateriel');
    const transferContextTypeInput = document.getElementById('transferContextType');
    const transferContextChantierInput = document.getElementById('transferContextChantierId');
    const transferMaterielIdInput = document.getElementById('transferMaterielId');
    const transferMaterielNameInput = document.getElementById('transferMaterielName');
    const transferTargetSelect = document.getElementById('transferTargetChantierId');
    const transferQuantityInput = document.getElementById('transferQuantite');
    let transferModalInstance = null;

    if (transferModalElement && window.bootstrap && typeof window.bootstrap.Modal === 'function') {
      transferModalInstance = new window.bootstrap.Modal(transferModalElement);
    }

    document.querySelectorAll('.transfer-btn').forEach(button => {
      button.addEventListener('click', () => {
        if (!transferForm) {
          return;
        }

        transferForm.reset();
        const action = button.dataset.action || 'entree';
        transferForm.setAttribute('action', `/transferts/${action}`);
        if (transferContextTypeInput) {
          transferContextTypeInput.value = button.dataset.contextType || 'DEPOT';
        }
        if (transferContextChantierInput) {
          transferContextChantierInput.value = button.dataset.contextChantierId || '';
        }
        if (transferMaterielIdInput) {
          transferMaterielIdInput.value = button.dataset.materielId || '';
        }
        if (transferMaterielNameInput) {
          transferMaterielNameInput.value = button.dataset.materielName || '';
        }
        if (transferMaterielLabel) {
          transferMaterielLabel.textContent = button.dataset.materielName || '';
        }
        if (transferTargetSelect) {
          transferTargetSelect.value = '';
        }
        if (transferQuantityInput) {
          transferQuantityInput.value = '';
        }
        if (transferForm) {
          transferForm.dataset.transferAction = action;
        }
        if (transferActionLabel) {
          transferActionLabel.textContent = action === 'entree' ? 'Entrée' : 'Sortie';
        }

        if (transferModalInstance) {
          transferModalInstance.show();
        }
      });
    });

    if (transferForm) {
      transferForm.addEventListener('submit', (event) => {
        const action = transferForm.dataset.transferAction || 'entree';
        const actionLabel = action === 'entree' ? "l'entrée" : 'la sortie';
        const qtyValue = transferQuantityInput ? transferQuantityInput.value.trim() : '';
        const normalizedQty = qtyValue.replace(/,/g, '.');
        const qtyNumber = Number.parseFloat(normalizedQty);
        if (!Number.isFinite(qtyNumber) || qtyNumber <= 0) {
          event.preventDefault();
          return;
        }

        const materialName = transferMaterielNameInput ? transferMaterielNameInput.value : '';
        const selectedOption = transferTargetSelect && transferTargetSelect.selectedIndex >= 0
          ? transferTargetSelect.options[transferTargetSelect.selectedIndex]
          : null;
        const chantierLabel = selectedOption ? selectedOption.text.trim() : '';
        const confirmationMessage = `Confirmer ${actionLabel} de ${qtyValue || qtyNumber} unités\n` +
          `Matériel : ${materialName}\n` +
          `Chantier sélectionné : ${chantierLabel}`;
        if (!window.confirm(confirmationMessage)) {
          event.preventDefault();
        }
      });
    }

    if (toggleBtn && navBar) {
      const updateThemeToggle = () => {
        if (body.classList.contains('mode-sombre')) {
          navBar.classList.add('navbar-dark');
          toggleBtn.textContent = 'Mode clair';
        } else {
          navBar.classList.remove('navbar-dark');
          toggleBtn.textContent = 'Mode sombre';
        }
      };

      updateThemeToggle();

      toggleBtn.addEventListener('click', () => {
        body.classList.toggle('mode-sombre');
        updateThemeToggle();
      });
    }
  </script>

  <script nonce="<%= nonce %>">
    (function () {
      const btn = document.getElementById('toggleCompact');
      if (!btn) return;
      const KEY = 'gs_compact_mobile';

      try {
        if (localStorage.getItem(KEY) === '1') {
          document.body.classList.add('compact-mobile');
        }
      } catch (_) {}

      btn.addEventListener('click', () => {
        document.body.classList.toggle('compact-mobile');
        try {
          localStorage.setItem(KEY, document.body.classList.contains('compact-mobile') ? '1' : '0');
        } catch (_) {}
      });
    })();
  </script>
</body>
</html>
