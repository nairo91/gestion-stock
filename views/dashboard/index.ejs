<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard â€“ Gestion de stock</title>

  <!-- Ton CSS global habituel -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    /* â€”â€”â€” Layout global dashboard â€”â€”â€” */
    .dashboard-page {
      min-height: 100vh;
      background: #f3f4f8;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #1f2933;
    }

    .dashboard-shell {
      max-width: 1240px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 2.5rem;
    }

    /* â€”â€”â€” Header â€”â€”â€” */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }

    .dashboard-title-block h1 {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: .02em;
      margin: 0 0 .25rem;
    }

    .dashboard-title-block p {
      margin: 0;
      color: #6b7280;
      font-size: .9rem;
    }

    .dashboard-user {
      font-size: .85rem;
      color: #9ca3af;
    }

    /* â€”â€”â€” Barre dâ€™actions â€”â€”â€” */
    .dashboard-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: 1.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .45rem .9rem;
      border-radius: .55rem;
      font-size: .85rem;
      font-weight: 500;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all .15s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, .25);
      border-color: rgba(37, 99, 235, 0.9);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, .28);
    }

    .btn-ghost {
      background: #fff;
      color: #2563eb;
      border-color: #d1d5db;
    }
    .btn-ghost:hover {
      background: #eff6ff;
      border-color: #2563eb;
    }

    /* â€”â€”â€” Grille de cartes â€”â€”â€” */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: .9rem;
      padding: 1rem 1.1rem 1.15rem;
      box-shadow: 0 12px 26px rgba(15, 23, 42, .05);
      border: 1px solid #e5e7eb;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: .65rem;
    }

    .card-title {
      font-size: .95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
    }

    .card-subtitle {
      font-size: .75rem;
      color: #9ca3af;
    }

    /* â€”â€”â€” Badges / pills â€”â€”â€” */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      font-size: .72rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      font-weight: 500;
    }

    .pill-danger {
      background: #ffe4e6;
      color: #b91c1c;
    }

    .pill-ok {
      background: #dcfce7;
      color: #15803d;
    }

    /* â€”â€”â€” Tableaux compacts â€”â€”â€” */
    .table-compact {
      width: 100%;
      border-collapse: collapse;
      font-size: .8rem;
    }
    .table-compact th,
    .table-compact td {
      border-bottom: 1px solid #f1f2f6;
      padding: .3rem .2rem;
      text-align: left;
    }
    .table-compact th {
      font-weight: 600;
      color: #6b7280;
      background: #f9fafb;
    }
    .table-compact a {
      color: #2563eb;
      text-decoration: none;
    }
    .table-compact a:hover {
      text-decoration: underline;
    }

    .muted {
      color: #9ca3af;
      font-size: .8rem;
    }

    /* â€”â€”â€” Section graphique â€”â€”â€” */
    .card-chart {
      margin-bottom: 1.25rem;
    }
    #mouvementsChart {
      max-width: 100%;
      height: 280px;
    }

    /* â€”â€”â€” Grille secondaire â€”â€”â€” */
    .dashboard-grid-secondary {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 900px) {
      .dashboard-grid-secondary {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* â€”â€”â€” Derniers mouvements â€”â€”â€” */
    .history-table-wrapper {
      margin-top: .5rem;
      overflow-x: auto;
    }

    /* â€”â€”â€” Liens boutons dans cartes â€”â€”â€” */
    .card-actions {
      margin-top: .7rem;
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
    }

  </style>
</head>
<body class="dashboard-page">
  <div class="dashboard-shell">
    <!-- HEADER -->
    <header class="dashboard-header">
      <div class="dashboard-title-block">
        <h1>Dashboard stock & chantiers</h1>
        <p>Vue synthÃ©tique de lâ€™activitÃ© du dÃ©pÃ´t, des vÃ©hicules et des chantiers.</p>
      </div>
      <div class="dashboard-user">
        Bonjour <strong><%= user && user.nom ? user.nom : 'utilisateur' %></strong>
      </div>
    </header>

    <!-- ACTIONS -->
    <div class="dashboard-actions">
      <a href="/scan" class="btn btn-primary">
        ğŸ“· <span>Scan QR / code-barres</span>
      </a>
      <a href="/bonLivraison/ajouter" class="btn btn-ghost">
        â• <span>Bon de livraison</span>
      </a>
      <a href="/transferts/entree" class="btn btn-ghost">
        ğŸ” <span>Transfert (entrÃ©e)</span>
      </a>
      <a href="/transferts/sortie" class="btn btn-ghost">
        ğŸ” <span>Transfert (sortie)</span>
      </a>
    </div>

    <!-- LIGNE 1 : alertes / dÃ©pÃ´t / vÃ©hicules -->
    <section class="dashboard-grid">
      <!-- Alertes -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">
            <span>ğŸ”” Alertes</span>
          </div>
          <div class="card-subtitle">
            Stock critique & anomalies
          </div>
        </div>

        <% if (lowStock && lowStock.length > 0) { %>
          <p>
            <span class="pill pill-danger">
              <strong><%= lowStock.length %></strong> matÃ©riel(s) &lt; <%= lowStockThreshold %>
            </span>
          </p>
          <table class="table-compact">
            <thead>
              <tr>
                <th>Nom</th>
                <th>QtÃ©</th>
              </tr>
            </thead>
            <tbody>
              <% lowStock.forEach(m => { %>
                <tr>
                  <td>
                    <a href="/materiel/info/<%= m.id %>">
                      <%= m.nom %>
                    </a>
                  </td>
                  <td><%= m.quantite %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else { %>
          <p class="muted">
            <span class="pill pill-ok">Aucune alerte de stock critique</span>
          </p>
        <% } %>
      </article>

      <!-- Stock dÃ©pÃ´t -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">
            ğŸ“¦ Stock dÃ©pÃ´t
          </div>
          <div class="card-subtitle">
            Vue globale
          </div>
        </div>
        <p>
          <strong><%= depotStats.count %></strong> lignes de matÃ©riel en dÃ©pÃ´t<br />
          Valeur estimÃ©e :
          <strong><%= depotStats.value.toFixed(2) %> â‚¬</strong>
        </p>
        <div class="card-actions">
          <a href="/materiel" class="btn btn-ghost">Voir le dÃ©pÃ´t</a>
          <a href="/materiel/export/excel" class="btn btn-ghost">Export Excel</a>
          <a href="/materiel/export/pdf" class="btn btn-ghost">Export PDF</a>
        </div>
      </article>

      <!-- VÃ©hicules -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">
            ğŸšš VÃ©hicules
          </div>
          <div class="card-subtitle">
            Stock embarquÃ©
          </div>
        </div>
        <p>
          <strong><%= vehiculeStats.count %></strong> vÃ©hicule(s) suivis<br />
          <strong><%= vehiculeStats.materiels %></strong> lignes de matÃ©riel dans les vÃ©hicules
        </p>
        <div class="card-actions">
          <a href="/vehicule" class="btn btn-ghost">Voir le stock vÃ©hicules</a>
          <a href="/vehicule/ajouter-vehicule" class="btn btn-ghost">Ajouter un vÃ©hicule</a>
        </div>
      </article>
    </section>

    <!-- GRAPHIQUE -->
    <section class="card card-chart">
      <div class="card-header">
        <div class="card-title">
          ğŸ“Š EntrÃ©es / Sorties rÃ©centes
        </div>
        <div class="card-subtitle">
          BasÃ© sur lâ€™historique
        </div>
      </div>
      <canvas id="mouvementsChart"></canvas>
    </section>

    <!-- LIGNE 2 : chantiers / top rÃ©cents -->
    <section class="dashboard-grid-secondary">
      <!-- Chantiers -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">
            ğŸ—ï¸ Chantiers
          </div>
          <div class="card-subtitle">
            Vue rapide
          </div>
        </div>
        <p>
          <strong><%= chantierStats.count %></strong> chantier(s) rÃ©fÃ©rencÃ©(s)<br />
          <strong><%= chantierStats.materiels %></strong> lignes de matÃ©riel sur chantier
        </p>
        <div class="card-actions">
          <a href="/chantier" class="btn btn-ghost">Inventaire chantiers</a>
          <a href="/emplacements" class="btn btn-ghost">Emplacements chantiers</a>
        </div>
      </article>

      <!-- MatÃ©riels rÃ©cemment mouvementÃ©s -->
      <article class="card">
        <div class="card-header">
          <div class="card-title">
            ğŸ“ˆ MatÃ©riels rÃ©cemment mouvementÃ©s
          </div>
          <div class="card-subtitle">
            Derniers flux
          </div>
        </div>
        <% if (derniersMouvements && derniersMouvements.length > 0) { %>
          <ul class="muted">
            <% derniersMouvements.slice(0, 5).forEach(h => { %>
              <li>
                <%= h.createdAt.toLocaleDateString('fr-FR') %> â€“
                <strong><%= h.action %></strong>
                <% if (h.materiel && h.materiel.nom) { %>
                  â€“ <%= h.materiel.nom %>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="muted">Pas encore de mouvements enregistrÃ©s.</p>
        <% } %>
      </article>
    </section>

    <!-- DERNIERS MOUVEMENTS COMPLETS -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">
          ğŸ“œ Derniers mouvements
        </div>
        <div class="card-subtitle">
          Historique condensÃ©
        </div>
      </div>

      <% if (derniersMouvements && derniersMouvements.length > 0) { %>
        <div class="history-table-wrapper">
          <table class="table-compact">
            <thead>
              <tr>
                <th>Date</th>
                <th>Action</th>
                <th>MatÃ©riel</th>
                <th>Ancienne qtÃ©</th>
                <th>Nouvelle qtÃ©</th>
              </tr>
            </thead>
            <tbody>
              <% derniersMouvements.forEach(h => { %>
                <tr>
                  <td><%= h.createdAt.toLocaleDateString('fr-FR') %></td>
                  <td><%= h.action %></td>
                  <td>
                    <% if (h.materiel) { %>
                      <a href="/materiel/info/<%= h.materielId %>">
                        <%= h.materiel.nom %>
                      </a>
                    <% } else { %>
                      â€“
                    <% } %>
                  </td>
                  <td><%= h.oldQuantite != null ? h.oldQuantite : '-' %></td>
                  <td><%= h.newQuantite != null ? h.newQuantite : '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="card-actions" style="margin-top: .6rem;">
          <a href="/materiel/historique" class="btn btn-ghost">
            Voir tout lâ€™historique dÃ©pÃ´t
          </a>
        </div>
      <% } else { %>
        <p class="muted">Aucun mouvement rÃ©cent.</p>
      <% } %>
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      const data = <%- JSON.stringify(chartData || { labels: [], entrees: [], sorties: [] }) %>;
      const ctx = document.getElementById('mouvementsChart');
      if (!ctx || !data.labels.length) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'EntrÃ©es',
              data: data.entrees
            },
            {
              label: 'Sorties',
              data: data.sorties
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { maxRotation: 55, minRotation: 25 }
            },
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              labels: { boxWidth: 12, boxHeight: 12 }
            }
          }
        }
      });
    })();
  </script>
</body>
</html>
