<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äì Gestion de stock</title>

  <!-- Ton CSS global habituel -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    :root {
      --bg-body: #020617;
      --bg-main: #f3f4f8;
      --accent: #6366f1;
      --accent-soft: #e0e7ff;
      --accent-strong: #4f46e5;
      --danger: #f97373;
      --success: #22c55e;
    }

    /* ‚Äî‚Äî‚Äî Layout global dashboard ‚Äî‚Äî‚Äî */
    .dashboard-page {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #020617 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
    }

    .dashboard-shell {
      max-width: 1240px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 2.5rem;
    }

    .dashboard-inner {
      background: var(--bg-main);
      border-radius: 1.25rem;
      padding: 1.4rem 1.4rem 1.8rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, .55);
    }

    /* ‚Äî‚Äî‚Äî Header ‚Äî‚Äî‚Äî */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
    }

    .dashboard-title-block h1 {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: .03em;
      margin: 0 0 .35rem;
      color: #0f172a;
    }

    .dashboard-title-block p {
      margin: 0;
      color: #6b7280;
      font-size: .9rem;
    }

    .dashboard-user {
      font-size: .85rem;
      color: #9ca3af;
    }

    /* ‚Äî‚Äî‚Äî Barre d‚Äôactions ‚Äî‚Äî‚Äî */
    .dashboard-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: 1.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .4rem .9rem;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 500;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all .15s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      box-shadow: 0 10px 25px rgba(79, 70, 229, .35);
      border-color: rgba(79, 70, 229, 0.9);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(79, 70, 229, .45);
    }

    .btn-ghost {
      background: #fff;
      color: var(--accent-strong);
      border-color: #d1d5db;
    }
    .btn-ghost:hover {
      background: var(--accent-soft);
      border-color: var(--accent-strong);
    }

    /* ‚Äî‚Äî‚Äî Grille de cartes ‚Äî‚Äî‚Äî */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1rem 1.1rem 1.15rem;
      box-shadow: 0 10px 28px rgba(15, 23, 42, .08);
      border: 1px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(99, 102, 241, .08), transparent);
      opacity: .7;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: .65rem;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: .95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      color: #111827;
    }

    .card-subtitle {
      font-size: .75rem;
      color: #9ca3af;
    }

    .card-content {
      position: relative;
      z-index: 1;
    }

    /* ‚Äî‚Äî‚Äî Badges / pills ‚Äî‚Äî‚Äî */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      font-size: .72rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      font-weight: 500;
    }

    .pill-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .pill-ok {
      background: #dcfce7;
      color: #15803d;
    }

    /* ‚Äî‚Äî‚Äî Tableaux compacts ‚Äî‚Äî‚Äî */
    .table-compact {
      width: 100%;
      border-collapse: collapse;
      font-size: .8rem;
    }
    .table-compact th,
    .table-compact td {
      border-bottom: 1px solid #f1f2f6;
      padding: .3rem .2rem;
      text-align: left;
      background: transparent;
    }
    .table-compact th {
      font-weight: 600;
      color: #6b7280;
      background: #f9fafb;
    }
    .table-compact a {
      color: var(--accent-strong);
      text-decoration: none;
    }
    .table-compact a:hover {
      text-decoration: underline;
    }

    .muted {
      color: #6b7280;
      font-size: .8rem;
    }

    /* ‚Äî‚Äî‚Äî Section graphique ‚Äî‚Äî‚Äî */
    .card-chart {
      margin-bottom: 1.25rem;
    }

    .card-chart .chart-wrapper {
      position: relative;
      height: 260px;   /* fixe la hauteur du graphique */
      margin-top: .25rem;
    }

    .card-chart canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    /* ‚Äî‚Äî‚Äî Grille secondaire ‚Äî‚Äî‚Äî */
    .dashboard-grid-secondary {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 900px) {
      .dashboard-grid-secondary {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* ‚Äî‚Äî‚Äî Derniers mouvements ‚Äî‚Äî‚Äî */
    .history-table-wrapper {
      margin-top: .5rem;
      overflow-x: auto;
    }

    /* ‚Äî‚Äî‚Äî Liens boutons dans cartes ‚Äî‚Äî‚Äî */
    .card-actions {
      margin-top: .7rem;
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
    }
  </style>
</head>
<body class="dashboard-page">
  <div class="dashboard-shell">
    <div class="dashboard-inner">
      <!-- HEADER -->
      <header class="dashboard-header">
        <div class="dashboard-title-block">
          <h1>Dashboard stock & chantiers</h1>
          <p>Vue synth√©tique de l‚Äôactivit√© du d√©p√¥t, des v√©hicules et des chantiers.</p>
        </div>
        <div class="dashboard-user">
          Bonjour <strong><%= user && user.nom ? user.nom : 'utilisateur' %></strong>
        </div>
      </header>

      <!-- ACTIONS -->
      <div class="dashboard-actions">
        <a href="/scan" class="btn btn-primary">
          üì∑ <span>Scan QR / code-barres</span>
        </a>
        <a href="/bonLivraison/ajouter" class="btn btn-ghost">
          ‚ûï <span>Bon de livraison</span>
        </a>
        <a href="/transferts/entree" class="btn btn-ghost">
          üîÅ <span>Transfert (entr√©e)</span>
        </a>
        <a href="/transferts/sortie" class="btn btn-ghost">
          üîÅ <span>Transfert (sortie)</span>
        </a>
      </div>

      <!-- LIGNE 1 : alertes / d√©p√¥t / v√©hicules -->
      <section class="dashboard-grid">
        <!-- Alertes -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              <span>üîî Alertes</span>
            </div>
            <div class="card-subtitle">
              Stock critique & anomalies
            </div>
          </div>
          <div class="card-content">
            <% if (lowStock && lowStock.length > 0) { %>
              <p>
                <span class="pill pill-danger">
                  <strong><%= lowStock.length %></strong> mat√©riel(s) &lt; <%= lowStockThreshold %>
                </span>
              </p>
              <table class="table-compact">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Qt√©</th>
                  </tr>
                </thead>
                <tbody>
                  <% lowStock.forEach(m => { %>
                    <tr>
                      <td>
                        <a href="/materiel/info/<%= m.id %>">
                          <%= m.nom %>
                        </a>
                      </td>
                      <td><%= m.quantite %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            <% } else { %>
              <p class="muted">
                <span class="pill pill-ok">Aucune alerte de stock critique</span>
              </p>
            <% } %>
          </div>
        </article>

        <!-- Stock d√©p√¥t -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              üì¶ Stock d√©p√¥t
            </div>
            <div class="card-subtitle">
              Vue globale
            </div>
          </div>
          <div class="card-content">
            <p>
              <strong><%= depotStats.count %></strong> lignes de mat√©riel en d√©p√¥t<br />
              Valeur estim√©e :
              <strong><%= depotStats.value.toFixed(2) %> ‚Ç¨</strong>
            </p>
            <div class="card-actions">
              <a href="/materiel" class="btn btn-ghost">Voir le d√©p√¥t</a>
              <a href="/materiel/export/excel" class="btn btn-ghost">Export Excel</a>
              <a href="/materiel/export/pdf" class="btn btn-ghost">Export PDF</a>
            </div>
          </div>
        </article>

        <!-- V√©hicules -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              üöö V√©hicules
            </div>
            <div class="card-subtitle">
              Stock embarqu√©
            </div>
          </div>
          <div class="card-content">
            <p>
              <strong><%= vehiculeStats.count %></strong> v√©hicule(s) suivis<br />
              <strong><%= vehiculeStats.materiels %></strong> lignes de mat√©riel dans les v√©hicules
            </p>
            <div class="card-actions">
              <a href="/vehicule" class="btn btn-ghost">Voir le stock v√©hicules</a>
              <a href="/vehicule/ajouter-vehicule" class="btn btn-ghost">Ajouter un v√©hicule</a>
            </div>
          </div>
        </article>
      </section>

      <!-- GRAPHIQUE -->
      <section class="card card-chart">
        <div class="card-header">
          <div class="card-title">
            üìä Entr√©es / Sorties r√©centes
          </div>
          <div class="card-subtitle">
            Bas√© sur l‚Äôhistorique
          </div>
        </div>
        <div class="card-content">
          <div class="chart-wrapper">
            <canvas id="mouvementsChart"></canvas>
          </div>
        </div>
      </section>

      <!-- LIGNE 2 : chantiers / top r√©cents -->
      <section class="dashboard-grid-secondary">
        <!-- Chantiers -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              üèóÔ∏è Chantiers
            </div>
            <div class="card-subtitle">
              Vue rapide
            </div>
          </div>
          <div class="card-content">
            <p>
              <strong><%= chantierStats.count %></strong> chantier(s) r√©f√©renc√©(s)<br />
              <strong><%= chantierStats.materiels %></strong> lignes de mat√©riel sur chantier
            </p>
            <div class="card-actions">
              <a href="/chantier" class="btn btn-ghost">Inventaire chantiers</a>
              <a href="/emplacements" class="btn btn-ghost">Emplacements chantiers</a>
            </div>
          </div>
        </article>

        <!-- Mat√©riels r√©cemment mouvement√©s -->
        <article class="card">
          <div class="card-header">
            <div class="card-title">
              üìà Mat√©riels r√©cemment mouvement√©s
            </div>
            <div class="card-subtitle">
              Derniers flux
            </div>
          </div>
          <div class="card-content">
            <% if (derniersMouvements && derniersMouvements.length > 0) { %>
              <ul class="muted">
                <% derniersMouvements.slice(0, 5).forEach(h => { %>
                  <li>
                    <%= h.createdAt.toLocaleDateString('fr-FR') %> ‚Äì
                    <strong><%= h.action %></strong>
                    <% if (h.materiel && h.materiel.nom) { %>
                      ‚Äì <%= h.materiel.nom %>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <p class="muted">Pas encore de mouvements enregistr√©s.</p>
            <% } %>
          </div>
        </article>
      </section>

      <!-- DERNIERS MOUVEMENTS COMPLETS -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            üìú Derniers mouvements
          </div>
          <div class="card-subtitle">
            Historique condens√©
          </div>
        </div>
        <div class="card-content">
          <% if (derniersMouvements && derniersMouvements.length > 0) { %>
            <div class="history-table-wrapper">
              <table class="table-compact">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Action</th>
                    <th>Mat√©riel</th>
                    <th>Ancienne qt√©</th>
                    <th>Nouvelle qt√©</th>
                  </tr>
                </thead>
                <tbody>
                  <% derniersMouvements.forEach(h => { %>
                    <tr>
                      <td><%= h.createdAt.toLocaleDateString('fr-FR') %></td>
                      <td><%= h.action %></td>
                      <td>
                        <% if (h.materiel) { %>
                          <a href="/materiel/info/<%= h.materielId %>">
                            <%= h.materiel.nom %>
                          </a>
                        <% } else { %>
                          ‚Äì
                        <% } %>
                      </td>
                      <td><%= h.oldQuantite != null ? h.oldQuantite : '-' %></td>
                      <td><%= h.newQuantite != null ? h.newQuantite : '-' %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <div class="card-actions" style="margin-top: .6rem;">
              <a href="/materiel/historique" class="btn btn-ghost">
                Voir tout l‚Äôhistorique d√©p√¥t
              </a>
            </div>
          <% } else { %>
            <p class="muted">Aucun mouvement r√©cent.</p>
          <% } %>
        </div>
      </section>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      const data = <%- JSON.stringify(chartData || { labels: [], entrees: [], sorties: [] }) %>;
      const ctx = document.getElementById('mouvementsChart');
      if (!ctx || !data.labels.length) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'Entr√©es',
              data: data.entrees
            },
            {
              label: 'Sorties',
              data: data.sorties
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { maxRotation: 55, minRotation: 25 }
            },
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              labels: { boxWidth: 12, boxHeight: 12 }
            }
          }
        }
      });
    })();
  </script>
</body>
</html>
