<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äì Gestion de stock</title>

  <!-- Si tu utilises d√©j√† un CSS global, garde ton include habituel -->
  <link rel="stylesheet" href="/css/style.css" />

  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .card h2, .card h3 {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
    .muted {
      color: #777;
      font-size: 0.9rem;
    }
    .pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eee;
    }
    .pill-danger {
      background: #ffdddd;
      color: #b30000;
    }
    .pill-ok {
      background: #ddffdd;
      color: #006600;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .btn {
      display: inline-block;
      padding: 0.35rem 0.7rem;
      border-radius: 4px;
      font-size: 0.85rem;
      text-decoration: none;
      border: 1px solid #007bff;
      color: #007bff;
      background: #fff;
    }
    .btn-primary {
      background: #007bff;
      color: #fff;
    }
    .btn-outline {
      background: #fff;
      color: #007bff;
    }
    .table-compact {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .table-compact th,
    .table-compact td {
      border-bottom: 1px solid #eee;
      padding: 0.35rem 0.4rem;
      text-align: left;
    }
    .table-compact th {
      font-weight: 600;
      background: #fafafa;
    }
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .section-title small {
      font-size: 0.8rem;
      color: #777;
    }
    canvas {
      max-width: 100%;
      height: 260px;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <header style="margin-bottom: 1.5rem;">
      <div class="section-title">
        <h1>Dashboard stock & chantiers</h1>
        <div class="muted">
          Bonjour <%= user && user.nom ? user.nom : 'utilisateur' %>
        </div>
      </div>

      <div class="btn-row">
        <a href="/scan" class="btn btn-primary">üì∑ Scan QR / code-barres</a>
        <a href="/bonLivraison/ajouter" class="btn btn-outline">‚ûï Bon de livraison</a>
        <a href="/transferts/entree" class="btn btn-outline">üîÅ Transfert (entr√©e)</a>
        <a href="/transferts/sortie" class="btn btn-outline">üîÅ Transfert (sortie)</a>
      </div>
    </header>

    <!-- Ligne 1 : Alertes / D√©p√¥t / V√©hicules -->
    <section class="dashboard-grid" style="margin-bottom: 1rem;">
      <!-- Alertes -->
      <div class="card">
        <div class="section-title">
          <h2>üîî Alertes</h2>
          <small>Stock critique & anomalies</small>
        </div>

        <% if (lowStock && lowStock.length > 0) { %>
          <p>
            <span class="pill pill-danger">
              <%= lowStock.length %> mat√©riel(s) en dessous de <%= lowStockThreshold %>
            </span>
          </p>
          <table class="table-compact">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Quantit√©</th>
              </tr>
            </thead>
            <tbody>
              <% lowStock.forEach(m => { %>
                <tr>
                  <td>
                    <a href="/materiel/info/<%= m.id %>">
                      <%= m.nom %>
                    </a>
                  </td>
                  <td><%= m.quantite %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else { %>
          <p><span class="pill pill-ok">Aucune alerte de stock critique</span></p>
        <% } %>
      </div>

      <!-- Stock d√©p√¥t -->
      <div class="card">
        <div class="section-title">
          <h2>üì¶ Stock d√©p√¥t</h2>
          <small>Vue globale</small>
        </div>
        <p>
          <strong><%= depotStats.count %></strong> lignes de mat√©riel en d√©p√¥t<br />
          Valeur estim√©e : <strong><%= depotStats.value.toFixed(2) %> ‚Ç¨</strong>
        </p>
        <div class="btn-row">
          <a href="/materiel" class="btn btn-outline">Voir le d√©p√¥t</a>
          <a href="/materiel/export/excel" class="btn btn-outline">Export Excel</a>
          <a href="/materiel/export/pdf" class="btn btn-outline">Export PDF</a>
        </div>
      </div>

      <!-- V√©hicules -->
      <div class="card">
        <div class="section-title">
          <h2>üöö V√©hicules</h2>
          <small>Stock embarqu√©</small>
        </div>
        <p>
          <strong><%= vehiculeStats.count %></strong> v√©hicule(s)<br />
          <strong><%= vehiculeStats.materiels %></strong> lignes de mat√©riel dans les v√©hicules
        </p>
        <div class="btn-row">
          <a href="/vehicule" class="btn btn-outline">Voir le stock v√©hicules</a>
          <a href="/vehicule/ajouter-vehicule" class="btn btn-outline">Ajouter un v√©hicule</a>
        </div>
      </div>
    </section>

    <!-- Graphique -->
    <section class="card" style="margin-bottom: 1rem;">
      <div class="section-title">
        <h2>üìä Entr√©es / Sorties r√©centes</h2>
        <small>Bas√© sur l‚Äôhistorique</small>
      </div>
      <canvas id="mouvementsChart"></canvas>
    </section>

    <!-- Ligne 2 : Chantiers & mat√©riels les plus utilis√©s (simple) -->
    <section class="dashboard-grid" style="margin-bottom: 1rem;">
      <!-- Chantiers -->
      <div class="card">
        <div class="section-title">
          <h2>üèóÔ∏è Chantiers</h2>
          <small>Vue rapide</small>
        </div>
        <p>
          <strong><%= chantierStats.count %></strong> chantier(s) r√©f√©renc√©(s)<br />
          <strong><%= chantierStats.materiels %></strong> lignes de mat√©riel sur chantier
        </p>
        <div class="btn-row">
          <a href="/chantier" class="btn btn-outline">Inventaire chantiers</a>
          <a href="/emplacements" class="btn btn-outline">Emplacements chantiers</a>
        </div>
      </div>

      <!-- Placeholder "Top mat√©riels" (simple liste depuis l‚Äôhistorique) -->
      <div class="card">
        <div class="section-title">
          <h2>üìà Mat√©riels r√©cemment mouvement√©s</h2>
          <small>Top r√©cent (simple)</small>
        </div>
        <% if (derniersMouvements && derniersMouvements.length > 0) { %>
          <ul class="muted">
            <% derniersMouvements.slice(0, 5).forEach(h => { %>
              <li>
                <%= h.createdAt.toLocaleDateString('fr-FR') %> ‚Äì
                <strong><%= h.action %></strong>
                <% if (h.materiel && h.materiel.nom) { %>
                  ‚Äì <%= h.materiel.nom %>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="muted">Pas encore de mouvements enregistr√©s.</p>
        <% } %>
      </div>
    </section>

    <!-- Derniers mouvements -->
    <section class="card">
      <div class="section-title">
        <h2>üìú Derniers mouvements</h2>
        <small>Historique condens√©</small>
      </div>

      <% if (derniersMouvements && derniersMouvements.length > 0) { %>
        <table class="table-compact">
          <thead>
            <tr>
              <th>Date</th>
              <th>Action</th>
              <th>Mat√©riel</th>
              <th>Ancienne qt√©</th>
              <th>Nouvelle qt√©</th>
            </tr>
          </thead>
          <tbody>
            <% derniersMouvements.forEach(h => { %>
              <tr>
                <td><%= h.createdAt.toLocaleDateString('fr-FR') %></td>
                <td><%= h.action %></td>
                <td>
                  <% if (h.materiel) { %>
                    <a href="/materiel/info/<%= h.materielId %>">
                      <%= h.materiel.nom %>
                    </a>
                  <% } else { %>
                    ‚Äì
                  <% } %>
                </td>
                <td><%= h.oldQuantite != null ? h.oldQuantite : '-' %></td>
                <td><%= h.newQuantite != null ? h.newQuantite : '-' %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <div class="btn-row" style="margin-top: 0.5rem;">
          <a href="/materiel/historique" class="btn btn-outline">Voir tout l‚Äôhistorique d√©p√¥t</a>
        </div>
      <% } else { %>
        <p class="muted">Aucun mouvement r√©cent.</p>
      <% } %>
    </section>
  </div>

  <!-- Chart.js depuis jsDelivr (autoris√© par ton CSP actuel) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      const data = <%- JSON.stringify(chartData || { labels: [], entrees: [], sorties: [] }) %>;

      const ctx = document.getElementById('mouvementsChart');
      if (!ctx || !data.labels.length) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              label: 'Entr√©es',
              data: data.entrees
            },
            {
              label: 'Sorties',
              data: data.sorties
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              ticks: { maxRotation: 60, minRotation: 30 }
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });
    })();
  </script>
</body>
</html>
